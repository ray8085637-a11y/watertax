import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { Upload, Calendar, AlertCircle, CheckCircle, Clock, Plus, X, Trash2, BarChart3, TrendingUp, PieChart, DollarSign, Menu, ChevronLeft, ChevronRight, Zap, PanelLeft, Bell, MapPin, FileText, User, Lock, RefreshCw, Wifi, WifiOff } from 'lucide-react';

const ExcelExportUtils = {
  formatBillsForExcel: (bills, stations) => {
    return bills.map(bill => {
      const station = stations.find(s => s.name === bill.stationName);
      const daysLeft = utils.getDaysUntilDue(bill.dueDate);
      
      return {
        '세금 분류': bill.category || '',
        '세금 제목': bill.name || '',
        '충전소명': bill.stationName || '',
        '충전소 주소': bill.address || '',
        '납부 금액': bill.amount === '미정' || !bill.amount ? '미정' : bill.amount,
        '납부 기한': bill.dueDate || '',
        '상태': bill.status === 'completed' ? '납부 완료' : 
               bill.status === 'accounting_review' ? '회계사 검토' : '납부 예정',
        '지연 여부': daysLeft < 0 && bill.status === 'pending' ? '지연' : '정상',
        '지연 일수': daysLeft < 0 && bill.status === 'pending' ? Math.abs(daysLeft) : '',
        '완료일': bill.completedDate || '',
        '등록일': bill.uploadedAt || '',
        '반복 납부': bill.isRecurring ? '예' : '아니오',
        '사용 승인일': station?.approvalDate || '',
        '안전 점검일': station?.safetyCheckDate || '',
        '충전소 상태': station?.status === 'operating' ? '운영 중' : 
                     station?.status === 'preparing' ? '오픈 예정' : '운영 종료'
      };
    });
  },

  formatStationsForExcel: (stations, bills) => {
    return stations.map(station => {
      const stationBills = bills.filter(bill => bill.stationName === station.name);
      const totalAmount = stationBills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
      const completedAmount = stationBills.filter(bill => bill.status === 'completed').reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
      const pendingAmount = stationBills.filter(bill => bill.status === 'pending' || bill.status === 'accounting_review').reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
      
      return {
        '충전소명': station.name || '',
        '주소': station.address || '',
        '상태': station.status === 'operating' ? '운영 중' : 
               station.status === 'preparing' ? '오픈 예정' : '운영 종료',
        '사용 승인일': station.approvalDate || '',
        '안전 점검일': station.safetyCheckDate || '',
        '등록일': station.registeredDate || '',
        '세금 건수': stationBills.length,
        '완료 건수': stationBills.filter(bill => bill.status === 'completed').length,
        '예정 건수': stationBills.filter(bill => bill.status === 'pending' || bill.status === 'accounting_review').length,
        '총 세금액': utils.formatKoreanCurrency(totalAmount),
        '완료 금액': utils.formatKoreanCurrency(completedAmount),
        '예정 금액': utils.formatKoreanCurrency(pendingAmount),
        '완료율': stationBills.length > 0 ? Math.round((stationBills.filter(bill => bill.status === 'completed').length / stationBills.length) * 100) + '%' : '0%'
      };
    });
  },

  convertToCSV: (data) => {
    if (!data || data.length === 0) {
      throw new Error('다운로드할 데이터가 없습니다.');
    }

    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => 
        headers.map(header => {
          const value = row[header] || '';
          if (String(value).includes(',') || String(value).includes('"') || String(value).includes('\n')) {
            return `"${String(value).replace(/"/g, '""')}"`;
          }
          return String(value);
        }).join(',')
      )
    ].join('\n');

    return csvContent;
  },

  downloadCSVInstant: (data, filename) => {
    try {
      if (!data || data.length === 0) {
        throw new Error('다운로드할 데이터가 없습니다.');
      }

      const csvContent = ExcelExportUtils.convertToCSV(data);
      const BOM = '\uFEFF';
      const finalContent = BOM + csvContent;
      
      if (finalContent.length < 32768) {
        const dataURI = 'data:text/csv;charset=utf-8,' + encodeURIComponent(finalContent);
        const link = document.createElement('a');
        link.href = dataURI;
        link.download = filename;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('Data URI 다운로드 완료:', filename);
        return true;
      }
      
      const blob = new Blob([finalContent], { 
        type: 'text/csv;charset=utf-8'
      });
      
      if (window.showSaveFilePicker) {
        window.showSaveFilePicker({
          suggestedName: filename,
          types: [{
            description: 'CSV files',
            accept: { 'text/csv': ['.csv'] }
          }]
        }).then(fileHandle => {
          return fileHandle.createWritable();
        }).then(writable => {
          writable.write(blob);
          return writable.close();
        }).then(() => {
          console.log('File System Access API 다운로드 완료:', filename);
        }).catch(err => {
          console.log('File System Access API 실패, fallback 사용');
          this.fallbackDownload(blob, filename);
        });
        return true;
      }
      
      if (window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveOrOpenBlob(blob, filename);
        console.log('IE/Edge 다운로드 완료:', filename);
        return true;
      }
      
      return this.fallbackDownload(blob, filename);
      
    } catch (error) {
      console.error('CSV download failed:', error);
      throw error;
    }
  },

  fallbackDownload: (blob, filename) => {
    try {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      
      link.href = url;
      link.download = filename;
      link.style.display = 'none';
      
      document.body.appendChild(link);
      
      link.dispatchEvent(new MouseEvent('click', {
        bubbles: false,
        cancelable: true,
        view: window
      }));
      
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 100);
      
      console.log('Fallback 다운로드 완료:', filename);
      return true;
      
    } catch (error) {
      console.error('Fallback download failed:', error);
      return false;
    }
  },

  downloadExcel: (data, filename, sheetName = 'Sheet1') => {
    const csvFilename = filename.replace(/\.xlsx?$/i, '.csv');
    return ExcelExportUtils.downloadCSVInstant(data, csvFilename);
  }
};
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { 
      hasError: false, 
      error: null, 
      errorInfo: null,
      retryCount: 0 
    };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    this.setState({
      error,
      errorInfo,
      hasError: true
    });
    
    // 에러 로깅 (실제 환경에서는 외부 서비스로 전송)
    console.error('Error Boundary caught an error:', error, errorInfo);
    
    // 에러 정보를 localStorage에 저장 (디버깅용)
    try {
      const errorLog = {
        timestamp: new Date().toISOString(),
        error: error.toString(),
        stack: error.stack,
        componentStack: errorInfo.componentStack,
        retryCount: this.state.retryCount
      };
      
      const existingLogs = JSON.parse(localStorage.getItem('error_logs') || '[]');
      existingLogs.push(errorLog);
      
      // 최대 10개의 에러 로그만 유지
      if (existingLogs.length > 10) {
        existingLogs.shift();
      }
      
      localStorage.setItem('error_logs', JSON.stringify(existingLogs));
    } catch (storageError) {
      console.warn('Failed to store error log:', storageError);
    }
  }

  handleRetry = () => {
    this.setState(prevState => ({
      hasError: false,
      error: null,
      errorInfo: null,
      retryCount: prevState.retryCount + 1
    }));
  };

  handleReload = () => {
    window.location.reload();
  };

  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-gray-900 to-slate-800 flex items-center justify-center p-4">
          <div className="max-w-md w-full bg-gradient-to-br from-slate-800/50 to-slate-700/30 backdrop-blur-md rounded-2xl p-8 border border-slate-600/30 shadow-2xl">
            <div className="text-center">
              <div className="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <AlertCircle className="w-8 h-8 text-red-400" />
              </div>
              
              <h2 className="text-xl font-semibold text-gray-100 mb-2">오류가 발생했습니다</h2>
              <p className="text-gray-400 text-sm mb-6">
                시스템에 예상치 못한 오류가 발생했습니다. 잠시 후 다시 시도해주세요.
              </p>
              
              {/* 개발 모드에서만 에러 상세 정보 표시 */}
              {process.env.NODE_ENV === 'development' && this.state.error && (
                <details className="mb-6 text-left">
                  <summary className="text-xs text-gray-500 cursor-pointer hover:text-gray-300 mb-2">
                    에러 상세 정보 (개발 모드)
                  </summary>
                  <div className="bg-slate-900/50 rounded-lg p-3 text-xs text-red-300 font-mono overflow-auto max-h-32">
                    <div className="mb-2">
                      <strong>Error:</strong> {this.state.error.toString()}
                    </div>
                    {this.state.error.stack && (
                      <div>
                        <strong>Stack:</strong>
                        <pre className="whitespace-pre-wrap text-xs">
                          {this.state.error.stack}
                        </pre>
                      </div>
                    )}
                  </div>
                </details>
              )}
              
              <div className="space-y-3">
                <button
                  onClick={this.handleRetry}
                  className="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl hover:from-blue-500 hover:to-blue-400 transition-all duration-200 font-medium shadow-lg flex items-center justify-center"
                >
                  <RefreshCw className="w-4 h-4 mr-2" />
                  다시 시도 {this.state.retryCount > 0 && `(${this.state.retryCount + 1}번째)`}
                </button>
                
                <button
                  onClick={this.handleReload}
                  className="w-full px-4 py-2 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-colors font-medium"
                >
                  페이지 새로고침
                </button>
              </div>
              
              <div className="mt-6 text-xs text-gray-500">
                <p>문제가 지속되면 관리자에게 문의하세요.</p>
                <p className="mt-1">에러 시간: {new Date().toLocaleString('ko-KR')}</p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

// 네트워크 상태 훅
const useNetworkStatus = () => {
  const [isOnline, setIsOnline] = useState(navigator.onLine);

  useEffect(() => {
    const handleOnline = () => setIsOnline(true);
    const handleOffline = () => setIsOnline(false);

    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);

    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
    };
  }, []);

  return isOnline;
};

// 비동기 작업 래퍼 (에러 처리 포함)
const asyncWrapper = async (asyncFn, errorMessage = '작업 중 오류가 발생했습니다') => {
  try {
    return await asyncFn();
  } catch (error) {
    console.error('Async operation failed:', error);
    throw new Error(`${errorMessage}: ${error.message}`);
  }
};

// 안전한 JSON 파싱
const safeJsonParse = (jsonString, defaultValue = null) => {
  try {
    return JSON.parse(jsonString);
  } catch (error) {
    console.warn('JSON parsing failed:', error);
    return defaultValue;
  }
};

// 로딩 스피너 컴포넌트
const LoadingSpinner = ({ size = 'md', message = '로딩 중...' }) => {
  const sizeClasses = {
    sm: 'w-4 h-4',
    md: 'w-6 h-6',
    lg: 'w-8 h-8',
    xl: 'w-12 h-12'
  };

  return (
    <div className="flex flex-col items-center justify-center py-8">
      <div className={`animate-spin rounded-full border-2 border-blue-500 border-t-transparent ${sizeClasses[size]} mb-3`}></div>
      <p className="text-gray-400 text-sm">{message}</p>
    </div>
  );
};

// 에러 토스트 컴포넌트
const ErrorToast = ({ error, onDismiss }) => {
  useEffect(() => {
    const timer = setTimeout(onDismiss, 5000);
    return () => clearTimeout(timer);
  }, [onDismiss]);

  return (
    <div className="fixed top-4 right-4 z-50 max-w-sm w-full">
      <div className="bg-red-900/90 border border-red-500/50 text-red-100 backdrop-blur-md rounded-lg p-4 shadow-lg animate-slide-in-right">
        <div className="flex items-start">
          <AlertCircle className="w-5 h-5 text-red-400 mr-3 flex-shrink-0 mt-0.5" />
          <div className="flex-1">
            <p className="text-sm font-medium mb-1">오류 발생</p>
            <p className="text-xs text-red-200">{error}</p>
          </div>
          <button
            onClick={onDismiss}
            className="ml-3 text-red-400 hover:text-red-200 transition-colors"
          >
            <X className="w-4 h-4" />
          </button>
        </div>
      </div>
    </div>
  );
};

// 통합 패턴 정의 (중복 제거)
const TaxDocumentPatterns = {
  taxTypes: {
    '취득세': ['취득세', '부동산취득세', '취득세\\(부동산\\)', '취득세\\(.*?\\)'],
    '재산세': ['재산세', '재산세\\(토지\\)', '재산세\\(건물\\)'],
    '기타세': ['도시공원점용료', '시군구세산대부료', '공유재산사용료', '도로점용료', '지방교육세', '농어촌특별세', '등록면허세']
  },
  
  amounts: [
    /과세표준액[:\s]*([0-9,]+)/gi,
    /취득세[\\(부동산\\)]*[:\s]*([0-9,]+)/gi,
    /재산세[:\s]*([0-9,]+)/gi,
    /지방교육세[:\s]*([0-9,]+)/gi,
    /농어촌특별세[:\s]*([0-9,]+)/gi,
    /등록면허세[:\s]*([0-9,]+)/gi,
    /세액합계[:\s]*([0-9,]+)/gi,
    /합계금액[:\s]*([0-9,]+)/gi,
    /납부금액[:\s]*([0-9,]+)/gi,
    /총[:\s]*([0-9,]+)/gi,
    /([0-9]{1,3}(?:,?[0-9]{3})*)[:\s]*원/gi,
    /([0-9,]{7,})/gi
  ],
  
  dates: [
    /납부기한[:\s]*([0-9]{4})[.\-/년]([0-9]{1,2})[.\-/월]([0-9]{1,2})/gi,
    /납부기일[:\s]*([0-9]{4})[.\-/년]([0-9]{1,2})[.\-/월]([0-9]{1,2})/gi,
    /납기일[:\s]*([0-9]{4})[.\-/년]([0-9]{1,2})[.\-/월]([0-9]{1,2})/gi,
    /납기종료일[:\s]*([0-9]{4})[.\-/]([0-9]{1,2})[.\-/]([0-9]{1,2})/gi,
    /([0-9]{4})[.\-/]([0-9]{1,2})[.\-/]([0-9]{1,2})/gi
  ],
  
  addresses: [
    /과세대상[^가-힣]*([가-힣0-9\s,.\-\/]+(?:특별시|광역시|시|도)[^가-힣]*[가-힣0-9\s,.\-\/]+(?:구|군)[^가-힣]*[가-힣0-9\s,.\-\/]+)/gi,
    /소재지[^가-힣]*([가-힣0-9\s,.\-\/]+(?:특별시|광역시|시|도)[^가-힣]*[가-힣0-9\s,.\-\/]+(?:구|군)[^가-힣]*[가-힣0-9\s,.\-\/]+)/gi,
    /부과대상[^가-힣]*([가-힣0-9\s,.\-\/]+(?:특별시|광역시|시|도)[^가-힣]*[가-힣0-9\s,.\-\/]+(?:구|군)[^가-힣]*[가-힣0-9\s,.\-\/]+)/gi,
    /([가-힣]+(?:특별시|광역시|시|도)\s+[가-힣]+(?:구|군|시)\s+[가-힣0-9]+(?:로|길)\s+[0-9]+)/gi,
    /([가-힣]+(?:특별시|광역시|시|도)\s+[가-힣]+(?:구|군|시)\s+[가-힣]+동\s+[0-9\-]+)/gi
  ],
  
  taxpayers: [
    /납세자[:\s]*([가-힣\s()주식회사㈜㈝브라이트에너지파트너스]+)/gi,
    /성명[:\s]*([가-힣\s()주식회사㈜㈝브라이트에너지파트너스]+)/gi,
    /(브라이트에너지파트너스[^가-힣]*주식회사)/gi,
    /(.*?에너지.*?파트너스)/gi
  ]
};

// 공통 분석 유틸리티
const AnalysisUtils = {
  // 에러 처리 래퍼
  withErrorHandling: async (asyncFn, fallbackFn, errorMessage) => {
    try {
      return await asyncFn();
    } catch (error) {
      console.warn(errorMessage, error);
      return fallbackFn ? fallbackFn() : null;
    }
  },

  // 기본 결과 생성
  createFallbackResult: (file) => {
    const today = koreaTimeUtils.getKoreaToday();
    const futureDate = new Date();
    futureDate.setMonth(futureDate.getMonth() + 3);
    
    return {
      fileName: file.name,
      category: '재산세',
      name: '세금 고지서',
      amount: '미정',
      dueDate: koreaTimeUtils.formatKoreaDate(futureDate),
      confidence: 0.3,
      stationName: '',
      address: '서울특별시 강남구 테헤란로 123',
      method: 'fallback_analysis',
      success: true,
      isRecurring: true // 재산세는 기본적으로 반복
    };
  },

  // 텍스트 분석 (공통 로직)
  analyzeText: (text, fileName) => {
    console.log('텍스트 분석 시작...');
    
    let result = {
      fileName: fileName,
      category: '재산세',
      name: '세금 고지서',
      amount: '미정',
      dueDate: '',
      confidence: 0.4,
      stationName: '',
      address: '',
      extractedText: text,
      isRecurring: false // 기본값 설정
    };

    const cleanText = text.replace(/\s+/g, ' ').trim();
    
    // 1. 세금 종류 식별
    for (const [type, keywords] of Object.entries(TaxDocumentPatterns.taxTypes)) {
      if (keywords.some(keyword => {
        const regex = new RegExp(keyword, 'gi');
        return regex.test(cleanText);
      })) {
        result.category = type;
        result.name = `${type} 고지서`;
        result.confidence += 0.2;
        
        // 재산세나 기타세인 경우 자동으로 반복 납부 활성화
        if (type === '재산세' || type === '기타세') {
          result.isRecurring = true;
        }
        break;
      }
    }
    
    // 2. 금액 추출
    const amounts = [];
    TaxDocumentPatterns.amounts.forEach(pattern => {
      const matches = [...cleanText.matchAll(pattern)];
      matches.forEach(match => {
        const amount = match[1] ? match[1].replace(/,/g, '') : match[0].replace(/[^0-9]/g, '');
        const numAmount = parseInt(amount);
        if (numAmount && numAmount >= 1000) {
          amounts.push({
            amount: numAmount,
            formatted: numAmount.toLocaleString('ko-KR'),
            context: match[0]
          });
        }
      });
    });
    
    if (amounts.length > 0) {
      const mainAmount = amounts.sort((a, b) => b.amount - a.amount)[0];
      result.amount = mainAmount.formatted;
      result.confidence += 0.3;
    }
    
    // 3. 날짜 추출
    let foundDate = false;
    TaxDocumentPatterns.dates.forEach(pattern => {
      if (foundDate) return;
      
      const matches = [...cleanText.matchAll(pattern)];
      matches.forEach(match => {
        try {
          let year, month, day;
          if (match[0].includes('년')) {
            [, year, month, day] = match;
          } else {
            [, year, month, day] = match;
          }
          
          if (year && month && day) {
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            if (date > new Date()) {
              result.dueDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
              result.confidence += 0.2;
              foundDate = true;
            }
          }
        } catch (e) {
          console.warn('날짜 파싱 오류:', e);
        }
      });
    });
    
    // 기본 납부기한 설정
    if (!foundDate) {
      const defaultDate = new Date();
      defaultDate.setMonth(defaultDate.getMonth() + 3);
      result.dueDate = defaultDate.toISOString().split('T')[0];
    }
    
    // 4. 주소 추출
    let foundAddress = false;
    TaxDocumentPatterns.addresses.forEach(pattern => {
      if (foundAddress) return;
      
      const matches = [...cleanText.matchAll(pattern)];
      if (matches.length > 0) {
        const address = matches[0][1]?.trim();
        if (address && address.length > 5) {
          result.address = address;
          result.confidence += 0.15;
          foundAddress = true;
        }
      }
    });
    
    // 기본 주소 설정
    if (!foundAddress) {
      const defaultAddresses = [
        '서울특별시 강남구 테헤란로 123',
        '서울특별시 송파구 중대로 50',
        '경기도 성남시 분당구 판교역로 345'
      ];
      result.address = defaultAddresses[Math.floor(Math.random() * defaultAddresses.length)];
    }
    
    return result;
  }
};

// OCR 분석기 통합 시스템 (리팩토링됨)
const OCRAnalyzer = {
  // 메인 분석 함수
  analyze: async (file, progressCallback) => {
    console.log('OCR 분석 시작:', file.name);
    
    // Google Vision API 키가 있는지 확인
    if (!GoogleVisionOCR.hasValidApiKey()) {
      console.log('Google Vision API 키가 없음, 시뮬레이션 모드');
      if (progressCallback) {
        progressCallback('시뮬레이션 분석', 0.5);
      }
      const fallbackResult = AnalysisUtils.createFallbackResult(file);
      fallbackResult.method = 'simulation_mode';
      if (progressCallback) {
        progressCallback('완료', 1.0);
      }
      return fallbackResult;
    }

    // Google Vision API 키가 있으면 실제 API 호출
    try {
      console.log('Google Vision API 키 감지됨, 실제 분석 시작');
      if (progressCallback) {
        progressCallback('구글 비전 API 분석', 0.2);
      }
      
      const result = await GoogleVisionOCR.analyze(file);
      
      if (progressCallback) {
        progressCallback('완료', 1.0);
      }
      
      console.log('Google Vision API 분석 성공:', result);
      return result;
      
    } catch (error) {
      console.error('Google Vision API 분석 실패:', error);
      
      if (progressCallback) {
        progressCallback('기본 분석 처리', 0.7);
      }
      
      const fallbackResult = AnalysisUtils.createFallbackResult(file);
      fallbackResult.method = 'fallback_after_api_error';
      fallbackResult.error = `API 오류: ${error.message}`;
      
      if (progressCallback) {
        progressCallback('완료', 1.0);
      }
      
      return fallbackResult;
    }
  },
  
  // 기본 결과 생성 (공통 함수 사용)
  generateFallbackResult: AnalysisUtils.createFallbackResult
};

// 구글 비전 API 기반 한국 세금 고지서 분석 시스템
const GoogleVisionOCR = {
  // 구글 비전 API 설정
  apiConfig: {
    // 브라우저 환경에서 안전하게 API 키 가져오기 (강화된 복구)
    get apiKey() {
      // 1. window 객체에서 확인 (최우선)
      if (typeof window !== 'undefined' && window.GOOGLE_VISION_API_KEY) {
        return window.GOOGLE_VISION_API_KEY;
      }
      
      // 2. 글로벌 백업에서 확인
      if (typeof window !== 'undefined' && window._GOOGLE_API_KEY_BACKUP) {
        return window._GOOGLE_API_KEY_BACKUP;
      }
      
      // 3. localStorage에서 확인
      try {
        const storedKey = localStorage.getItem('google_vision_api_key');
        if (storedKey) {
          // window에 복원
          if (typeof window !== 'undefined') {
            window.GOOGLE_VISION_API_KEY = storedKey;
          }
          return storedKey;
        }
      } catch (e) {
        console.warn('localStorage 접근 실패:', e);
      }
      
      // 4. sessionStorage에서 확인 (추가)
      try {
        const sessionKey = sessionStorage.getItem('google_vision_api_key');
        if (sessionKey) {
          // window에 복원
          if (typeof window !== 'undefined') {
            window.GOOGLE_VISION_API_KEY = sessionKey;
          }
          return sessionKey;
        }
      } catch (e) {
        console.warn('sessionStorage 접근 실패:', e);
      }
      
      // 5. 기본값 (실제 운영에서는 설정 필요)
      return 'YOUR_API_KEY_HERE';
    },
    
    endpoint: 'https://vision.googleapis.com/v1/images:annotate',
    features: [
      { type: 'DOCUMENT_TEXT_DETECTION', maxResults: 1 },
      { type: 'TEXT_DETECTION', maxResults: 1 }
    ]
  },

  // API 키 설정 헬퍼 함수 (지속성 강화)
  setApiKey: (apiKey) => {
    try {
      console.log('API 키 설정 시도:', apiKey ? `${apiKey.substring(0, 10)}...` : '없음');
      
      // 1. window 객체에 저장 (최우선)
      if (typeof window !== 'undefined') {
        window.GOOGLE_VISION_API_KEY = apiKey;
        console.log('window 객체에 저장 완료');
      }
      
      // 2. localStorage에도 저장 (백업)
      try {
        localStorage.setItem('google_vision_api_key', apiKey);
        console.log('localStorage에 저장 완료');
      } catch (storageError) {
        console.warn('localStorage 저장 실패:', storageError);
      }
      
      // 3. 세션 저장소에도 저장 (추가 백업)
      try {
        sessionStorage.setItem('google_vision_api_key', apiKey);
        console.log('sessionStorage에 저장 완료');
      } catch (sessionError) {
        console.warn('sessionStorage 저장 실패:', sessionError);
      }
      
      // 4. 글로벌 변수로도 저장
      if (typeof window !== 'undefined') {
        window._GOOGLE_API_KEY_BACKUP = apiKey;
      }
      
      // 즉시 확인
      const saved = localStorage.getItem('google_vision_api_key');
      console.log('저장 확인:', saved ? `${saved.substring(0, 10)}...` : '저장 실패');
      
      console.log('구글 비전 API 키가 설정되었습니다.');
    } catch (error) {
      console.error('API 키 설정 실패:', error);
    }
  },

  // API 키 확인 함수
  hasValidApiKey: () => {
    const apiKey = GoogleVisionOCR.apiConfig.apiKey;
    console.log('현재 API 키 체크:', apiKey ? `${apiKey.substring(0, 10)}...` : '없음');
    const isValid = apiKey && apiKey !== 'YOUR_API_KEY_HERE' && apiKey.length > 10;
    console.log('API 키 유효성:', isValid);
    return isValid;
  },

  // 실제 한국 세금 고지서 패턴 데이터베이스
  patterns: {
    // 세금 종류 패턴
    taxTypes: {
      '취득세': ['취득세', '부동산취득세', '취득세\\(부동산\\)', '취득세\\(.*?\\)'],
      '재산세': ['재산세', '재산세\\(토지\\)', '재산세\\(건물\\)'],
      '기타세': ['도시공원점용료', '시군구세산대부료', '공유재산사용료', '도로점용료', '지방교육세', '농어촌특별세', '등록면허세']
    },
    
    // 금액 패턴
    amounts: [
      /과세표준액[:\s]*([0-9,]+)/gi,
      /취득세[\\(부동산\\)]*[:\s]*([0-9,]+)/gi,
      /재산세[:\s]*([0-9,]+)/gi,
      /지방교육세[:\s]*([0-9,]+)/gi,
      /농어촌특별세[:\s]*([0-9,]+)/gi,
      /등록면허세[:\s]*([0-9,]+)/gi,
      /세액합계[:\s]*([0-9,]+)/gi,
      /합계금액[:\s]*([0-9,]+)/gi,
      /납부금액[:\s]*([0-9,]+)/gi,
      /총[:\s]*([0-9,]+)/gi,
      /([0-9]{1,3}(?:,?[0-9]{3})*)[:\s]*원/gi,
      /([0-9,]{7,})/gi
    ],
    
    // 날짜 패턴
    dates: [
      /납부기한[:\s]*([0-9]{4})[.\-/년]([0-9]{1,2})[.\-/월]([0-9]{1,2})/gi,
      /납부기일[:\s]*([0-9]{4})[.\-/년]([0-9]{1,2})[.\-/월]([0-9]{1,2})/gi,
      /납기일[:\s]*([0-9]{4})[.\-/년]([0-9]{1,2})[.\-/월]([0-9]{1,2})/gi,
      /납기종료일[:\s]*([0-9]{4})[.\-/]([0-9]{1,2})[.\-/]([0-9]{1,2})/gi,
      /([0-9]{4})[.\-/]([0-9]{1,2})[.\-/]([0-9]{1,2})/gi
    ],
    
    // 주소 패턴
    addresses: [
      /과세대상[^가-힣]*([가-힣0-9\s,.\-\/]+(?:특별시|광역시|시|도)[^가-힣]*[가-힣0-9\s,.\-\/]+(?:구|군)[^가-힣]*[가-힣0-9\s,.\-\/]+)/gi,
      /소재지[^가-힣]*([가-힣0-9\s,.\-\/]+(?:특별시|광역시|시|도)[^가-힣]*[가-힣0-9\s,.\-\/]+(?:구|군)[^가-힣]*[가-힣0-9\s,.\-\/]+)/gi,
      /부과대상[^가-힣]*([가-힣0-9\s,.\-\/]+(?:특별시|광역시|시|도)[^가-힣]*[가-힣0-9\s,.\-\/]+(?:구|군)[^가-힣]*[가-힣0-9\s,.\-\/]+)/gi,
      /([가-힣]+(?:특별시|광역시|시|도)\s+[가-힣]+(?:구|군|시)\s+[가-힣0-9]+(?:로|길)\s+[0-9]+)/gi,
      /([가-힣]+(?:특별시|광역시|시|도)\s+[가-힣]+(?:구|군|시)\s+[가-힣]+동\s+[0-9\-]+)/gi
    ],
    
    // 납세자 패턴
    taxpayers: [
      /납세자[:\s]*([가-힣\s()주식회사㈜㈝브라이트에너지파트너스]+)/gi,
      /성명[:\s]*([가-힣\s()주식회사㈜㈝브라이트에너지파트너스]+)/gi,
      /(브라이트에너지파트너스[^가-힣]*주식회사)/gi,
      /(.*?에너지.*?파트너스)/gi
    ]
  },

  // 파일을 Base64로 변환
  fileToBase64: (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  },

  // 구글 비전 API 호출
  callGoogleVisionAPI: async (base64Image) => {
    // API 키 유효성 검사
    if (!GoogleVisionOCR.hasValidApiKey()) {
      throw new Error('구글 비전 API 키가 설정되지 않았습니다. GoogleVisionOCR.setApiKey() 함수를 사용하여 설정해주세요.');
    }

    const requestBody = {
      requests: [
        {
          image: {
            content: base64Image
          },
          features: GoogleVisionOCR.apiConfig.features,
          imageContext: {
            languageHints: ['ko', 'en'] // 한국어와 영어 인식
          }
        }
      ]
    };

    try {
      const response = await fetch(`${GoogleVisionOCR.apiConfig.endpoint}?key=${GoogleVisionOCR.apiConfig.apiKey}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`구글 비전 API 오류: ${response.status} ${response.statusText} - ${errorText}`);
      }

      const data = await response.json();
      
      if (data.responses?.[0]?.error) {
        throw new Error(`API 응답 오류: ${data.responses[0].error.message}`);
      }

      return data.responses[0];
    } catch (error) {
      console.error('구글 비전 API 호출 실패:', error);
      throw error;
    }
  },

  // OCR 텍스트 추출 (구글 비전 API)
  extractText: async (file) => {
    try {
      console.log('구글 비전 API OCR 시작...');
      
      // 1. 파일을 Base64로 변환
      const base64Image = await GoogleVisionOCR.fileToBase64(file);
      
      // 2. 구글 비전 API 호출
      const response = await GoogleVisionOCR.callGoogleVisionAPI(base64Image);
      
      // 3. 텍스트 추출
      let extractedText = '';
      let confidence = 0;
      
      // DOCUMENT_TEXT_DETECTION 결과 우선 사용
      if (response.fullTextAnnotation?.text) {
        extractedText = response.fullTextAnnotation.text;
        // 페이지별 신뢰도 계산
        const pages = response.fullTextAnnotation.pages || [];
        if (pages.length > 0) {
          confidence = pages[0].confidence || 0.8;
        }
      }
      // TEXT_DETECTION 결과를 대안으로 사용
      else if (response.textAnnotations?.length > 0) {
        extractedText = response.textAnnotations[0].description || '';
        confidence = response.textAnnotations[0].confidence || 0.7;
      }
      
      if (!extractedText || extractedText.trim().length < 10) {
        throw new Error('구글 비전 API에서 텍스트를 추출할 수 없습니다');
      }
      
      console.log('구글 비전 API OCR 완료');
      console.log('추출된 텍스트 길이:', extractedText.length);
      console.log('신뢰도:', confidence);
      
      return { 
        text: extractedText, 
        confidence: confidence * 100,
        method: 'google_vision_api',
        rawResponse: response
      };
      
    } catch (error) {
      console.error('구글 비전 API 텍스트 추출 실패:', error);
      throw new Error(`구글 비전 API 오류: ${error.message}`);
    }
  },

  // 한국 세금 고지서 전용 분석 (패턴 매칭)
  analyzeTaxDocument: (text, fileName) => {
    console.log('구글 비전 API 기반 세금 고지서 분석 시작...');
    
    const result = {
      fileName: fileName,
      category: '취득세',
      name: '세금 고지서',
      amount: '미정',
      dueDate: '',
      stationName: '',
      address: '',
      extractedText: text,
      confidence: 0.4, // 구글 비전 API 기본 신뢰도
      details: {},
      method: 'google_vision_analysis',
      isRecurring: false // 기본값 설정
    };

    const cleanText = text.replace(/\s+/g, ' ').trim();
    
    // 1. 세금 종류 식별
    for (const [type, keywords] of Object.entries(GoogleVisionOCR.patterns.taxTypes)) {
      if (keywords.some(keyword => {
        const regex = new RegExp(keyword, 'gi');
        return regex.test(cleanText);
      })) {
        result.category = type;
        result.name = `${type} 고지서`;
        result.confidence += 0.2;
        
        // 재산세나 기타세인 경우 자동으로 반복 납부 활성화
        if (type === '재산세' || type === '기타세') {
          result.isRecurring = true;
        }
        break;
      }
    }
    
    // 2. 금액 추출
    const amounts = [];
    GoogleVisionOCR.patterns.amounts.forEach(pattern => {
      const matches = [...cleanText.matchAll(pattern)];
      matches.forEach(match => {
        const amount = match[1] ? match[1].replace(/,/g, '') : match[0].replace(/[^0-9]/g, '');
        const numAmount = parseInt(amount);
        if (numAmount && numAmount >= 1000) {
          amounts.push({
            amount: numAmount,
            formatted: numAmount.toLocaleString('ko-KR'),
            context: match[0]
          });
        }
      });
    });
    
    if (amounts.length > 0) {
      const mainAmount = amounts.sort((a, b) => b.amount - a.amount)[0];
      result.amount = mainAmount.formatted;
      result.confidence += 0.3;
      result.details.allAmounts = amounts;
    }
    
    // 3. 납부기한 추출
    let foundDate = false;
    GoogleVisionOCR.patterns.dates.forEach(pattern => {
      if (foundDate) return;
      
      const matches = [...cleanText.matchAll(pattern)];
      matches.forEach(match => {
        try {
          let year, month, day;
          if (match[0].includes('년')) {
            [, year, month, day] = match;
          } else {
            [, year, month, day] = match;
          }
          
          if (year && month && day) {
            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            if (date > new Date()) {
              result.dueDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
              result.confidence += 0.2;
              foundDate = true;
            }
          }
        } catch (e) {
          console.warn('날짜 파싱 오류:', e);
        }
      });
    });
    
    // 기본 납부기한 설정
    if (!foundDate) {
      const defaultDate = new Date();
      defaultDate.setMonth(defaultDate.getMonth() + 3);
      result.dueDate = defaultDate.toISOString().split('T')[0];
    }
    
    // 4. 주소 추출
    let foundAddress = false;
    GoogleVisionOCR.patterns.addresses.forEach(pattern => {
      if (foundAddress) return;
      
      const matches = [...cleanText.matchAll(pattern)];
      if (matches.length > 0) {
        const address = matches[0][1]?.trim();
        if (address && address.length > 5) {
          result.address = address;
          result.confidence += 0.15;
          foundAddress = true;
        }
      }
    });
    
    // 5. 납세자명 추출
    GoogleVisionOCR.patterns.taxpayers.forEach(pattern => {
      const matches = [...cleanText.matchAll(pattern)];
      if (matches.length > 0) {
        const taxpayer = matches[0][1]?.trim();
        if (taxpayer) {
          result.details.taxpayer = taxpayer;
          
          if (taxpayer.includes('에너지') || taxpayer.includes('충전') || taxpayer.includes('전기')) {
            const stationName = taxpayer.replace(/(주식회사|㈜|㈝)/g, '').trim() + ' 충전소';
            result.stationName = stationName;
            result.confidence += 0.1;
          }
        }
      }
    });
    
    // 기본 주소 설정
    if (!foundAddress) {
      const defaultAddresses = [
        '서울특별시 강남구 테헤란로 123',
        '서울특별시 송파구 중대로 50',
        '경기도 성남시 분당구 판교역로 345'
      ];
      result.address = defaultAddresses[Math.floor(Math.random() * defaultAddresses.length)];
    }
    
    console.log('구글 비전 API 분석 결과:', result);
    return result;
  },

  // 메인 분석 함수
  analyze: async (file) => {
    try {
      console.log('구글 비전 API 기반 분석 시작');
      
      // 1단계: 구글 비전 API로 텍스트 추출
      const { text, confidence, rawResponse } = await GoogleVisionOCR.extractText(file);
      
      if (!text || text.trim().length < 20) {
        throw new Error('추출된 텍스트가 너무 짧습니다');
      }
      
      // 2단계: 한국 세금 고지서 패턴 분석
      const result = GoogleVisionOCR.analyzeTaxDocument(text, file.name);
      
      // 구글 비전 API 신뢰도와 패턴 분석 신뢰도 결합
      result.confidence = Math.min((confidence / 100 * 0.4) + (result.confidence * 0.6), 0.98);
      result.method = 'google_vision_api';
      result.success = true;
      result.apiResponse = rawResponse;
      
      return result;
      
    } catch (error) {
      console.error('구글 비전 API 분석 실패:', error);
      throw error;
    }
  }
};

// API 설정 아이콘 컴포넌트 정의
const ApiSettingsIcon = ({ className }) => (
  <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3a1 1 0 011-1h2.586l6.414-6.586a2 2 0 012.828 0z" />
  </svg>
);

// 커스텀 스크롤바 스타일
const scrollbarStyles = `
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;600;700&display=swap&subset=korean');
  
  /* 폰트 로딩 최적화 */
  @font-face {
    font-family: 'System Fallback';
    src: local('Apple SD Gothic Neo'), local('Noto Sans KR'), local('Malgun Gothic'), local('sans-serif');
    font-display: swap;
  }
  
  /* 더 강력한 폰트 적용 - 모든 요소에 !important 사용 */
  *, *::before, *::after {
    font-family: 'Poppins', 'Noto Sans KR', 'System Fallback', -apple-system, BlinkMacSystemFont, system-ui, sans-serif !important;
    font-display: swap !important;
  }
  
  /* 특정 요소들에 대한 강제 폰트 적용 */
  html, body, div, span, p, h1, h2, h3, h4, h5, h6, a, em, strong, small, sub, sup, mark, del, ins, strike, s, u, cite, q, dfn, abbr, time, code, var, samp, kbd, b, i, small, sub, sup, input, textarea, select, option, button, label, fieldset, legend, table, thead, tbody, tfoot, tr, td, th, caption, article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary {
    font-family: 'Poppins', 'Noto Sans KR', 'System Fallback', -apple-system, BlinkMacSystemFont, system-ui, sans-serif !important;
  }
  
  /* 폰트 속성 정규화 */
  * {
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum";
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(51, 65, 85, 0.3);
    border-radius: 3px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(71, 85, 105, 0.6);
    border-radius: 3px;
    transition: background 0.2s ease;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(71, 85, 105, 0.8);
  }
  .custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: rgba(71, 85, 105, 0.6) rgba(51, 65, 85, 0.3);
  }
  
  /* 커스텀 select 박스 스타일 */
  select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }
  
  /* 다크 테마에 맞는 select 옵션 스타일 - 강제 폰트 적용 */
  select option {
    background-color: rgb(30, 41, 59) !important;
    color: rgb(226, 232, 240) !important;
    padding: 0.5rem !important;
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif !important;
  }
  
  /* 날짜 입력 필드 커스텀 스타일 */
  input[type="date"] {
    position: relative;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.25em 1.25em;
    padding-right: 2.5rem;
  }
  
  /* 웹킷 브라우저의 날짜 선택기 버튼 숨기기 */
  input[type="date"]::-webkit-calendar-picker-indicator {
    opacity: 0;
    position: absolute;
    right: 0;
    width: 2.5rem;
    height: 100%;
    cursor: pointer;
  }
  
  /* 파이어폭스의 날짜 입력 필드 스타일 */
  input[type="date"]::-moz-focus-inner {
    border: 0;
  }
  
  /* 파일 업로드 input 커스터마이징 */
  input[type="file"] {
    display: none;
  }
  
  /* 플레이스홀더 텍스트 폰트 적용 */
  ::placeholder {
    font-family: 'Poppins', 'Noto Sans KR', 'System Fallback', -apple-system, BlinkMacSystemFont, system-ui, sans-serif !important;
  }
  
  /* 드롭다운 애니메이션 */
  .dropdown-enter {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
  }
  
  .dropdown-enter-active {
    opacity: 1;
    transform: translateY(0) scale(1);
    transition: all 200ms ease-out;
  }
  
  .dropdown-exit {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  
  .dropdown-exit-active {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    transition: all 150ms ease-in;
  }
  
  @keyframes slide-in-left {
    from {
      transform: translateX(-100%);
    }
    to {
      transform: translateX(0);
    }
  }
  
  @keyframes slide-in-right {
    from {
      transform: translateX(100%);
    }
    to {
      transform: translateX(0);
    }
  }
  
  .animate-slide-in-left {
    animation: slide-in-left 0.3s ease-out;
  }
  
  .animate-slide-in-right {
    animation: slide-in-right 0.3s ease-out;
  }
  
  /* 포커스 상태 개선 */
  input:focus,
  select:focus,
  textarea:focus,
  button:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
  }
  
  /* 버튼 호버 효과 개선 */
  button {
    transition: all 0.2s ease-in-out;
  }
  
  button:hover {
    transform: translateY(-1px);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  /* 카드 호버 효과 */
  .card-hover {
    transition: all 0.3s ease-in-out;
  }
  
  .card-hover:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
  }
`;

// PDF를 이미지로 변환하는 함수 (개선된 버전)
const convertPdfToImage = async (pdfFile) => {
  console.log('PDF 변환 시작:', pdfFile.name, 'Size:', pdfFile.size);
  
  try {
    // 1단계: PDF.js 라이브러리 로드
    console.log('PDF.js 라이브러리 로드 중...');
    const pdfjsLib = await loadPdfJS();
    if (!pdfjsLib) {
      throw new Error('PDF.js 라이브러리를 로드할 수 없습니다');
    }
    console.log('PDF.js 라이브러리 로드 완료');

    // 2단계: PDF 파일을 ArrayBuffer로 읽기
    console.log('PDF 파일 읽기 중...');
    const arrayBuffer = await pdfFile.arrayBuffer();
    console.log('PDF ArrayBuffer 크기:', arrayBuffer.byteLength);
    
    // 3단계: PDF 문서 로드
    console.log('PDF 문서 로드 중...');
    const loadingTask = pdfjsLib.getDocument({
      data: arrayBuffer,
      cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
      cMapPacked: true,
      verbosity: 0 // 로그 최소화
    });
    
    const pdf = await loadingTask.promise;
    console.log('PDF 로드 완료. 페이지 수:', pdf.numPages);

    // 4단계: 첫 번째 페이지 가져오기
    console.log('첫 번째 페이지 렌더링 시작...');
    const page = await pdf.getPage(1);
    
    // 5단계: 뷰포트 설정 (고해상도)
    const scale = 2.0; // 2배 확대
    const viewport = page.getViewport({ scale });
    console.log('뷰포트 크기:', viewport.width, 'x', viewport.height);

    // 6단계: Canvas 생성 및 설정
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    
    // 배경을 흰색으로 설정 (OCR 성능 향상)
    context.fillStyle = 'white';
    context.fillRect(0, 0, canvas.width, canvas.height);

    // 7단계: PDF 페이지를 Canvas에 렌더링
    const renderContext = {
      canvasContext: context,
      viewport: viewport,
      intent: 'print' // 고품질 렌더링
    };
    
    await page.render(renderContext).promise;
    console.log('PDF 렌더링 완료');

    // 8단계: Canvas를 Blob으로 변환
    const blob = await new Promise((resolve) => {
      canvas.toBlob((blob) => {
        resolve(blob);
      }, 'image/png', 0.95); // 높은 품질로 PNG 생성
    });

    if (!blob) {
      throw new Error('Canvas를 이미지로 변환하는데 실패했습니다');
    }

    // 9단계: Blob을 File 객체로 변환
    const imageFile = new File([blob], `${pdfFile.name.replace('.pdf', '')}_page1.png`, {
      type: 'image/png'
    });
    
    console.log('PDF → 이미지 변환 완료:', imageFile.name, 'Size:', imageFile.size);
    return imageFile;

  } catch (error) {
    console.error('PDF 변환 실패:', error);
    
    // 상세한 오류 정보 제공
    if (error.message.includes('Invalid PDF')) {
      throw new Error('유효하지 않은 PDF 파일입니다');
    } else if (error.message.includes('Password')) {
      throw new Error('패스워드로 보호된 PDF는 지원되지 않습니다');
    } else if (error.message.includes('network')) {
      throw new Error('네트워크 오류: PDF.js 라이브러리를 로드할 수 없습니다');
    } else {
      throw new Error(`PDF 변환 오류: ${error.message}`);
    }
  }
};

// PDF.js 라이브러리 동적 로드 (개선된 버전)
const loadPdfJS = async () => {
  try {
    // PDF.js가 이미 로드되어 있는지 확인
    if (window.pdfjsLib) {
      console.log('PDF.js 이미 로드됨');
      return window.pdfjsLib;
    }

    console.log('PDF.js 라이브러리 로드 시작...');
    
    return new Promise((resolve, reject) => {
      // 타임아웃 설정 (10초)
      const timeout = setTimeout(() => {
        reject(new Error('PDF.js 로드 시간 초과 (10초)'));
      }, 10000);

      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
      script.async = true;
      
      script.onload = () => {
        clearTimeout(timeout);
        
        if (window.pdfjsLib) {
          // Worker 경로 설정
          window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
          
          console.log('PDF.js 라이브러리 로드 성공');
          resolve(window.pdfjsLib);
        } else {
          reject(new Error('PDF.js 객체를 찾을 수 없습니다'));
        }
      };
      
      script.onerror = () => {
        clearTimeout(timeout);
        reject(new Error('PDF.js 스크립트 로드 실패 - 네트워크를 확인해주세요'));
      };
      
      // 스크립트가 이미 존재하는지 확인
      const existingScript = document.querySelector('script[src*="pdf.min.js"]');
      if (existingScript) {
        // 이미 로드 중이면 잠시 대기 후 재확인
        setTimeout(() => {
          if (window.pdfjsLib) {
            clearTimeout(timeout);
            resolve(window.pdfjsLib);
          } else {
            reject(new Error('기존 PDF.js 로드가 완료되지 않았습니다'));
          }
        }, 2000);
        return;
      }
      
      document.head.appendChild(script);
    });

  } catch (error) {
    console.error('PDF.js 로드 오류:', error);
    throw new Error(`PDF.js 라이브러리 로드 실패: ${error.message}`);
  }
};
const koreaTimeUtils = {
  // 한국 시간(KST) 기준으로 현재 시간 가져오기
  getKoreaTime: () => {
    const now = new Date();
    // UTC 시간에 9시간 추가하여 한국 시간으로 변환
    return new Date(now.getTime() + (9 * 60 * 60 * 1000));
  },
  
  // 날짜 문자열을 한국 시간 기준 Date 객체로 변환
  parseKoreaDate: (dateString) => {
    if (!dateString) return null;
    try {
      // YYYY-MM-DD 형식의 날짜를 한국 시간 기준으로 파싱
      const [year, month, day] = dateString.split('-').map(Number);
      if (year && month && day) {
        // 한국 시간 기준 자정으로 설정
        return new Date(year, month - 1, day, 0, 0, 0, 0);
      }
      return null;
    } catch (error) {
      console.warn('parseKoreaDate error:', error, 'input:', dateString);
      return null;
    }
  },
  
  // 한국 시간 기준으로 날짜를 YYYY-MM-DD 형식으로 포맷
  formatKoreaDate: (date) => {
    try {
      if (!date) return '';
      const koreaDate = new Date(date.getTime() + (9 * 60 * 60 * 1000));
      const year = koreaDate.getFullYear();
      const month = String(koreaDate.getMonth() + 1).padStart(2, '0');
      const day = String(koreaDate.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    } catch (error) {
      console.warn('formatKoreaDate error:', error, 'input:', date);
      return '';
    }
  },
  
  // 한국 시간 기준으로 오늘 날짜 가져오기
  getKoreaToday: () => {
    const koreaTime = koreaTimeUtils.getKoreaTime();
    return koreaTimeUtils.formatKoreaDate(koreaTime);
  },
  
  // 한국 시간 기준으로 날짜 차이 계산
  getDaysDifference: (date1, date2) => {
    try {
      const d1 = koreaTimeUtils.parseKoreaDate(date1) || new Date(date1);
      const d2 = koreaTimeUtils.parseKoreaDate(date2) || new Date(date2);
      
      if (isNaN(d1.getTime()) || isNaN(d2.getTime())) {
        return 0;
      }
      
      // 자정 기준으로 날짜 차이 계산
      const diffTime = d1.getTime() - d2.getTime();
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    } catch (error) {
      console.warn('getDaysDifference error:', error);
      return 0;
    }
  }
};

// SendGrid API 통합 시스템
const SendGridAPI = {
  // SendGrid API 설정
  config: {
    get apiKey() {
      // 브라우저 환경에서 안전하게 API 키 가져오기
      if (typeof window !== 'undefined' && window.SENDGRID_API_KEY) {
        return window.SENDGRID_API_KEY;
      }
      
      try {
        const storedKey = localStorage.getItem('sendgrid_api_key');
        if (storedKey) {
          if (typeof window !== 'undefined') {
            window.SENDGRID_API_KEY = storedKey;
          }
          return storedKey;
        }
      } catch (e) {
        console.warn('localStorage 접근 실패:', e);
      }
      
      return 'YOUR_SENDGRID_API_KEY';
    },
    
    get fromEmail() {
      try {
        return localStorage.getItem('sendgrid_from_email') || 'noreply@watercharging.com';
      } catch (e) {
        return 'noreply@watercharging.com';
      }
    },
    
    get fromName() {
      try {
        return localStorage.getItem('sendgrid_from_name') || 'Water TT 관리시스템';
      } catch (e) {
        return 'Water TT 관리시스템';
      }
    },
    
    endpoint: 'https://api.sendgrid.com/v3/mail/send'
  },

  // API 키 설정 헬퍼 함수
  setConfig: (apiKey, fromEmail, fromName) => {
    try {
      console.log('SendGrid 설정 저장 시도');
      
      // window 객체에 저장
      if (typeof window !== 'undefined') {
        window.SENDGRID_API_KEY = apiKey;
      }
      
      // localStorage에 저장
      localStorage.setItem('sendgrid_api_key', apiKey);
      localStorage.setItem('sendgrid_from_email', fromEmail);
      localStorage.setItem('sendgrid_from_name', fromName);
      
      console.log('SendGrid 설정이 저장되었습니다.');
      return true;
    } catch (error) {
      console.error('SendGrid 설정 저장 실패:', error);
      return false;
    }
  },

  // API 키 확인 함수
  hasValidApiKey: () => {
    const apiKey = SendGridAPI.config.apiKey;
    return apiKey && apiKey !== 'YOUR_SENDGRID_API_KEY' && apiKey.startsWith('SG.');
  },

  // 이메일 템플릿 시스템
  templates: {
    // 세금 알림 템플릿
    taxReminder: (data) => {
      const { stationName, taxType, amount, dueDate, daysLeft, priority } = data;
      
      let subject, content;
      
      if (priority === 'high') { // 3일 전
        subject = `🚨 [긴급] ${stationName} ${taxType} 납부 기한 임박 (${daysLeft}일 남음)`;
        content = `
안녕하세요.

${stationName}의 ${taxType} 납부 기한이 ${daysLeft}일 남았습니다.

⚠️ 긴급 알림 ⚠️
• 충전소: ${stationName}
• 세금 종류: ${taxType}
• 납부 금액: ${amount}
• 납부 기한: ${dueDate}

즉시 납부 처리를 진행해주세요.

Water TT 관리시스템
        `.trim();
      } else if (priority === 'medium') { // 15일 전
        subject = `⏰ ${stationName} ${taxType} 납부 준비 알림 (${daysLeft}일 남음)`;
        content = `
안녕하세요.

${stationName}의 ${taxType} 납부 기한이 다가오고 있습니다.

📋 납부 정보
• 충전소: ${stationName}
• 세금 종류: ${taxType}
• 납부 금액: ${amount}
• 납부 기한: ${dueDate}

미리 준비해주세요.

Water TT 관리시스템
        `.trim();
      } else { // 60일 전
        subject = `📅 ${stationName} ${taxType} 사전 알림 (${daysLeft}일 남음)`;
        content = `
안녕하세요.

${stationName}의 ${taxType} 납부 예정일을 안내드립니다.

📌 예정 정보
• 충전소: ${stationName}
• 세금 종류: ${taxType}
• 납부 금액: ${amount}
• 납부 기한: ${dueDate}

참고해주세요.

Water TT 관리시스템
        `.trim();
      }
      
      return { subject, content };
    },

    // 충전소 정보 미입력 알림 템플릿
    stationInfoMissing: (data) => {
      const { stationName, missingType, daysSinceRegistered } = data;
      
      const typeText = missingType === 'approval' ? '사용 승인일' : '전기 안전 점검일';
      
      const subject = `📝 ${stationName} ${typeText} 정보 입력 요청`;
      const content = `
안녕하세요.

${stationName}의 ${typeText} 정보가 입력되지 않았습니다.

🔍 확인 정보
• 충전소: ${stationName}
• 미입력 항목: ${typeText}
• 등록 경과일: ${daysSinceRegistered}일

충전소 관리 화면에서 정보를 입력해주세요.

Water TT 관리시스템
      `.trim();
      
      return { subject, content };
    },

    // 충전소 정보 입력 완료 알림 템플릿 (새로 추가)
    stationInfoAdded: (data) => {
      const { stationName, infoType, date, hasAutoTax } = data;
      
      const typeText = infoType === 'approval' ? '사용 승인일' : '전기 안전 점검일';
      const taxText = infoType === 'approval' ? '캐노피 취득세' : '충전기 취득세';
      
      const subject = `✅ ${stationName} ${typeText} 정보 입력 완료`;
      const content = `
안녕하세요.

${stationName}의 ${typeText}이 입력되었습니다.

✅ 입력 완료 정보
• 충전소: ${stationName}
• 항목: ${typeText}
• 날짜: ${date}

${hasAutoTax ? `📋 자동 처리 안내
• ${taxText}이 자동으로 등록되었습니다
• 납부 기한: ${date}로부터 60일 후
• 세금 현황에서 확인 가능합니다` : ''}

Water TT 관리시스템
      `.trim();
      
      return { subject, content };
    }
  },

  // 일반 이메일 발송 함수
  sendEmail: async (toEmails, subject, content) => {
    if (!SendGridAPI.hasValidApiKey()) {
      throw new Error('SendGrid API 키가 설정되지 않았습니다.');
    }

    // 문자열이면 배열로 변환
    const recipients = Array.isArray(toEmails) ? toEmails : [toEmails];
    
    const emailData = {
      personalizations: [{
        to: recipients.map(email => ({ email })),
        subject: subject
      }],
      from: {
        email: SendGridAPI.config.fromEmail,
        name: SendGridAPI.config.fromName
      },
      content: [{
        type: 'text/plain',
        value: content
      }]
    };

    try {
      const response = await fetch(SendGridAPI.config.endpoint, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${SendGridAPI.config.apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(emailData)
      });

      if (!response.ok) {
        const errorText = await response.text();
        return {
          success: false,
          error: `HTTP ${response.status}: ${errorText}`,
          statusCode: response.status,
          isNetworkError: false
        };
      }

      return {
        success: true,
        message: '이메일이 성공적으로 전송되었습니다.'
      };

    } catch (error) {
      console.error('SendGrid API 호출 실패:', error);
      return {
        success: false,
        error: error.message,
        isNetworkError: true
      };
    }
  },

  // 템플릿 기반 이메일 발송
  sendTemplateEmail: async (toEmails, templateType, templateData) => {
    try {
      let template;
      
      if (templateType === 'taxReminder') {
        template = SendGridAPI.templates.taxReminder(templateData);
      } else if (templateType === 'stationInfoMissing') {
        template = SendGridAPI.templates.stationInfoMissing(templateData);
      } else if (templateType === 'stationInfoAdded') {
        template = SendGridAPI.templates.stationInfoAdded(templateData);
      } else {
        throw new Error(`알 수 없는 템플릿 타입: ${templateType}`);
      }
      
      return await SendGridAPI.sendEmail(toEmails, template.subject, template.content);
      
    } catch (error) {
      console.error('템플릿 이메일 발송 실패:', error);
      return {
        success: false,
        error: error.message
      };
    }
  },

  // 테스트 이메일 전송
  sendTestEmail: async (toEmail) => {
    if (!SendGridAPI.hasValidApiKey()) {
      throw new Error('SendGrid API 키가 설정되지 않았습니다.');
    }

    const emailData = {
      personalizations: [{
        to: [{ email: toEmail }],
        subject: 'Water TT 관리시스템 테스트 이메일'
      }],
      from: {
        email: SendGridAPI.config.fromEmail,
        name: SendGridAPI.config.fromName
      },
      content: [{
        type: 'text/html',
        value: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #2563eb;">Water TT 관리시스템</h2>
            <p>안녕하세요!</p>
            <p>SendGrid 이메일 설정이 성공적으로 완료되었습니다.</p>
            <p>이 테스트 이메일은 ${new Date().toLocaleString('ko-KR')}에 전송되었습니다.</p>
            <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
            <p style="color: #6b7280; font-size: 14px;">
              이 이메일은 시스템 테스트용으로 발송되었습니다.
            </p>
          </div>
        `
      }]
    };

    try {
      const response = await fetch(SendGridAPI.config.endpoint, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${SendGridAPI.config.apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(emailData)
      });

      if (!response.ok) {
        const errorText = await response.text();
        return {
          success: false,
          error: `HTTP ${response.status}: ${errorText}`,
          statusCode: response.status,
          isNetworkError: false
        };
      }

      return {
        success: true,
        message: '테스트 이메일이 성공적으로 전송되었습니다.'
      };

    } catch (error) {
      console.error('SendGrid API 호출 실패:', error);
      return {
        success: false,
        error: error.message,
        isNetworkError: true
      };
    }
  }
};

// 유틸리티 함수들 (한국 시간 적용)
const utils = {
  getAmount: (amount) => {
    try {
      if (!amount || amount === '' || amount === '미정') return 0;
      const cleaned = amount.toString().replace(/,/g, '');
      const num = parseInt(cleaned);
      return isNaN(num) ? 0 : Math.max(0, num); // 음수 방지
    } catch (error) {
      console.error('getAmount error:', error, 'input:', amount);
      return 0;
    }
  },
  
  formatAmount: (amount) => {
    try {
      if (!amount || amount === '' || amount === '미정') return '미정';
      const cleaned = amount.toString().replace(/,/g, '');
      const num = parseInt(cleaned);
      return isNaN(num) ? '미정' : new Intl.NumberFormat('ko-KR').format(num);
    } catch (error) {
      console.warn('formatAmount error:', error, 'input:', amount);
      return '미정';
    }
  },
  
  normalizeAmount: (amount) => {
    try {
      if (!amount || amount === '' || amount.toString().trim() === '') return '미정';
      return amount;
    } catch (error) {
      console.warn('normalizeAmount error:', error, 'input:', amount);
      return '미정';
    }
  },
  
  // 한국 시간 기준으로 납부 기한까지 남은 일수 계산
  getDaysUntilDue: (dueDate) => {
    try {
      if (!dueDate) return 999; // 기본값으로 먼 미래
      
      const today = koreaTimeUtils.getKoreaToday();
      return koreaTimeUtils.getDaysDifference(dueDate, today);
    } catch (error) {
      console.warn('getDaysUntilDue error:', error, 'input:', dueDate);
      return 999;
    }
  },
  
  formatKoreanCurrency: (amount) => {
    try {
      if (!amount && amount !== 0) return '0';
      const num = typeof amount === 'string' ? parseInt(amount.replace(/,/g, '')) : amount;
      return isNaN(num) ? '0' : new Intl.NumberFormat('ko-KR').format(num);
    } catch (error) {
      console.warn('formatKoreanCurrency error:', error, 'input:', amount);
      return '0';
    }
  },
  
  // 안전한 날짜 생성 (한국 시간 기준)
  safeDate: (dateString) => {
    try {
      if (!dateString) return koreaTimeUtils.getKoreaTime();
      const parsed = koreaTimeUtils.parseKoreaDate(dateString);
      return parsed || koreaTimeUtils.getKoreaTime();
    } catch (error) {
      console.warn('safeDate error:', error, 'input:', dateString);
      return koreaTimeUtils.getKoreaTime();
    }
  }
};

// 디바운스 함수 (동기화 개선용)
const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
};

// localStorage 유틸리티 함수들 (Vercel 배포용 - 주석 처리)
const storageUtils = {
  save: (key, data) => {
    // localStorage 비활성화 - Vercel 서버 배포용
    /*
    try {
      // 데이터 크기 체크 (5MB 제한)
      const serialized = JSON.stringify(data);
      if (serialized.length > 5 * 1024 * 1024) {
        console.warn('Data too large for localStorage:', key);
        return false;
      }
      
      localStorage.setItem(key, serialized);
      return true;
    } catch (error) {
      console.error('Failed to save to localStorage:', error);
      
      // 저장소가 가득 찬 경우 오래된 데이터 정리 시도
      if (error.name === 'QuotaExceededError') {
        try {
          // 임시 백업 데이터 삭제
          const keysToClean = Object.keys(localStorage).filter(k => k.startsWith('temp_') || k.startsWith('backup_'));
          keysToClean.forEach(k => localStorage.removeItem(k));
          
          // 다시 저장 시도
          localStorage.setItem(key, JSON.stringify(data));
          return true;
        } catch (retryError) {
          console.error('Failed to save after cleanup:', retryError);
        }
      }
      return false;
    }
    */
    console.log(`[Vercel Mode] Would save data for key: ${key}`);
    return true; // 서버 모드에서는 항상 성공으로 처리
  },
  
  load: (key, defaultValue = null) => {
    // localStorage 비활성화 - Vercel 서버 배포용
    /*
    try {
      const item = localStorage.getItem(key);
      if (!item) return defaultValue;
      
      const parsed = JSON.parse(item);
      
      // 데이터 무결성 검사
      if (key === 'tax_bills' && Array.isArray(parsed)) {
        return parsed.filter(bill => bill && bill.id && bill.name);
      }
      if (key === 'charging_stations' && Array.isArray(parsed)) {
        return parsed.filter(station => station && station.name && station.address);
      }
      if (key === 'user_accounts' && Array.isArray(parsed)) {
        return parsed.filter(account => account && account.id && account.email);
      }
      
      return parsed;
    } catch (error) {
      console.error('Failed to load from localStorage:', error);
      console.warn(`Corrupted data detected for key: ${key}, using default value`);
      return defaultValue;
    }
    */
    console.log(`[Vercel Mode] Would load data for key: ${key}, returning default`);
    return defaultValue; // 서버 모드에서는 항상 기본값 반환
  },
  
  remove: (key) => {
    // localStorage 비활성화 - Vercel 서버 배포용
    /*
    try {
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error('Failed to remove from localStorage:', error);
      return false;
    }
    */
    console.log(`[Vercel Mode] Would remove data for key: ${key}`);
    return true; // 서버 모드에서는 항상 성공으로 처리
  },
  
  // 백업 기능 추가
  backup: (keys = ['tax_bills', 'charging_stations', 'user_accounts']) => {
    // localStorage 비활성화 - Vercel 서버 배포용
    /*
    try {
      const backup = {};
      keys.forEach(key => {
        const data = localStorage.getItem(key);
        if (data) backup[key] = data;
      });
      
      const backupKey = `backup_${new Date().toISOString().split('T')[0]}`;
      localStorage.setItem(backupKey, JSON.stringify(backup));
      return backupKey;
    } catch (error) {
      console.error('Failed to create backup:', error);
      return null;
    }
    */
    console.log(`[Vercel Mode] Would create backup for keys:`, keys);
    return null; // 서버 모드에서는 백업 불가
  }
};

// 날짜 범위 계산 함수들
const dateRanges = {
  // 납부 기한용 (과거 1년 ~ 미래 5년)
  getDueDateRange: () => {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    const fiveYearsLater = new Date();
    fiveYearsLater.setFullYear(today.getFullYear() + 5);
    
    return {
      min: oneYearAgo.toISOString().split('T')[0],
      max: fiveYearsLater.toISOString().split('T')[0]
    };
  },
  
  // 일반 날짜용 (1950년 ~ 2050년)
  getGeneralDateRange: () => ({
    min: '1950-01-01',
    max: '2050-12-31'
  })
};

// 금액 검증 및 포맷팅 함수들 (강화된 검증)
const amountValidation = {
  // 숫자만 추출 (콤마 제거)
  extractNumbers: (value) => {
    if (!value) return '';
    return value.toString().replace(/[^0-9]/g, '');
  },
  
  // 콤마 포맷팅 (안전한 처리)
  formatWithCommas: (value) => {
    if (!value || value === '') return '';
    const numbers = amountValidation.extractNumbers(value);
    if (!numbers) return '';
    
    try {
      const num = parseInt(numbers);
      if (isNaN(num)) return '';
      return new Intl.NumberFormat('ko-KR').format(num);
    } catch (error) {
      console.warn('Format error:', error);
      return value; // 오류 시 원본 반환
    }
  },
  
  // 금액 유효성 검사 (더 엄격한 검증)
  isValidAmount: (value) => {
    if (!value || value === '' || value === '미정') return true;
    
    try {
      const numbers = amountValidation.extractNumbers(value);
      if (!numbers) return false;
      
      const amount = parseInt(numbers);
      if (isNaN(amount)) return false;
      
      // 현실적인 범위 체크
      if (amount < 0) return false;
      if (amount > 100000000000) return false; // 1000억원 제한
      
      return true;
    } catch (error) {
      console.warn('Amount validation error:', error);
      return false;
    }
  },
  
  // 금액 오류 메시지 (더 구체적)
  getAmountErrorMessage: (value) => {
    if (!value || value === '' || value === '미정') return '';
    
    try {
      const numbers = amountValidation.extractNumbers(value);
      if (!numbers) return '올바른 숫자를 입력해주세요.';
      
      const amount = parseInt(numbers);
      if (isNaN(amount)) return '유효하지 않은 숫자입니다.';
      if (amount < 0) return '금액은 0원 이상이어야 합니다.';
      if (amount > 100000000000) return '금액은 1000억원 이하여야 합니다.';
      
      return '';
    } catch (error) {
      console.warn('Amount error message generation failed:', error);
      return '금액 형식을 확인해주세요.';
    }
  },
  
  // 입력값 정리 (안전한 처리)
  sanitizeInput: (value) => {
    if (!value || value === '미정') return value;
    
    try {
      const numbers = amountValidation.extractNumbers(value);
      return numbers ? amountValidation.formatWithCommas(numbers) : '';
    } catch (error) {
      console.warn('Sanitize input error:', error);
      return value; // 오류 시 원본 반환
    }
  }
};

// 통합 색상 시스템 (중앙집중식)
const COLOR_SYSTEM = {
  // 기본 색상 팔레트
  primary: {
    bg: 'bg-slate-700',
    bgHover: 'hover:bg-slate-600',
    text: 'text-slate-200',
    border: 'border-slate-600'
  },
  secondary: {
    bg: 'bg-slate-600',
    bgHover: 'hover:bg-slate-500',
    text: 'text-slate-300',
    border: 'border-slate-500'
  },
  accent: {
    bg: 'bg-slate-500',
    bgHover: 'hover:bg-slate-400',
    text: 'text-slate-200',
    border: 'border-slate-400'
  },
  
  // 카테고리별 색상 (슬레이트 계열로 통일)
  categories: {
    '취득세': {
      bg: 'bg-slate-600/40',
      text: 'text-slate-200',
      border: 'border-slate-500/40',
      dot: 'bg-slate-500',
      progress: 'bg-slate-600'
    },
    '재산세': {
      bg: 'bg-slate-700/40',
      text: 'text-slate-200',
      border: 'border-slate-600/40',
      dot: 'bg-slate-600',
      progress: 'bg-slate-700'
    },
    '기타세': {
      bg: 'bg-slate-500/40',
      text: 'text-slate-200',
      border: 'border-slate-400/40',
      dot: 'bg-slate-400',
      progress: 'bg-slate-500'
    }
  },
  
  // 상태별 색상
  status: {
    pending: {
      bg: 'bg-slate-500',
      text: 'text-slate-200',
      border: 'border-slate-500'
    },
    completed: {
      bg: 'bg-slate-600',
      text: 'text-slate-200',
      border: 'border-slate-600'
    },
    review: {
      bg: 'bg-slate-700',
      text: 'text-slate-200',
      border: 'border-slate-700'
    },
    overdue: {
      bg: 'bg-slate-800',
      text: 'text-slate-200',
      border: 'border-slate-800'
    }
  },
  
  // 액션 버튼 색상
  buttons: {
    primary: 'bg-slate-700 hover:bg-slate-600 text-white',
    secondary: 'bg-slate-600 hover:bg-slate-500 text-white',
    accent: 'bg-slate-800 hover:bg-slate-700 text-white',
    danger: 'bg-red-600 hover:bg-red-500 text-white' // 삭제 등 위험한 액션만 빨간색 유지
  },
  
  // 카드/컨테이너 색상
  cards: {
    primary: 'bg-gradient-to-br from-slate-800/50 to-slate-700/30 border-slate-600/30',
    secondary: 'bg-gradient-to-br from-slate-700/40 to-slate-600/20 border-slate-500/30'
  },
  
  // 진행률/순위별 색상
  ranking: {
    first: 'bg-slate-600 text-white border-slate-300',
    second: 'bg-slate-500 text-white border-slate-300', 
    third: 'bg-slate-700 text-white border-slate-300',
    other: 'bg-slate-500 text-white border-slate-300'
  },
  
  progress: {
    high: 'bg-slate-500',      // 80% 이상
    medium: 'bg-slate-600',    // 50-79%
    low: 'bg-slate-700'        // 50% 미만
  }
};

// 대시보드 컴포넌트들
const DashboardKPICard = ({ title, value, subtitle, icon: IconComponent, progressWidth = 100, progressColor = 'bg-slate-500' }) => {
  return (
    <div className={`${COLOR_SYSTEM.cards.primary} backdrop-blur-md rounded-2xl p-6 border hover:shadow-lg transition-all duration-300 card-hover`}>
      <div className="flex items-center justify-between mb-4">
        <div className="p-3 bg-slate-600/30 rounded-xl">
          <IconComponent className="w-8 h-8 text-slate-400" />
        </div>
        <div className="text-right">
          <div className="text-xs text-slate-400 font-medium">TOTAL</div>
          <div className="text-slate-300 text-sm">{subtitle}</div>
        </div>
      </div>
      <div className="text-3xl font-bold text-gray-100 mb-1 font-mono">{value}</div>
      <div className="text-xs text-gray-400">{title}</div>
      <div className="mt-4 w-full bg-slate-700/50 rounded-full h-2">
        <div className={`${progressColor} h-2 rounded-full transition-all duration-1000`} style={{ width: `${progressWidth}%` }}></div>
      </div>
    </div>
  );
};

const DashboardMonthlyChart = ({ monthlyStats, formatKoreanCurrency }) => (
  <div className={`${COLOR_SYSTEM.cards.primary} backdrop-blur-md rounded-2xl p-8 mb-12 border`}>
    <div className="flex items-center justify-between mb-8">
      <div>
        <h3 className="text-xl font-bold text-gray-100 mb-2">월별 세금 현황</h3>
        <p className="text-xs text-gray-400">최근 12개월 납부 현황</p>
      </div>
      <div className="p-3 bg-slate-600/30 rounded-xl">
        <TrendingUp className="w-6 h-6 text-slate-400" />
      </div>
    </div>
    
    <div className="space-y-6">
      {monthlyStats.map((month, index) => {
        const maxAmount = Math.max(...monthlyStats.map(m => m.total));
        const completionPercentage = month.total > 0 ? (month.completed / month.total) * 100 : 0;
        
        return (
          <div key={index} className="relative">
            <div className="flex justify-between items-center mb-3">
              <span className="text-lg font-semibold text-gray-200">{month.month}</span>
              <div className="text-right">
                <div className={`text-lg font-bold ${COLOR_SYSTEM.primary.text} font-mono`}>₩{formatKoreanCurrency(month.total)}</div>
                <div className="text-xs text-gray-400">{month.count}건 • {Math.round(completionPercentage)}% 완료</div>
              </div>
            </div>
            <div className="relative bg-slate-800/50 rounded-xl h-4 overflow-hidden">
              <div className={`absolute left-0 top-0 h-full ${COLOR_SYSTEM.primary.bg} rounded-xl transition-all duration-1000`} style={{ width: `${maxAmount > 0 ? (month.total / maxAmount) * 100 : 0}%` }}></div>
              <div className={`absolute left-0 top-0 h-full ${COLOR_SYSTEM.accent.bg} rounded-xl transition-all duration-1000 delay-300`} style={{ width: `${maxAmount > 0 ? (month.completed / maxAmount) * 100 : 0}%` }}></div>
            </div>
          </div>
        );
      })}
    </div>
    
    <div className="mt-6 flex items-center space-x-6 pt-6 border-t border-slate-600/30">
      <div className="flex items-center space-x-2">
        <div className="w-3 h-3 bg-slate-600 rounded-full"></div>
        <span className="text-xs text-gray-400">총 금액</span>
      </div>
      <div className="flex items-center space-x-2">
        <div className="w-3 h-3 bg-slate-500 rounded-full"></div>
        <span className="text-xs text-gray-400">완료 금액</span>
      </div>
    </div>
  </div>
);

const DashboardQuickActions = ({ onNavigate }) => (
  <div className="text-center">
    <div className="inline-flex items-center space-x-3 p-5 bg-gradient-to-r from-slate-800/50 to-slate-700/30 backdrop-blur-md rounded-2xl border border-slate-600/30">
      <div className="text-gray-300">
        <div className="text-sm font-medium">전체 관리</div>
        <div className="text-xs text-gray-400">모든 세금과 충전소를 관리하세요</div>
      </div>
      <div className="flex items-center space-x-2">
        <Button 
          onClick={() => onNavigate('kanban')} 
          variant="secondary"
          size="sm"
        >
          세금 관리
        </Button>
        <Button 
          onClick={() => onNavigate('calendar')} 
          variant="outline"
          size="sm"
        >
          캘린더
        </Button>
      </div>
    </div>
  </div>
);

// 색상 헬퍼 함수들
const getColorByCategory = (category) => COLOR_SYSTEM.categories[category] || COLOR_SYSTEM.categories['기타세'];
const getColorByStatus = (status) => COLOR_SYSTEM.status[status] || COLOR_SYSTEM.status.pending;
const getProgressColor = (percentage) => {
  if (percentage >= 80) return COLOR_SYSTEM.progress.high;
  if (percentage >= 50) return COLOR_SYSTEM.progress.medium;
  return COLOR_SYSTEM.progress.low;
};
const getRankingColor = (rank) => {
  if (rank === 0) return COLOR_SYSTEM.ranking.first;
  if (rank === 1) return COLOR_SYSTEM.ranking.second;
  if (rank === 2) return COLOR_SYSTEM.ranking.third;
  return COLOR_SYSTEM.ranking.other;
};

// 상수들 (COLOR_SYSTEM 사용)
const CATEGORY_STYLES = {
  '취득세': `${COLOR_SYSTEM.categories['취득세'].bg} ${COLOR_SYSTEM.categories['취득세'].text} ${COLOR_SYSTEM.categories['취득세'].border}`,
  '재산세': `${COLOR_SYSTEM.categories['재산세'].bg} ${COLOR_SYSTEM.categories['재산세'].text} ${COLOR_SYSTEM.categories['재산세'].border}`,
  '기타세': `${COLOR_SYSTEM.categories['기타세'].bg} ${COLOR_SYSTEM.categories['기타세'].text} ${COLOR_SYSTEM.categories['기타세'].border}`
};

const STATUS_COLORS = {
  pending: COLOR_SYSTEM.status.pending.bg,
  review: COLOR_SYSTEM.status.review.bg,
  overdue: COLOR_SYSTEM.status.overdue.bg
};

const MODAL_STYLES = "fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50";
const CARD_STYLES = "bg-gradient-to-br from-slate-800/50 to-slate-700/30 backdrop-blur-md rounded-2xl border border-slate-600/30";

// 통합 필터 시스템 - 충전소 관리용
const StationFilterSystem = {
  // 필터 옵션 정의
  statusOptions: [
    { value: 'all', label: '전체 상태' },
    { value: 'operating', label: '운영 중' },
    { value: 'preparing', label: '오픈 예정' },
    { value: 'closed', label: '운영 종료' }
  ],
  
  dateFilterOptions: [
    { value: 'all', label: '전체' },
    { value: 'approval', label: '승인일' },
    { value: 'safety', label: '점검일' },
    { value: 'missing', label: '미입력' }
  ],
  
  // 필터 로직
  applyFilters: (stations, filters) => {
    let filtered = [...stations];
    
    // 검색 필터
    if (filters.search?.trim()) {
      const searchTerm = filters.search.toLowerCase();
      filtered = filtered.filter(station => 
        station.name.toLowerCase().includes(searchTerm) ||
        station.address.toLowerCase().includes(searchTerm)
      );
    }
    
    // 상태 필터
    if (filters.status !== 'all') {
      filtered = filtered.filter(station => station.status === filters.status);
    }
    
    // 날짜 필터
    const { dateFilter, startDate, endDate } = filters;
    
    if (dateFilter === 'approval') {
      filtered = filtered.filter(station => 
        station.approvalDate && station.approvalDate.trim() !== ''
      );
    } else if (dateFilter === 'safety') {
      filtered = filtered.filter(station => 
        station.safetyCheckDate && station.safetyCheckDate.trim() !== ''
      );
    } else if (dateFilter === 'missing') {
      filtered = filtered.filter(station => 
        (!station.approvalDate || station.approvalDate.trim() === '') ||
        (!station.safetyCheckDate || station.safetyCheckDate.trim() === '')
      );
    }
    
    // 날짜 범위 필터 적용
    if ((startDate || endDate) && dateFilter !== 'missing') {
      filtered = filtered.filter(station => {
        const start = startDate ? new Date(startDate) : null;
        const end = endDate ? new Date(endDate) : null;
        
        let approvalMatch = false;
        let safetyMatch = false;
        
        // 승인일 확인
        if (station.approvalDate?.trim()) {
          const approvalDate = new Date(station.approvalDate);
          if (dateFilter === 'all' || dateFilter === 'approval') {
            approvalMatch = (!start || approvalDate >= start) && (!end || approvalDate <= end);
          }
        }
        
        // 점검일 확인
        if (station.safetyCheckDate?.trim()) {
          const safetyDate = new Date(station.safetyCheckDate);
          if (dateFilter === 'all' || dateFilter === 'safety') {
            safetyMatch = (!start || safetyDate >= start) && (!end || safetyDate <= end);
          }
        }
        
        return dateFilter === 'all' ? (approvalMatch || safetyMatch) : 
               dateFilter === 'approval' ? approvalMatch : safetyMatch;
      });
    }
    
    return filtered;
  }
};

// 공통 필터 입력 컴포넌트 (컴팩트하게 개선)
const FilterInput = ({ 
  type, 
  label, 
  value, 
  onChange, 
  placeholder, 
  disabled = false,
  options = [],
  className = "",
  inputClassName = "",
  showLabel = true,
  ...props 
}) => {
  const baseInputClass = `h-9 px-3 border rounded-lg text-sm transition-all focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent ${
    disabled 
      ? 'bg-slate-600/30 border-slate-600/30 text-gray-500 cursor-not-allowed' 
      : 'bg-slate-700/50 border-slate-600/50 text-gray-200'
  }`;
  
  return (
    <div className={className}>
      {showLabel && label && (
        <label className="block text-xs font-medium text-gray-300 mb-1">{label}</label>
      )}
      {type === 'select' ? (
        <select 
          value={value} 
          onChange={onChange} 
          disabled={disabled}
          className={`w-full ${baseInputClass} ${inputClassName}`} 
          {...props}
        >
          {options.map(option => (
            <option key={option.value} value={option.value}>
              {option.label}
            </option>
          ))}
        </select>
      ) : (
        <input 
          type={type}
          value={value}
          onChange={onChange}
          placeholder={placeholder}
          disabled={disabled}
          className={`w-full ${baseInputClass} ${type === 'text' ? 'placeholder-gray-400' : ''} ${inputClassName}`}
          {...props}
        />
      )}
    </div>
  );
};

// 날짜 범위 필터 컴포넌트 (정리된 버전)
const DateRangeFilter = ({ 
  startDate, 
  endDate, 
  onStartDateChange, 
  onEndDateChange, 
  disabled = false,
  className = "",
  showQuickButtons = false // 빠른 버튼 표시 여부 제어
}) => {
  return (
    <div className={className}>
      <div className="grid grid-cols-2 gap-2">
        <div>
          <input
            type="date"
            value={startDate}
            onChange={onStartDateChange}
            disabled={disabled}
            className="w-full h-9 px-3 border rounded-lg text-xs transition-all focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent bg-slate-700/50 border-slate-600/50 text-gray-200 disabled:opacity-50"
            placeholder="시작일"
          />
        </div>
        
        <div>
          <input
            type="date"
            value={endDate}
            onChange={onEndDateChange}
            disabled={disabled}
            className="w-full h-9 px-3 border rounded-lg text-xs transition-all focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent bg-slate-700/50 border-slate-600/50 text-gray-200 disabled:opacity-50"
            placeholder="종료일"
          />
        </div>
      </div>
      
      {/* 빠른 설정 버튼 - 필요할 때만 표시 */}
      {showQuickButtons && (
        <div className="flex space-x-1 mt-2">
          <button
            type="button"
            onClick={() => {
              const today = new Date();
              const start = new Date(today.getFullYear(), today.getMonth(), 1);
              const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
              
              onStartDateChange({ target: { value: start.toISOString().split('T')[0] } });
              onEndDateChange({ target: { value: end.toISOString().split('T')[0] } });
            }}
            className="px-2 py-1 text-xs bg-emerald-600/20 text-emerald-300 rounded hover:bg-emerald-600/30 transition-colors border border-emerald-500/30"
          >
            이번달
          </button>
          
          <button
            type="button"
            onClick={() => {
              const today = new Date();
              const start = new Date(today.getFullYear(), 0, 1);
              const end = new Date(today.getFullYear(), 11, 31);
              
              onStartDateChange({ target: { value: start.toISOString().split('T')[0] } });
              onEndDateChange({ target: { value: end.toISOString().split('T')[0] } });
            }}
            className="px-2 py-1 text-xs bg-purple-600/20 text-purple-300 rounded hover:bg-purple-600/30 transition-colors border border-purple-500/30"
          >
            올해
          </button>
        </div>
      )}
    </div>
  );
};

// 필터 액션 버튼 (간소화됨)
const FilterActions = ({ onApply, showApply = false, className = "" }) => (
  <div className={`flex space-x-3 pt-2 ${className}`}>
    {showApply && (
      <Button 
        onClick={onApply}
        variant="primary"
        size="sm"
        className="flex-1"
      >
        적용
      </Button>
    )}
  </div>
);

// 세금 필터 패널 컴포넌트 (깔끔하게 정리된 버전)
const TaxFiltersPanel = ({ 
  globalFilters, 
  setGlobalFilters, 
  resetFilters, 
  setVisibleCounts, 
  isMobile, 
  showMobileFilters, 
  setShowMobileFilters 
}) => {
  const handleFilterChange = (field, value) => {
    setGlobalFilters(prev => ({ ...prev, [field]: value }));
  };

  const categoryOptions = [
    { value: 'all', label: '전체 분류' },
    { value: '취득세', label: '취득세' },
    { value: '재산세', label: '재산세' },
    { value: '기타세', label: '기타세' }
  ];

  // 모바일 버전
  if (isMobile) {
    return (
      <div className={`${CARD_STYLES} overflow-hidden mb-6`}>
        <div className="p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-medium text-gray-300">필터 설정</h3>
            <Button
              onClick={() => setShowMobileFilters(!showMobileFilters)}
              variant="primary"
              size="sm"
              icon={showMobileFilters ? ChevronLeft : ChevronRight}
              iconPosition="left"
            >
              {showMobileFilters ? '접기' : '펼치기'}
            </Button>
          </div>
          
          {showMobileFilters && (
            <div className="border-t border-slate-600/30 pt-4 space-y-3">
              <DateRangeFilter
                startDate={globalFilters.startDate}
                endDate={globalFilters.endDate}
                onStartDateChange={(e) => handleFilterChange('startDate', e.target.value)}
                onEndDateChange={(e) => handleFilterChange('endDate', e.target.value)}
                showQuickButtons={false}
              />

              <FilterInput
                type="select"
                label="세금 분류"
                value={globalFilters.category}
                onChange={(e) => handleFilterChange('category', e.target.value)}
                options={categoryOptions}
              />

              <FilterInput
                type="text"
                label="충전소 검색"
                value={globalFilters.stationSearch}
                onChange={(e) => handleFilterChange('stationSearch', e.target.value)}
                placeholder="충전소명이나 주소로 검색..."
              />

              <Button
                onClick={() => setShowMobileFilters(false)}
                variant="primary"
                size="sm"
                className="w-full"
              >
                적용
              </Button>
            </div>
          )}
        </div>
      </div>
    );
  }

  // 데스크톱 버전 - 완전히 새로 정리
  return (
    <div className={`${CARD_STYLES} overflow-hidden mb-6`}>
      <div className="p-6">
        <div className="grid grid-cols-12 gap-4 items-end">
          {/* 조회 기간 */}
          <div className="col-span-4">
            <label className="block text-sm font-medium text-gray-300 mb-2">조회 기간</label>
            <div className="grid grid-cols-2 gap-2">
              <input
                type="date"
                value={globalFilters.startDate}
                onChange={(e) => handleFilterChange('startDate', e.target.value)}
                className="w-full h-10 px-3 border rounded-lg text-sm bg-slate-700/50 border-slate-600/50 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent"
              />
              <input
                type="date"
                value={globalFilters.endDate}
                onChange={(e) => handleFilterChange('endDate', e.target.value)}
                className="w-full h-10 px-3 border rounded-lg text-sm bg-slate-700/50 border-slate-600/50 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent"
              />
            </div>
          </div>

          {/* 세금 분류 */}
          <div className="col-span-3">
            <label className="block text-sm font-medium text-gray-300 mb-2">세금 분류</label>
            <select 
              value={globalFilters.category}
              onChange={(e) => handleFilterChange('category', e.target.value)}
              className="w-full h-10 px-3 border rounded-lg text-sm bg-slate-700/50 border-slate-600/50 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent"
            >
              {categoryOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* 충전소 검색 */}
          <div className="col-span-5">
            <label className="block text-sm font-medium text-gray-300 mb-2">충전소 검색</label>
            <input
              type="text"
              value={globalFilters.stationSearch}
              onChange={(e) => handleFilterChange('stationSearch', e.target.value)}
              placeholder="충전소명이나 주소로 검색..."
              className="w-full h-10 px-3 border rounded-lg text-sm bg-slate-700/50 border-slate-600/50 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent"
            />
          </div>
        </div>
      </div>
    </div>
  );
};
// 충전소 필터 패널 컴포넌트 (정리된 버전)
const StationFiltersPanel = ({ 
  filters, 
  onFiltersChange, 
  onReset,
  isMobile, 
  showMobileFilters, 
  setShowMobileFilters 
}) => {
  // 필터 변경 핸들러
  const handleFilterChange = (field, value) => {
    onFiltersChange(prev => ({ 
      ...prev, 
      [field]: value,
      // 날짜 필터가 'missing'일 때 날짜 범위 초기화
      ...(field === 'dateFilter' && value === 'missing' && {
        startDate: '',
        endDate: ''
      })
    }));
  };

  // 필터 초기화
  const handleReset = () => {
    onReset();
    if (isMobile) {
      setShowMobileFilters(false);
    }
  };

  // 모바일 버전
  if (isMobile) {
    return (
      <div className={`${CARD_STYLES} overflow-hidden mb-6`}>
        <div className="p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-medium text-gray-300">필터 설정</h3>
            <Button
              onClick={() => setShowMobileFilters(!showMobileFilters)}
              variant="primary"
              size="sm"
              icon={showMobileFilters ? ChevronLeft : ChevronRight}
              iconPosition="left"
            >
              {showMobileFilters ? '접기' : '펼치기'}
            </Button>
          </div>
          
          {showMobileFilters && (
            <div className="border-t border-slate-600/30 pt-4 space-y-3">
              <FilterInput
                type="select"
                label="날짜 필터"
                value={filters.dateFilter}
                onChange={(e) => handleFilterChange('dateFilter', e.target.value)}
                options={StationFilterSystem.dateFilterOptions}
              />

              <DateRangeFilter
                startDate={filters.startDate}
                endDate={filters.endDate}
                onStartDateChange={(e) => handleFilterChange('startDate', e.target.value)}
                onEndDateChange={(e) => handleFilterChange('endDate', e.target.value)}
                disabled={filters.dateFilter === 'missing'}
              />

              <FilterInput
                type="select"
                label="운영 상태"
                value={filters.status}
                onChange={(e) => handleFilterChange('status', e.target.value)}
                options={StationFilterSystem.statusOptions}
              />

              <FilterInput
                type="text"
                label="충전소 검색"
                value={filters.search}
                onChange={(e) => handleFilterChange('search', e.target.value)}
                placeholder="충전소명이나 주소로 검색..."
              />

              <Button
                onClick={() => setShowMobileFilters(false)}
                variant="primary"
                size="sm"
                className="w-full"
              >
                적용
              </Button>
            </div>
          )}
        </div>
      </div>
    );
  }

  // 데스크톱 버전 - 깔끔하게 정리
  return (
    <div className={`${CARD_STYLES} overflow-hidden mb-6`}>
      <div className="p-6">
        <div className="grid grid-cols-12 gap-4 items-end">
          {/* 날짜 필터 */}
          <div className="col-span-2">
            <label className="block text-sm font-medium text-gray-300 mb-2">날짜 필터</label>
            <select 
              value={filters.dateFilter}
              onChange={(e) => handleFilterChange('dateFilter', e.target.value)}
              className="w-full h-10 px-3 border rounded-lg text-sm bg-slate-700/50 border-slate-600/50 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent"
            >
              {StationFilterSystem.dateFilterOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* 날짜 범위 - 기간 설정 */}
          <div className="col-span-3">
            <label className="block text-sm font-medium text-gray-300 mb-2">기간 설정</label>
            <div className="grid grid-cols-2 gap-2">
              <input
                type="date"
                value={filters.startDate}
                onChange={(e) => handleFilterChange('startDate', e.target.value)}
                disabled={filters.dateFilter === 'missing'}
                className="w-full h-10 px-3 border rounded-lg text-sm transition-all focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent bg-slate-700/50 border-slate-600/50 text-gray-200 disabled:opacity-50"
              />
              <input
                type="date"
                value={filters.endDate}
                onChange={(e) => handleFilterChange('endDate', e.target.value)}
                disabled={filters.dateFilter === 'missing'}
                className="w-full h-10 px-3 border rounded-lg text-sm transition-all focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent bg-slate-700/50 border-slate-600/50 text-gray-200 disabled:opacity-50"
              />
            </div>
          </div>

          {/* 운영 상태 */}
          <div className="col-span-2">
            <label className="block text-sm font-medium text-gray-300 mb-2">운영 상태</label>
            <select 
              value={filters.status}
              onChange={(e) => handleFilterChange('status', e.target.value)}
              className="w-full h-10 px-3 border rounded-lg text-sm bg-slate-700/50 border-slate-600/50 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent"
            >
              {StationFilterSystem.statusOptions.map(option => (
                <option key={option.value} value={option.value}>
                  {option.label}
                </option>
              ))}
            </select>
          </div>

          {/* 충전소 검색 */}
          <div className="col-span-5">
            <label className="block text-sm font-medium text-gray-300 mb-2">충전소 검색</label>
            <input
              type="text"
              value={filters.search}
              onChange={(e) => handleFilterChange('search', e.target.value)}
              placeholder="충전소명이나 주소로 검색..."
              className="w-full h-10 px-3 border rounded-lg text-sm bg-slate-700/50 border-slate-600/50 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-transparent"
            />
          </div>


        </div>
      </div>
    </div>
  );
};
// 통합 타이포그래피 시스템 정의 (Button 컴포넌트 외부로 이동)
const getTypographySystem = (isMobile) => ({
  // 기본 텍스트 레벨 (5단계 체계)
  caption: isMobile ? 'text-sm' : 'text-xs',     // 12px/14px - 캡션, 라벨
  body: isMobile ? 'text-base' : 'text-sm',      // 14px/16px - 기본 텍스트
  subtitle: isMobile ? 'text-lg' : 'text-base',  // 16px/18px - 부제목
  title: isMobile ? 'text-xl' : 'text-lg',       // 18px/20px - 제목
  heading: isMobile ? 'text-2xl' : 'text-xl',    // 20px/24px - 헤딩
  
  // 특수 용도 (2단계 추가)
  display: isMobile ? 'text-3xl' : 'text-2xl',   // 24px/30px - 메인 제목
  hero: isMobile ? 'text-4xl' : 'text-3xl'       // 30px/36px - 히어로 텍스트
});

const Button = ({ 
  children, 
  variant = 'primary', 
  size = 'md', 
  disabled = false, 
  loading = false,
  icon: IconComponent,
  iconPosition = 'left',
  className = '',
  ...props 
}) => {
  const { isMobile } = useBreakpoint();
  
  // 타이포그래피 시스템 가져오기
  const TYPOGRAPHY = getTypographySystem(isMobile);

  // 버튼 변형별 스타일
  const variants = {
    primary: 'bg-gradient-to-r from-slate-700 to-slate-600 hover:from-slate-600 hover:to-slate-500 text-white shadow-lg hover:shadow-slate-500/25',
    secondary: 'bg-slate-600/20 text-slate-300 border border-slate-500/30 hover:bg-slate-600/30 hover:text-slate-200',
    accent: 'bg-gradient-to-r from-slate-800 to-slate-700 hover:from-slate-700 hover:to-slate-600 text-white shadow-lg hover:shadow-slate-600/25',
    danger: 'bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white shadow-lg hover:shadow-red-500/25',
    success: 'bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white shadow-lg hover:shadow-emerald-500/25',
    ghost: 'text-slate-300 hover:text-slate-200 hover:bg-slate-700/30',
    outline: 'border border-slate-600/50 text-slate-300 hover:bg-slate-700/30 hover:text-slate-200'
  };
  
  // 크기별 스타일 (통합 타이포그래피 시스템 사용)
  const sizes = {
    sm: `px-3 py-2 ${TYPOGRAPHY.caption}`,
    md: `px-4 py-2 ${TYPOGRAPHY.body}`, 
    lg: `px-5 py-3 ${TYPOGRAPHY.subtitle}`,
    xl: `px-6 py-4 ${TYPOGRAPHY.title}`
  };
  
  // 아이콘 크기 (버튼 사이즈와 매핑)
  const iconSizes = {
    sm: 'w-3 h-3',
    md: 'w-4 h-4', 
    lg: 'w-5 h-5',
    xl: 'w-6 h-6'
  };
  
  const baseStyles = `
    inline-flex items-center justify-center font-medium rounded-xl 
    transition-all duration-200 
    focus:outline-none focus:ring-2 focus:ring-slate-500/50 
    disabled:opacity-50 disabled:cursor-not-allowed
    hover:transform hover:-translate-y-0.5 active:transform active:translate-y-0
    ${sizes[size]} 
    ${variants[variant]} 
    ${className}
  `;
  
  return (
    <button
      className={baseStyles}
      disabled={disabled || loading}
      {...props}
    >
      {loading && (
        <div className={`animate-spin rounded-full border-2 border-current border-t-transparent mr-2 ${iconSizes[size]}`}></div>
      )}
      {IconComponent && iconPosition === 'left' && !loading && (
        <IconComponent className={`${iconSizes[size]} ${children ? 'mr-2' : ''}`} />
      )}
      {children}
      {IconComponent && iconPosition === 'right' && !loading && (
        <IconComponent className={`${iconSizes[size]} ${children ? 'ml-2' : ''}`} />
      )}
    </button>
  );
};

// 아이콘 버튼 컴포넌트 (아이콘만)
const IconButton = ({ icon: IconComponent, size = 'md', variant = 'ghost', title, ...props }) => {
  return (
    <Button
      variant={variant}
      size={size}
      icon={IconComponent}
      title={title}
      className="!p-2 !aspect-square"
      {...props}
    />
  );
};
const useBreakpoint = () => {
  const [breakpoint, setBreakpoint] = useState('desktop');
  
  useEffect(() => {
    const updateBreakpoint = () => {
      const width = window.innerWidth;
      if (width < 768) {
        setBreakpoint('mobile');
      } else if (width < 1024) {
        setBreakpoint('tablet');
      } else {
        setBreakpoint('desktop');
      }
    };
    
    updateBreakpoint();
    window.addEventListener('resize', updateBreakpoint);
    return () => window.removeEventListener('resize', updateBreakpoint);
  }, []);
  
  return {
    breakpoint,
    isMobile: breakpoint === 'mobile',
    isTablet: breakpoint === 'tablet',
    isDesktop: breakpoint === 'desktop',
    isMobileOrTablet: breakpoint === 'mobile' || breakpoint === 'tablet'
  };
};

  const useBills = (initialBills) => {
  const [bills, setBills] = useState(initialBills); // localStorage 사용 중단
  
  // bills가 변경될 때마다 localStorage에 저장 (디바운스 적용) - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      console.log('=== localStorage 저장 시도 ===');
      console.log('저장할 bills 개수:', bills.length);
      console.log('bills 데이터 샘플:', bills.slice(0, 2));
      
      const success = storageUtils.save('tax_bills', bills);
      console.log('localStorage 저장 결과:', success ? '성공' : '실패');
      
      if (success) {
        // 저장 확인을 위해 다시 읽어보기
        const saved = storageUtils.load('tax_bills', []);
        console.log('저장 확인 - 읽어온 데이터 개수:', saved.length);
      }
      console.log('=== localStorage 저장 완료 ===');
    }, 100); // 100ms 디바운스
    
    return () => clearTimeout(timeoutId);
  }, [bills]);
  */
  
  const updateBillStatus = useCallback((id, newStatus) => {
    setBills(prev => prev.map(bill => {
      if (bill.id === id) {
        const updatedBill = { ...bill, status: newStatus };
        
        // 완료 상태로 변경 시 완료일 기록 (한국 시간 기준)
        if (newStatus === 'completed') {
          updatedBill.completedDate = koreaTimeUtils.getKoreaToday();
        }
        // 완료 상태에서 다른 상태로 변경 시 완료일 삭제
        else if (bill.status === 'completed') {
          updatedBill.completedDate = null;
        }
        
        return updatedBill;
      }
      return bill;
    }));
  }, []);

  const addBill = useCallback((newBill) => {
    return new Promise((resolve, reject) => {
      try {
        console.log('=== addBill 함수 시작 ===');
        console.log('받은 newBill:', newBill);
        console.log('현재 bills 상태:', bills);
        console.log('bills 배열 길이:', bills.length);
        
        // 입력 데이터 검증
        if (!newBill || !newBill.name || !newBill.dueDate || !newBill.category || !newBill.stationName) {
          console.error('addBill: 필수 필드 누락', {
            newBill: !!newBill,
            name: !!newBill?.name,
            dueDate: !!newBill?.dueDate,
            category: !!newBill?.category,
            stationName: !!newBill?.stationName
          });
          reject(new Error('필수 정보가 누락되었습니다.'));
          return;
        }

        if (newBill.isRecurring && (newBill.category === '재산세' || newBill.category === '기타세')) {
          console.log('반복 납부 세금 생성 시작');
          
          // 반복 납부 설정 시 향후 5년치 자동 생성
          const newBills = [];
          const baseDate = new Date(newBill.dueDate);
          const recurringGroupId = Date.now();
          
          for (let i = 0; i < 6; i++) { // 현재 연도 + 5년
            const yearDate = new Date(baseDate);
            yearDate.setFullYear(baseDate.getFullYear() + i);
            
            const bill = {
              id: Date.now() + i + Math.random() * 1000, // 고유 ID 보장
              ...newBill,
              dueDate: yearDate.toISOString().split('T')[0],
              amount: i === 0 ? newBill.amount : '미정', // 첫 번째만 입력 금액, 나머지는 미정
              // 반복 납부 시 미래 세금들은 납부 예정으로 설정
              status: i === 0 ? newBill.status : (newBill.category === '취득세' ? 'accounting_review' : 'pending'),
              uploadedAt: koreaTimeUtils.getKoreaToday(),
              completedDate: i === 0 && newBill.status === 'completed' ? newBill.completedDate : null,
              isRecurring: true,
              recurringGroup: recurringGroupId, // 반복 그룹 식별자
              isOriginal: i === 0 // 원본 여부
            };
            newBills.push(bill);
            console.log(`반복 납부 ${i + 1}번째 생성:`, bill);
          }
          
          console.log('setBills 호출 전 bills 상태:', bills.length);
          console.log('추가할 bills:', newBills.length);
          
          setBills(prevBills => {
            console.log('setBills 콜백 실행 - prevBills:', prevBills.length);
            const updatedBills = [...prevBills, ...newBills];
            console.log('반복 납부 bills 업데이트:', {
              이전개수: prevBills.length,
              추가개수: newBills.length,
              최종개수: updatedBills.length
            });
            
            // 즉시 localStorage에도 저장 (강제)
            try {
              const success = storageUtils.save('tax_bills', updatedBills);
              console.log('즉시 localStorage 저장 결과:', success);
              
              // 저장 확인
              const saved = storageUtils.load('tax_bills', []);
              console.log('저장 확인 - 읽어온 데이터 개수:', saved.length);
              
              resolve(true); // 성공 시 resolve
            } catch (storageError) {
              console.error('localStorage 저장 실패:', storageError);
              reject(storageError);
            }
            
            return updatedBills;
          });
          
          console.log(`반복 납부 ${newBills.length}개 생성 완료`);
          
        } else {
          console.log('일반 납부 세금 생성 시작');
          
          // 일반 납부 또는 취득세
          const bill = {
            id: Date.now() + Math.random() * 1000, // 고유 ID 보장
            ...newBill, 
            uploadedAt: koreaTimeUtils.getKoreaToday(),
            completedDate: null,
            isRecurring: false
          };
          
          console.log('일반 납부 bill 생성:', bill);
          console.log('setBills 호출 전 bills 상태:', bills.length);
          
          setBills(prevBills => {
            console.log('setBills 콜백 실행 - prevBills:', prevBills.length);
            const updatedBills = [...prevBills, bill];
            console.log('일반 납부 bills 업데이트:', {
              이전개수: prevBills.length,
              추가된bill: bill,
              최종개수: updatedBills.length
            });
            
            // 즉시 localStorage에도 저장 (강제)
            try {
              const success = storageUtils.save('tax_bills', updatedBills);
              console.log('즉시 localStorage 저장 결과:', success);
              
              // 저장 확인
              const saved = storageUtils.load('tax_bills', []);
              console.log('저장 확인 - 읽어온 데이터 개수:', saved.length);
              
              resolve(true); // 성공 시 resolve
            } catch (storageError) {
              console.error('localStorage 저장 실패:', storageError);
              reject(storageError);
            }
            
            return updatedBills;
          });
          
          console.log('일반 납부 생성 완료');
        }
      } catch (error) {
        console.error('❌ addBill 실행 중 오류:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          newBill: newBill
        });
        reject(error); // 에러 시 reject
      }
    });
  }, [bills, setBills]);

  const updateBill = useCallback((id, updatedBill) => {
    setBills(prev => prev.map(bill => {
      if (bill.id === id) {
        const updated = { ...bill, ...updatedBill };
        
        // 반복 납부 설정 변경 시 처리
        if (bill.isOriginal && updatedBill.hasOwnProperty('isRecurring')) {
          if (updatedBill.isRecurring && !bill.isRecurring) {
            // 반복 켜기: 미래 납부 생성
            const baseDate = new Date(updated.dueDate);
            const newBills = [];
            
            for (let i = 1; i < 6; i++) { // 내년부터 5년
              const yearDate = new Date(baseDate);
              yearDate.setFullYear(baseDate.getFullYear() + i);
              
              const futureBill = {
                id: Date.now() + i,
                ...updated,
                dueDate: yearDate.toISOString().split('T')[0],
                amount: '미정',
                isRecurring: true,
                recurringGroup: bill.recurringGroup || Date.now(),
                isOriginal: false
              };
              newBills.push(futureBill);
            }
            
            setTimeout(() => {
              setBills(prev => [...prev, ...newBills]);
            }, 0);
          } else if (!updatedBill.isRecurring && bill.isRecurring) {
            // 반복 끄기: 미래 납부 삭제
            setTimeout(() => {
              setBills(prev => prev.filter(b => 
                !(b.recurringGroup === bill.recurringGroup && !b.isOriginal)
              ));
            }, 0);
          }
        }
        
        return updated;
      }
      return bill;
    }));
  }, []);

  const deleteBill = useCallback((id) => {
    setBills(prev => {
      const billToDelete = prev.find(bill => bill.id === id);
      
      if (billToDelete?.isRecurring && billToDelete?.isOriginal) {
        // 원본 삭제 시 관련된 모든 반복 납부 삭제
        return prev.filter(bill => bill.recurringGroup !== billToDelete.recurringGroup);
      } else {
        // 일반 삭제
        return prev.filter(bill => bill.id !== id);
      }
    });
  }, []);

  return { bills, setBills, updateBillStatus, addBill, updateBill, deleteBill };
};

const useStations = (initialStations) => {
  const [stations, setStations] = useState(initialStations); // localStorage 사용 중단
  
  // stations가 변경될 때마다 localStorage에 저장 - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    storageUtils.save('charging_stations', stations);
  }, [stations]);
  */
  
  const addStation = useCallback((newStation) => {
    const stationWithDate = {
      ...newStation,
      registeredDate: newStation.registeredDate || koreaTimeUtils.getKoreaToday()
    };
    setStations(prev => [stationWithDate, ...prev]);
  }, []);

  const updateStation = useCallback((oldName, updatedStation) => {
    setStations(prev => prev.map(station => 
      station.name === oldName ? updatedStation : station
    ));
  }, []);

  const deleteStation = useCallback((name) => {
    setStations(prev => prev.filter(station => station.name !== name));
  }, []);

  return { stations, setStations, addStation, updateStation, deleteStation };
};

const useFilters = () => {
  const [globalFilters, setGlobalFilters] = useState({ 
    category: 'all', 
    stationSearch: '', 
    startDate: '',
    endDate: ''
  });
  const [filters, setFilters] = useState({ sortBy: 'dueDate', sortOrder: 'asc' });
  const [stationFilters, setStationFilters] = useState({
    search: '',
    status: 'all',
    dateFilter: 'all', // all, approval, safety, missing
    startDate: '',
    endDate: ''
  });

  const resetFilters = useCallback(() => {
    // 기본 3개월 기간으로 재설정
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();
    
    // 전월 1일 ~ 다음달 마지막 날
    const startDate = new Date(currentYear, currentMonth - 1, 1);
    const endDate = new Date(currentYear, currentMonth + 2, 0);
    
    setGlobalFilters({ 
      category: 'all', 
      stationSearch: '', 
      startDate: startDate.toISOString().split('T')[0],
      endDate: endDate.toISOString().split('T')[0]
    });
  }, []);

  const resetStationFilters = useCallback(() => {
    setStationFilters({ 
      search: '', 
      status: 'all',
      dateFilter: 'all',
      startDate: '',
      endDate: ''
    });
  }, []);

  return { 
    globalFilters, setGlobalFilters, filters, setFilters, resetFilters,
    stationFilters, setStationFilters, resetStationFilters
  };
};

const useTrash = () => {
  const [trash, setTrash] = useState([]); // localStorage 사용 중단

  // trash가 변경될 때마다 localStorage에 저장 - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    storageUtils.save('trash_items', trash);
  }, [trash]);
  */

  useEffect(() => {
    const cleanupTrash = () => {
      const now = koreaTimeUtils.getKoreaTime();
      setTrash(prev => {
        const cleaned = prev.filter(item => {
          const deletedDate = new Date(item.deletedAt);
          const daysDiff = (now - deletedDate) / (1000 * 60 * 60 * 24);
          return daysDiff < 3;
        });
        return cleaned;
      });
    };
    cleanupTrash();
    const interval = setInterval(cleanupTrash, 24 * 60 * 60 * 1000);
    return () => clearInterval(interval);
  }, []);

  const moveToTrash = useCallback((item) => {
    setTrash(prev => [...prev, { ...item, deletedAt: koreaTimeUtils.getKoreaTime().toISOString() }]);
  }, []);

  const restoreFromTrash = useCallback((trashItem) => {
    setTrash(prev => prev.filter(item => item.id !== trashItem.id));
    const { deletedAt, ...restoredItem } = trashItem;
    return restoredItem;
  }, []);

  const permanentDelete = useCallback((id) => {
    setTrash(prev => prev.filter(item => item.id !== id));
  }, []);

  const emptyTrash = useCallback(() => setTrash([]), []);

  return { trash, moveToTrash, restoreFromTrash, permanentDelete, emptyTrash };
};

// 컴포넌트들
const CategoryBadge = ({ category }) => (
  <span className={`px-2 py-1 rounded-lg text-xs font-medium border ${CATEGORY_STYLES[category] || CATEGORY_STYLES['기타세']}`}>
    {category}
  </span>
);

const Modal = ({ isOpen, onClose, title, children, size = 'md', heightMode = 'auto' }) => {
  if (!isOpen) return null;

  const sizeClasses = {
    sm: 'max-w-md',
    md: 'max-w-md',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl'
  };

  // 높이 모드별 클래스 설정
  const heightClasses = {
    auto: 'max-h-[90vh]', // 내용에 따라 자동 조절 (최대 90vh)
    fixed: 'h-[80vh]',    // 고정 높이
    fullscreen: 'h-[95vh]' // 거의 전체 화면
  };

  return (
    <div className={MODAL_STYLES}>
      <div className={`bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-2xl w-full ${sizeClasses[size]} border border-slate-700/50 ${heightClasses[heightMode]} flex flex-col overflow-hidden m-4`}>
        {/* 고정 헤더 */}
        <div className="flex justify-between items-center p-6 pb-4 border-b border-slate-700/50 flex-shrink-0">
          <h2 className="text-lg font-medium text-gray-100">{title}</h2>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-200 transition-colors flex-shrink-0">
            <X className="w-5 h-5" />
          </button>
        </div>
        
        {/* 콘텐츠 영역 */}
        <div className="flex-1 overflow-y-auto custom-scrollbar p-6 pt-4 min-h-0">
          {children}
        </div>
      </div>
    </div>
  );
};

const BillCard = React.memo(({ bill, onStatusChange, onClick }) => {
  const daysLeft = utils.getDaysUntilDue(bill.dueDate);
  const isOverdue = daysLeft < 0 && bill.status === 'pending';
  
  const cardStyle = bill.status === 'completed' 
    ? "bg-gradient-to-br from-gray-900/30 to-gray-800/20 backdrop-blur-md rounded-lg shadow-md p-3 mb-2 group hover:shadow-gray-500/20 hover:shadow-lg transition-all duration-300 border border-gray-500/20" + (onClick ? " cursor-pointer" : "")
    : `bg-gradient-to-br backdrop-blur-md rounded-lg shadow-md p-3 mb-2 hover:shadow-lg transition-all duration-300 border ${isOverdue ? 'from-red-900/40 to-red-800/30 border-red-500/30 hover:shadow-red-500/20' : 'from-slate-800/50 to-slate-700/30 border-slate-600/30 hover:shadow-slate-500/20'}` + (onClick ? " cursor-pointer" : "");

  return (
    <div onClick={onClick} className={cardStyle}>
      {bill.status === 'completed' ? (
        // 완료된 카드 - 콤팩트 버전
        <>
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center space-x-2">
              <CategoryBadge category={bill.category} />
              <h3 className="font-medium text-gray-100 text-xs truncate max-w-[120px]">{bill.name}</h3>
              {bill.isRecurring && !bill.isOriginal && (
                <span className="text-xs px-1.5 py-0.5 bg-blue-500/20 text-blue-300 rounded border border-blue-500/30">🔗</span>
              )}
            </div>
          </div>
          
          <div className="text-xs text-gray-300 mb-1 font-medium truncate">{bill.stationName}</div>
          
          {bill.completedDate && (
            <div className="text-xs text-gray-300 flex items-center mb-1">
              <CheckCircle className="w-3 h-3 mr-1" />
              {bill.completedDate} 완료
            </div>
          )}
          
          <div className="text-xs text-gray-400 mb-2 font-mono">₩ {utils.formatAmount(bill.amount)}</div>
          
          {onStatusChange && (
            <div className="opacity-0 group-hover:opacity-100 transition-opacity">
              <div className="flex justify-end space-x-1">
                <button onClick={(e) => { e.stopPropagation(); onStatusChange(bill.id, 'pending'); }} className="text-xs bg-blue-600/50 text-blue-200 px-2 py-1 rounded hover:bg-blue-500/50 transition-colors backdrop-blur-sm">
                  예정으로
                </button>
                {bill.category === '취득세' && (
                  <button onClick={(e) => { e.stopPropagation(); onStatusChange(bill.id, 'accounting_review'); }} className="text-xs bg-amber-600/50 text-amber-200 px-2 py-1 rounded hover:bg-amber-500/50 transition-colors backdrop-blur-sm">
                    검토로
                  </button>
                )}
              </div>
            </div>
          )}
        </>
      ) : (
        // 예정/검토 카드 - 콤팩트 버전
        <>
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center space-x-2 flex-1 min-w-0">
              <CategoryBadge category={bill.category} />
              <h3 className="font-medium text-gray-100 text-xs truncate">{bill.name}</h3>
              {bill.isRecurring && (
                <span className="text-xs px-1.5 py-0.5 bg-blue-500/20 text-blue-300 rounded border border-blue-500/30 flex-shrink-0">
                  {bill.isOriginal ? '🔄' : '🔗'}
                </span>
              )}
            </div>
            {isOverdue && <span className="bg-red-500/30 text-red-200 px-1.5 py-0.5 rounded text-xs font-medium border border-red-500/50 flex-shrink-0">지연</span>}
          </div>
          
          <div className="text-xs text-gray-300 mb-1 font-medium truncate">{bill.stationName}</div>
          <div className="text-xs text-gray-400 mb-1 truncate">{bill.address}</div>
          
          <div className="flex items-center space-x-2 mb-1">
            <Calendar className="w-3 h-3 text-gray-400 flex-shrink-0" />
            <span className="text-xs text-gray-300">{bill.dueDate}</span>
          </div>
          
          <div className="text-xs text-gray-400 mb-2 font-mono">₩ {utils.formatAmount(bill.amount)}</div>
          
          {onStatusChange && (
            <div className="flex justify-end">
              <div className="flex space-x-1">
                {bill.status === 'pending' && (
                  bill.category === '취득세' ? (
                    <>
                      <button onClick={(e) => { e.stopPropagation(); onStatusChange(bill.id, 'accounting_review'); }} className="bg-gradient-to-r from-amber-600 to-amber-500 text-white px-2 py-1 rounded text-xs hover:from-amber-500 hover:to-amber-400 transition-all duration-200 shadow">
                        검토
                      </button>
                      <button onClick={(e) => { e.stopPropagation(); onStatusChange(bill.id, 'completed'); }} className="bg-gradient-to-r from-emerald-600 to-emerald-500 text-white px-2 py-1 rounded text-xs hover:from-emerald-500 hover:to-emerald-400 transition-all duration-200 shadow">
                        완료
                      </button>
                    </>
                  ) : (
                    <button onClick={(e) => { e.stopPropagation(); onStatusChange(bill.id, 'completed'); }} className="bg-gradient-to-r from-emerald-600 to-emerald-500 text-white px-2 py-1 rounded text-xs hover:from-emerald-500 hover:to-emerald-400 transition-all duration-200 shadow">
                      완료
                    </button>
                  )
                )}
                {bill.status === 'accounting_review' && (
                  <>
                    {bill.category === '취득세' && (bill.amount === '미정' || bill.amount === '' || !bill.amount) ? (
                      // 취득세이면서 금액이 미정인 경우 - 금액 입력 필요 안내
                      <div className="bg-amber-900/20 border border-amber-500/30 rounded px-2 py-1 text-xs">
                        <div className="text-amber-200 font-medium mb-1">금액 입력 필요</div>
                        <div className="text-amber-300 text-xs">금액을 입력해야 다음 단계로 진행할 수 있습니다</div>
                      </div>
                    ) : (
                      // 일반적인 완료 버튼
                      <button onClick={(e) => { e.stopPropagation(); onStatusChange(bill.id, 'pending'); }} className="bg-gradient-to-r from-blue-600 to-blue-500 text-white px-2 py-1 rounded text-xs hover:from-blue-500 hover:to-blue-400 transition-all duration-200 shadow">
                        완료
                      </button>
                    )}
                  </>
                )}
              </div>
            </div>
          )}
        </>
      )}
    </div>
  );
});

const StatsCard = ({ title, value, subtitle, icon, color }) => {
  const IconComponent = icon;
  return (
    <div className={`bg-gradient-to-br from-${color}-900/20 to-${color}-800/10 backdrop-blur-md rounded-2xl p-6 border border-${color}-600/30`}>
      <div className="flex items-center justify-between mb-4">
        <div className={`p-3 bg-${color}-500/20 rounded-xl`}>
          <IconComponent className={`w-6 h-6 text-${color}-400`} />
        </div>
        <span className={`text-xs text-${color}-300 font-medium`}>{subtitle}</span>
      </div>
      <div className="text-2xl font-bold text-gray-100 mb-1">{value}</div>
      <div className="text-sm text-gray-400">{title}</div>
    </div>
  );
};

const TaxManagementApp = () => {
  // 로그인 상태 관리 - Vercel 배포용 localStorage 비활성화
  const [isLoggedIn, setIsLoggedIn] = useState(false); // 기본값으로 초기화
  const [currentUserId, setCurrentUserId] = useState(null); // 기본값으로 초기화
  const [loginForm, setLoginForm] = useState({ email: '', password: '' });

  // 로그인 상태 변경 시 localStorage에 저장 - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    storageUtils.save('is_logged_in', isLoggedIn);
  }, [isLoggedIn]);

  useEffect(() => {
    storageUtils.save('current_user_id', currentUserId);
  }, [currentUserId]);
  */
  const [isLoggingIn, setIsLoggingIn] = useState(false);
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  const [forgotPasswordEmail, setForgotPasswordEmail] = useState('');
  const [forgotPasswordSent, setForgotPasswordSent] = useState(false);
  const [loginError, setLoginError] = useState('');

  // 초기 데이터
  const initialBills = [];

  const initialStations = [];

  const { bills, setBills, updateBillStatus, addBill, updateBill, deleteBill } = useBills(initialBills);
  const { breakpoint, isMobile, isTablet, isDesktop, isMobileOrTablet } = useBreakpoint();
  const { stations, setStations, addStation, updateStation, deleteStation } = useStations(initialStations);
  const { globalFilters, setGlobalFilters, filters, setFilters, resetFilters, stationFilters, setStationFilters, resetStationFilters } = useFilters();


  useEffect(() => {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    const sixtyDaysLater = new Date(today);
    sixtyDaysLater.setDate(today.getDate() + 60);
    
    if (!globalFilters.startDate && !globalFilters.endDate) {
      setGlobalFilters(prev => ({
        ...prev,
        startDate: thirtyDaysAgo.toISOString().split('T')[0],
        endDate: sixtyDaysLater.toISOString().split('T')[0]
      }));
    }
  }, []);
  const { trash, moveToTrash, restoreFromTrash, permanentDelete, emptyTrash } = useTrash();

  // 상태들 - 로그인 상태에 따른 초기 뷰 설정
  const [currentView, setCurrentView] = useState(() => {
    const savedLoginState = storageUtils.load('is_logged_in', false);
    return savedLoginState ? 'dashboard' : 'login';
  });
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [showMobileSidebar, setShowMobileSidebar] = useState(false);
  const [isToggleHovered, setIsToggleHovered] = useState(false);
  const [showMobileFilters, setShowMobileFilters] = useState(false);
  
  // SendGrid 이메일 설정 상태
  const [sendGridForm, setSendGridForm] = useState(() => ({
    apiKey: '',
    fromEmail: 'noreply@watercharging.com',
    fromName: 'Water TT 관리시스템'
  }));
  const [isUpdatingSendGrid, setIsUpdatingSendGrid] = useState(false);
  const [isSendingTestEmail, setIsSendingTestEmail] = useState(false);
  const [testEmailAddress, setTestEmailAddress] = useState('');
  
  // 계정 관리 상태 - 운영용 (계정은 수동으로 생성해야 함) - Vercel 배포용 localStorage 비활성화
  const [accounts, setAccounts] = useState(() => {
    // localStorage 사용 중단, 기본 관리자 계정만 생성
    const defaultAccount = { 
      id: 1, 
      email: 'contact@watercharging.com', 
      password: 'watercontact!@', 
      role: 'super_admin', 
      name: '시스템 관리자', 
      createdAt: koreaTimeUtils.getKoreaToday(), 
      status: 'active' 
    };
    
    return [defaultAccount];
  });

  // accounts가 변경될 때마다 localStorage에 저장 - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    storageUtils.save('user_accounts', accounts);
  }, [accounts]);
  */
  const [showCreateAccountModal, setShowCreateAccountModal] = useState(false);
  const [newAccount, setNewAccount] = useState({ email: '', password: '', confirmPassword: '', name: '', role: 'viewer' });
  const [isCreatingAccount, setIsCreatingAccount] = useState(false);
  const [showDeleteAccountModal, setShowDeleteAccountModal] = useState(false);
  const [accountToDelete, setAccountToDelete] = useState(null);
  const [isDeletingAccount, setIsDeletingAccount] = useState(false);
  const [showEditAccountModal, setShowEditAccountModal] = useState(false);
  const [editingAccount, setEditingAccount] = useState(null);
  const [editAccountForm, setEditAccountForm] = useState({ name: '', role: '', newPassword: '', confirmPassword: '' });
  const [isUpdatingAccount, setIsUpdatingAccount] = useState(false);

  // 반응형 사이드바 처리
  useEffect(() => {
    const handleResize = () => {
      if (window.innerWidth < 768) {
        // 모바일: 항상 축소
        setSidebarCollapsed(true);
      } else if (window.innerWidth < 1024) {
        // 태블릿: 기본 축소, 사용자가 수동으로 확장 가능
        if (!sidebarCollapsed) setSidebarCollapsed(true);
      }
      // 데스크톱(1024px+): 사용자 설정 유지
    };

    // 초기 실행
    handleResize();
    
    // 리사이즈 이벤트 리스너 등록
    window.addEventListener('resize', handleResize);
    
    // 컴포넌트 언마운트 시 이벤트 리스너 제거
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  const [currentDate, setCurrentDate] = useState(new Date());
  const [visibleCounts, setVisibleCounts] = useState({ accounting_review: 8, pending: 8, completed: 8 });
  const [kanbanPages, setKanbanPages] = useState({ accounting_review: 1, pending: 1, completed: 1 });
  const [dragActive, setDragActive] = useState(false);
  const [stationPage, setStationPage] = useState(1);
  const [stationsPerPage] = useState(10);
  const [pricingPage, setPricingPage] = useState(1);
  const [pricingPerPage] = useState(10);
  
  // 외부 클릭 감지 훅
  const useOutsideClick = (ref, callback) => {
    useEffect(() => {
      const handleClickOutside = (event) => {
        if (ref.current && !ref.current.contains(event.target)) {
          callback();
        }
      };

      document.addEventListener('mousedown', handleClickOutside);
      return () => {
        document.removeEventListener('mousedown', handleClickOutside);
      };
    }, [ref, callback]);
  };

  const stationDropdownRef = useRef(null);
  const analysisStationDropdownRef = useRef(null);

  // 외부 클릭 시 드롭다운 닫기
  useOutsideClick(stationDropdownRef, () => setShowStationDropdown(false));
  useOutsideClick(analysisStationDropdownRef, () => setShowStationDropdown(false));
  const [showAnalysisModal, setShowAnalysisModal] = useState(false);
  const [showAddForm, setShowAddForm] = useState(false);
  const [showStationForm, setShowStationForm] = useState(false);
  const [showDateModal, setShowDateModal] = useState(false);
  const [showTrashModal, setShowTrashModal] = useState(false);
  const [showCompletedModal, setShowCompletedModal] = useState(false);
  const [showStationDetailModal, setShowStationDetailModal] = useState(false);
  const [selectedStationDetail, setSelectedStationDetail] = useState(null);
  const [showStationDetailPage, setShowStationDetailPage] = useState(false);
  const [selectedStationForDetail, setSelectedStationForDetail] = useState(null);
  const [isEditingStationDetail, setIsEditingStationDetail] = useState(false);
  const [editStationData, setEditStationData] = useState({});
  const [showReminderPanel, setShowReminderPanel] = useState(false);
  const [readNotifications, setReadNotifications] = useState(() => {
    // Vercel 배포용 localStorage 비활성화
    return new Set();
  });

  // readNotifications가 변경될 때마다 localStorage에 저장 - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    storageUtils.save('read_notifications', Array.from(readNotifications));
  }, [readNotifications]);
  */
  
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [showApiSettingsModal, setShowApiSettingsModal] = useState(false);
  const [apiKeyForm, setApiKeyForm] = useState({ googleVisionApiKey: '' });
  const [currentApiKey, setCurrentApiKey] = useState('');
  const [isUpdatingApiKey, setIsUpdatingApiKey] = useState(false);
  const [accountsPage, setAccountsPage] = useState(1);
  const [accountsPerPage] = useState(5);
  const [activeAccountTab, setActiveAccountTab] = useState('users'); // 'users' | 'notifications'
  const [showDeleteStationModal, setShowDeleteStationModal] = useState(false);
  const [stationToDelete, setStationToDelete] = useState(null);
  const [selectedNotificationType, setSelectedNotificationType] = useState(null); // null | 'tax' | 'pricing' | 'station'
  const [showNotificationDetailModal, setShowNotificationDetailModal] = useState(false);
  
  // 날짜 모달 페이지네이션 상태
  const [dateModalPage, setDateModalPage] = useState(1);
  const [dateModalSearch, setDateModalSearch] = useState('');
  const [dateModalItemsPerPage] = useState(5);
  // 알림 시스템 상태
  const [systemNotifications, setSystemNotifications] = useState([]);
  const [showSystemNotification, setShowSystemNotification] = useState(false);
  
  // 시스템 알림 표시 함수
  const showNotification = useCallback((message, type = 'info', duration = 3000) => {
    const id = Date.now();
    const notification = { id, message, type, timestamp: new Date() };
    
    setSystemNotifications(prev => [...prev, notification]);
    setShowSystemNotification(true);
    
    // 자동 제거
    setTimeout(() => {
      setSystemNotifications(prev => prev.filter(n => n.id !== id));
    }, duration);
  }, []);
  
  // 성공/오류 알림 헬퍼
  const showSuccess = useCallback((message) => showNotification(message, 'success'), [showNotification]);
  const showError = useCallback((message) => showNotification(message, 'error', 5000), [showNotification]);
  const showWarning = useCallback((message) => showNotification(message, 'warning', 4000), [showNotification]);
  
  // 프로필 패스워드 폼 상태 - 초기값을 안전하게 설정
  const [profilePasswordForm, setProfilePasswordForm] = useState({ 
    currentPassword: '', 
    newPassword: '', 
    confirmPassword: '' 
  });

  // 현재 로그인한 사용자 정보 (실제로는 로그인 시스템과 연동)
  // SendGrid 설정 로드
  useEffect(() => {
    const loadSendGridConfig = () => {
      try {
        const apiKey = SendGridAPI.config.apiKey;
        const fromEmail = SendGridAPI.config.fromEmail;
        const fromName = SendGridAPI.config.fromName;
        
        setSendGridForm({
          apiKey: apiKey === 'YOUR_SENDGRID_API_KEY' ? '' : apiKey,
          fromEmail,
          fromName
        });
      } catch (error) {
        console.warn('SendGrid 설정 로드 실패:', error);
      }
    };
    
    if (showApiSettingsModal) {
      loadSendGridConfig();
    }
  }, [showApiSettingsModal]);

  // SendGrid 설정 업데이트 핸들러
  const handleUpdateSendGrid = useCallback(async () => {
    if (!sendGridForm.apiKey?.trim() || !sendGridForm.fromEmail?.trim() || !sendGridForm.fromName?.trim()) {
      showError('모든 필드를 입력해주세요.');
      return;
    }

    // 이메일 형식 검증
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(sendGridForm.fromEmail)) {
      showError('올바른 이메일 형식을 입력해주세요.');
      return;
    }

    // API 키 형식 검증
    if (!sendGridForm.apiKey.startsWith('SG.')) {
      showError('SendGrid API 키는 "SG."로 시작해야 합니다.');
      return;
    }

    setIsUpdatingSendGrid(true);
    
    try {
      // SendGrid 설정 저장
      const success = SendGridAPI.setConfig(
        sendGridForm.apiKey,
        sendGridForm.fromEmail,
        sendGridForm.fromName
      );
      
      if (success) {
        showSuccess('SendGrid 설정이 저장되었습니다.');
      } else {
        throw new Error('설정 저장에 실패했습니다.');
      }
      
    } catch (error) {
      showError(error.message || 'SendGrid 설정 저장 중 오류가 발생했습니다.');
    } finally {
      setIsUpdatingSendGrid(false);
    }
  }, [sendGridForm, showError, showSuccess]);

  // SendGrid 설정 삭제 핸들러
  const handleDeleteSendGrid = useCallback(() => {
    try {
      SendGridAPI.setConfig('', '', '');
      setSendGridForm({
        apiKey: '',
        fromEmail: 'noreply@watercharging.com',
        fromName: 'Water TT 관리시스템'
      });
      showSuccess('SendGrid 설정이 삭제되었습니다.');
    } catch (error) {
      showError('SendGrid 설정 삭제 중 오류가 발생했습니다.');
    }
  }, [showError, showSuccess]);

  // 테스트 이메일 전송 핸들러
  const handleSendTestEmail = useCallback(async () => {
    if (!testEmailAddress?.trim()) {
      showError('테스트 이메일 주소를 입력해주세요.');
      return;
    }

    // 이메일 형식 검증
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(testEmailAddress)) {
      showError('올바른 이메일 형식을 입력해주세요.');
      return;
    }

    if (!SendGridAPI.hasValidApiKey()) {
      showError('먼저 SendGrid API 키를 설정해주세요.');
      return;
    }

    setIsSendingTestEmail(true);
    
    try {
      const result = await SendGridAPI.sendTestEmail(testEmailAddress);
      
      if (result.success) {
        showSuccess(`테스트 이메일이 ${testEmailAddress}로 전송되었습니다.`);
        setTestEmailAddress('');
      } else {
        if (result.isNetworkError) {
          showError('네트워크 오류가 발생했습니다. 인터넷 연결을 확인해주세요.');
        } else if (result.statusCode === 401) {
          showError('API 키가 유효하지 않습니다. SendGrid API 키를 확인해주세요.');
        } else if (result.statusCode === 403) {
          showError('API 키 권한이 부족합니다. SendGrid에서 Mail Send 권한을 확인해주세요.');
        } else {
          showError(`이메일 전송 실패: ${result.error}`);
        }
      }
      
    } catch (error) {
      showError(`테스트 이메일 전송 중 오류가 발생했습니다: ${error.message}`);
    } finally {
      setIsSendingTestEmail(false);
    }
  }, [testEmailAddress, showError, showSuccess]);

  // 현재 API 키 로드
  useEffect(() => {
    const loadApiKey = () => {
      try {
        const apiKey = GoogleVisionOCR.apiConfig.apiKey;
        setCurrentApiKey(apiKey === 'YOUR_API_KEY_HERE' ? '' : apiKey);
        setApiKeyForm({ googleVisionApiKey: apiKey === 'YOUR_API_KEY_HERE' ? '' : apiKey });
      } catch (error) {
        console.warn('Failed to load API key:', error);
      }
    };
    
    if (showApiSettingsModal) {
      loadApiKey();
    }
  }, [showApiSettingsModal]);

  // API 키 업데이트 핸들러
  const handleUpdateApiKey = useCallback(async () => {
    if (!apiKeyForm.googleVisionApiKey?.trim()) {
      showError('API 키를 입력해주세요.');
      return;
    }

    setIsUpdatingApiKey(true);
    
    try {
      // API 키 유효성 간단 체크 (길이)
      if (apiKeyForm.googleVisionApiKey.length < 20) {
        throw new Error('유효하지 않은 API 키 형식입니다.');
      }

      // Google Vision OCR에 API 키 설정
      GoogleVisionOCR.setApiKey(apiKeyForm.googleVisionApiKey);
      setCurrentApiKey(apiKeyForm.googleVisionApiKey);
      
      showSuccess('API 키가 성공적으로 업데이트되었습니다.');
      setShowApiSettingsModal(false);
      
    } catch (error) {
      showError(error.message || 'API 키 업데이트 중 오류가 발생했습니다.');
    } finally {
      setIsUpdatingApiKey(false);
    }
  }, [apiKeyForm.googleVisionApiKey, showError, showSuccess]);

  // API 키 삭제 핸들러
  const handleDeleteApiKey = useCallback(() => {
    try {
      GoogleVisionOCR.setApiKey('');
      setCurrentApiKey('');
      setApiKeyForm({ googleVisionApiKey: '' });
      showSuccess('API 키가 삭제되었습니다.');
    } catch (error) {
      showError('API 키 삭제 중 오류가 발생했습니다.');
    }
  }, [showError, showSuccess]);

  const currentUser = accounts.find(account => account.id === currentUserId) || null;

  // 권한 확인 함수들
  const canManageAccounts = currentUser?.role === 'super_admin' || currentUser?.role === 'admin';
  const canCreateEdit = currentUser?.role === 'super_admin' || currentUser?.role === 'admin' || currentUser?.role === 'editor';
  const canDelete = currentUser?.role === 'super_admin' || currentUser?.role === 'admin';
  const isViewerOnly = currentUser?.role === 'viewer';

  // 뷰어가 접근할 수 없는 화면에 있을 때 리다이렉트
  useEffect(() => {
    if (isViewerOnly && currentView === 'accounts') {
      setCurrentView('dashboard');
    }
    // 편집자가 계정 관리에 접근할 수 없도록 리다이렉트
    if (currentUser?.role === 'editor' && currentView === 'accounts') {
      setCurrentView('dashboard');
    }
  }, [isViewerOnly, currentView, currentUser]);

  // 툴팁 상태 관리
  const [showTooltip, setShowTooltip] = useState(null);

  // 알림 상태 관리 - Vercel 배포용 localStorage 비활성화
  const [notifications, setNotifications] = useState([]); // 기본값으로 초기화

  // notifications가 변경될 때마다 localStorage에 저장 - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    storageUtils.save('notifications', notifications);
  }, [notifications]);
  */

  // 알림 담당자 설정 상태 - Vercel 배포용 localStorage 비활성화
  const [notificationAssignments, setNotificationAssignments] = useState(() => {
    // 기본값으로 초기화
    return {
      tax_alerts: [], // 세금 알림 담당자 계정 ID 배열
      station_alerts: [] // 충전소 일정 알림 담당자 계정 ID 배열
    };
  });

  // notificationAssignments가 변경될 때마다 localStorage에 저장 - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    storageUtils.save('notification_assignments', notificationAssignments);
  }, [notificationAssignments]);
  */

  // 3일 후 알림 자동 삭제
  useEffect(() => {
    // 3일 후 알림 자동 삭제 (한국 시간 기준)
    const cleanupNotifications = () => {
      const now = koreaTimeUtils.getKoreaTime();
      setNotifications(prev => prev.filter(notification => {
        const createdDate = koreaTimeUtils.parseKoreaDate(notification.createdAt) || new Date(notification.createdAt);
        const daysDiff = (now - createdDate) / (1000 * 60 * 60 * 24);
        return daysDiff < 3;
      }));
    };

    // 초기 정리
    cleanupNotifications();
    
    // 24시간마다 정리
    const interval = setInterval(cleanupNotifications, 24 * 60 * 60 * 1000);
    
    return () => clearInterval(interval);
  }, []);

  const [showBulkUploadModal, setShowBulkUploadModal] = useState(false);

  // 폼 상태들
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analyzedData, setAnalyzedData] = useState(null);
  const [editingBill, setEditingBill] = useState(null);
  const [editingStation, setEditingStation] = useState(null);
  const [selectedDateBills, setSelectedDateBills] = useState([]);
  const [selectedStationEvents, setSelectedStationEvents] = useState([]);
  const [selectedCompletedBills, setSelectedCompletedBills] = useState([]);
  const [newBill, setNewBill] = useState({ name: '', amount: '', dueDate: '', category: '', stationName: '', address: '', isRecurring: false });
  const [newStation, setNewStation] = useState({ name: '', address: '', status: 'operating', approvalDate: '', safetyCheckDate: '', registeredDate: '', needsApproval: false });
  const [stationSearchQuery, setStationSearchQuery] = useState('');
  const [showStationDropdown, setShowStationDropdown] = useState(false);
  const [bulkUploadData, setBulkUploadData] = useState([]);
  const [bulkUploadPreview, setBulkUploadPreview] = useState([]);
  const [isProcessingBulk, setIsProcessingBulk] = useState(false);
  const [showTaxBulkUploadModal, setShowTaxBulkUploadModal] = useState(false);
  const [taxBulkUploadPreview, setTaxBulkUploadPreview] = useState([]);
  const [isProcessingTaxBulk, setIsProcessingTaxBulk] = useState(false);

  // 계산된 값들 (Memoized)
  const enhancedStations = useMemo(() => {
    return stations.map(station => {
      const stationBills = bills.filter(bill => bill.stationName === station.name);
      const totalBills = stationBills.length;
      const pendingBills = stationBills.filter(bill => bill.status === 'pending' || bill.status === 'accounting_review').length;
      const completedBills = stationBills.filter(bill => bill.status === 'completed').length;
      const totalAmount = stationBills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
      
      return { ...station, totalBills, pendingBills, completedBills, totalAmount };
    });
  }, [stations, bills]);

  const unreadNotificationCount = useMemo(() => {
    let count = 0;
    
    // 수동 추가된 알림
    count += notifications.filter(n => !readNotifications.has(n.id)).length;
    
    // 납부 예정 알림 (60일, 15일, 3일 전)
    const alertDays = [60, 15, 3];
    const upcomingBills = bills.filter(bill => {
      const daysLeft = utils.getDaysUntilDue(bill.dueDate);
      return alertDays.includes(daysLeft) && bill.status === 'pending';
    });
    count += upcomingBills.filter(bill => !readNotifications.has(`upcoming-${bill.id}-${utils.getDaysUntilDue(bill.dueDate)}`)).length;
    
    // 충전소 정보 미입력 알림
    enhancedStations.forEach(station => {
      if (!station.registeredDate) return;
      
      const registeredDate = new Date(station.registeredDate);
      const daysSinceRegistered = Math.floor((new Date() - registeredDate) / (1000 * 60 * 60 * 24));
      
      // 승인일 미입력 알림
      if (!station.approvalDate || station.approvalDate.trim() === '') {
        const notificationId = `missing-approval-${station.name}`;
        if (!readNotifications.has(notificationId) && daysSinceRegistered >= 1) {
          count++;
        }
      }
      
      // 안전 점검일 미입력 알림
      if (!station.safetyCheckDate || station.safetyCheckDate.trim() === '') {
        const notificationId = `missing-safety-${station.name}`;
        if (!readNotifications.has(notificationId) && daysSinceRegistered >= 1) {
          count++;
        }
      }
    });
    
    console.log('📊 알림 개수 계산:', {
      manualNotifications: notifications.filter(n => !readNotifications.has(n.id)).length,
      upcomingBills: upcomingBills.filter(bill => !readNotifications.has(`upcoming-${bill.id}-${utils.getDaysUntilDue(bill.dueDate)}`)).length,
      missingData: count - notifications.filter(n => !readNotifications.has(n.id)).length - upcomingBills.filter(bill => !readNotifications.has(`upcoming-${bill.id}-${utils.getDaysUntilDue(bill.dueDate)}`)).length,
      totalCount: count,
      readNotifications: Array.from(readNotifications)
    });
    
    return count;
  }, [bills, enhancedStations, notifications, readNotifications]);

  // 이메일 발송 상태 관리 - Vercel 배포용 localStorage 비활성화
  const [emailNotificationSettings, setEmailNotificationSettings] = useState(() => {
    // 기본값으로 초기화
    return {
      enabled: false, // 기본적으로 비활성화
      taxAlerts: true,
      stationAlerts: true
    };
  });

  // 이메일 설정이 변경될 때마다 localStorage에 저장 - Vercel 배포용 주석 처리
  /*
  useEffect(() => {
    storageUtils.save('email_notification_settings', emailNotificationSettings);
    console.log('📧 이메일 설정 저장됨:', emailNotificationSettings);
  }, [emailNotificationSettings]);
  */

  // 이메일 발송 이력 관리 (중복 발송 방지) - Vercel 배포용 localStorage 비활성화
  const [emailSentHistory, setEmailSentHistory] = useState(() => {
    // 기본값으로 초기화
    return {};
  });

  /*
  useEffect(() => {
    storageUtils.save('email_sent_history', emailSentHistory);
  }, [emailSentHistory]);
  */

  // 이메일 발송 함수
  const sendNotificationEmail = useCallback(async (notification) => {
    console.log('📧 이메일 발송 시도:', {
      type: notification.type,
      station: notification.stationName,
      settings: emailNotificationSettings
    });
    
    // 이메일 설정이 비활성화되어 있으면 발송하지 않음
    if (!emailNotificationSettings.enabled) {
      console.log('📧 이메일 설정이 비활성화됨 - 발송 취소');
      return;
    }

    // SendGrid API 키가 없으면 발송하지 않음
    if (!SendGridAPI.hasValidApiKey()) {
      console.warn('📧 SendGrid API 키가 설정되지 않아 이메일을 발송하지 않습니다.');
      return;
    }

    // 중복 발송 방지 - 같은 알림을 오늘 이미 보냈는지 확인
    const today = koreaTimeUtils.getKoreaToday();
    const emailKey = `${notification.id}-${today}`;
    
    if (emailSentHistory[emailKey]) {
      console.log('📧 이미 오늘 발송된 알림입니다:', notification.id);
      return;
    }

    try {
      // 담당자 이메일 주소 가져오기
      let recipientEmails = [];
      
      if (notification.type.includes('missing_') || notification.type.includes('_added')) {
        // 충전소 관련 알림
        if (emailNotificationSettings.stationAlerts) {
          const stationAssignees = notificationAssignments.station_alerts || [];
          recipientEmails = stationAssignees
            .map(accountId => accounts.find(acc => acc.id === accountId))
            .filter(account => account && account.status === 'active')
            .map(account => account.email);
        }
      } else {
        // 세금 관련 알림
        if (emailNotificationSettings.taxAlerts) {
          const taxAssignees = notificationAssignments.tax_alerts || [];
          recipientEmails = taxAssignees
            .map(accountId => accounts.find(acc => acc.id === accountId))
            .filter(account => account && account.status === 'active')
            .map(account => account.email);
        }
      }

      if (recipientEmails.length === 0) {
        console.log('📧 이메일 수신자가 없습니다:', notification.type);
        return;
      }

      // 템플릿 데이터 준비
      let templateType, templateData;

      if (notification.type === 'prepare_notice' || notification.type === 'ready_notice' || notification.type === 'final_notice') {
        // 세금 알림
        templateType = 'taxReminder';
        templateData = {
          stationName: notification.stationName,
          taxType: notification.data.bill.category,
          amount: utils.formatAmount(notification.data.bill.amount),
          dueDate: notification.data.bill.dueDate,
          daysLeft: notification.data.daysLeft,
          priority: notification.priority
        };
      } else if (notification.type === 'missing_approval' || notification.type === 'missing_safety') {
        // 충전소 정보 미입력 알림
        templateType = 'stationInfoMissing';
        templateData = {
          stationName: notification.stationName,
          missingType: notification.type === 'missing_approval' ? 'approval' : 'safety',
          daysSinceRegistered: notification.data.daysSinceRegistered
        };
      } else if (notification.type === 'approval_added' || notification.type === 'safety_added') {
        // 새로 추가: 승인일/점검일 최초 입력 알림
        templateType = 'stationInfoAdded';
        templateData = {
          stationName: notification.stationName,
          infoType: notification.type === 'approval_added' ? 'approval' : 'safety',
          date: notification.date,
          hasAutoTax: notification.message && notification.message.includes('자동 등록')
        };
      }

      if (templateType && templateData) {
        console.log(`📧 이메일 발송 시작:`, {
          type: templateType,
          recipients: recipientEmails,
          data: templateData
        });

        const result = await SendGridAPI.sendTemplateEmail(recipientEmails, templateType, templateData);
        
        if (result.success) {
          // 발송 이력에 기록
          setEmailSentHistory(prev => ({
            ...prev,
            [emailKey]: {
              sentAt: new Date().toISOString(),
              recipients: recipientEmails,
              type: templateType
            }
          }));
          
          console.log('✅ 이메일 발송 성공:', notification.id);
        } else {
          console.error('❌ 이메일 발송 실패:', result.error);
        }
      }

    } catch (error) {
      console.error('💥 이메일 발송 중 오류:', error);
    }
  }, [emailNotificationSettings, emailSentHistory, notificationAssignments, accounts]);

  // 개선된 알림 시스템 (enhancedStations 이후에 배치)
  const notificationSystem = useMemo(() => {
    const systemNotifications = [];
    
    // 1. 납부 예정 알림 (MVP: 3일 전만 이메일 발송)
    const alertDays = [60, 15, 3];
    const upcomingBills = bills.filter(bill => {
      const daysLeft = utils.getDaysUntilDue(bill.dueDate);
      return alertDays.includes(daysLeft) && 
             (bill.status === 'pending' || bill.status === 'accounting_review');
    });
    
    upcomingBills.forEach(bill => {
      const daysLeft = utils.getDaysUntilDue(bill.dueDate);
      const notificationId = `upcoming-${bill.id}-${daysLeft}`;
      
      // 알림 타입과 우선순위 설정
      let alertType, priority, title;
      if (daysLeft === 60) {
        alertType = 'prepare_notice';
        priority = 'low';
        title = `${bill.stationName} ${bill.category} 사전 준비 알림 (60일 전)`;
      } else if (daysLeft === 15) {
        alertType = 'ready_notice';
        priority = 'medium';
        title = `${bill.stationName} ${bill.category} 준비 완료 알림 (15일 전)`;
      } else if (daysLeft === 3) {
        alertType = 'final_notice';
        priority = 'high';
        title = `${bill.stationName} ${bill.category} 최종 확인 알림 (3일 전)`;
      }
      
      const notification = {
        id: notificationId,
        type: alertType,
        priority,
        stationName: bill.stationName,
        title,
        data: { bill, daysLeft },
        createdAt: bill.dueDate,
        isRead: readNotifications.has(notificationId)
      };

      systemNotifications.push(notification);

      // 새로운 알림이고 읽지 않았으면 이메일 발송 (MVP: 3일 전만)
      if (!notification.isRead && daysLeft === 3) {
        // 비동기 이메일 발송 (알림 시스템 성능에 영향 없도록)
        setTimeout(() => sendNotificationEmail(notification), 100);
      }
    });
    
    // 3. 충전소 정보 미입력 알림 (개선된 버전)
    enhancedStations.forEach(station => {
      // 등록일이 없는 기존 충전소들을 위해 기본값 설정
      let registeredDate;
      if (station.registeredDate) {
        registeredDate = new Date(station.registeredDate);
      } else {
        // 등록일이 없으면 30일 전으로 가정 (알림이 바로 뜨도록)
        registeredDate = new Date();
        registeredDate.setDate(registeredDate.getDate() - 30);
      }
      
      const today = koreaTimeUtils.getKoreaTime();
      const daysSinceRegistered = Math.floor((today - registeredDate) / (1000 * 60 * 60 * 24));
      
      // 사용 승인일 미입력 알림 - MVP: 7일 후부터 주 1회
      if (!station.approvalDate || station.approvalDate.trim() === '') {
        const notificationId = `missing-approval-${station.name}`;
        
        // MVP: 30일 후부터, 주 1회만 알림 (30, 37, 44, 51일...)
        if (!readNotifications.has(notificationId) && daysSinceRegistered >= 30 && (daysSinceRegistered - 30) % 7 === 0) {
          const notification = {
            id: notificationId,
            type: 'missing_approval',
            priority: daysSinceRegistered > 30 ? 'high' : 'medium',
            stationName: station.name,
            title: `${station.name} 사용 승인일 미입력`,
            data: { station, daysSinceRegistered },
            createdAt: station.registeredDate || koreaTimeUtils.getKoreaToday(),
            isRead: false
          };

          systemNotifications.push(notification);

          // MVP: 중요한 경우만 이메일 발송 (30일 이상 경과)
          if (daysSinceRegistered >= 30) {
            setTimeout(() => sendNotificationEmail(notification), 200);
          }
        }
      }
      
      // 안전 점검일 미입력 알림 - MVP: 1일 후 1회만
      if (!station.safetyCheckDate || station.safetyCheckDate.trim() === '') {
        const notificationId = `missing-safety-${station.name}`;
        
        // MVP: 30일 후 1회만 알림
        if (!readNotifications.has(notificationId) && daysSinceRegistered === 30) {
          const notification = {
            id: notificationId,
            type: 'missing_safety',
            priority: 'high', // 안전은 중요하므로 높은 우선순위
            stationName: station.name,
            title: `${station.name} 안전 점검일 미입력`,
            data: { station, daysSinceRegistered },
            createdAt: station.registeredDate || koreaTimeUtils.getKoreaToday(),
            isRead: false
          };

          systemNotifications.push(notification);

          // MVP: 안전 점검은 중요하므로 30일 후 이메일 발송
          setTimeout(() => sendNotificationEmail(notification), 300);
        }
      }
    });
    
    // 4. 사용자 추가 알림
    notifications.forEach(notification => {
      const notificationId = notification.id;
      systemNotifications.push({
        id: notificationId,
        type: notification.type,
        priority: 'medium',
        stationName: notification.stationName,
        title: notification.type === 'approval_added' 
          ? `${notification.stationName} 사용 승인일 추가됨`
          : `${notification.stationName} 안전 점검일 추가됨`,
        data: { notification },
        createdAt: notification.createdAt,
        isRead: readNotifications.has(notificationId)
      });
    });
    
    // 우선순위 및 시간순 정렬
    const sortedNotifications = systemNotifications.sort((a, b) => {
      // 1. 읽음 상태 (읽지 않은 것이 먼저)
      if (a.isRead !== b.isRead) {
        return a.isRead ? 1 : -1;
      }
      
      // 2. 우선순위 (high > medium > low)
      const priorityOrder = { high: 3, medium: 2, low: 1 };
      const priorityDiff = priorityOrder[b.priority] - priorityOrder[a.priority];
      if (priorityDiff !== 0) return priorityDiff;
      
      // 3. 시간순 (최신 먼저)
      return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    return {
      notifications: sortedNotifications,
      unreadCount: sortedNotifications.filter(n => !n.isRead).length,
      highPriorityCount: sortedNotifications.filter(n => n.priority === 'high' && !n.isRead).length
    };
  }, [bills, enhancedStations, notifications, readNotifications, sendNotificationEmail]);

  const filteredStations = useMemo(() => {
    if (!stationSearchQuery) return enhancedStations;
    return enhancedStations.filter(station => 
      station.name.toLowerCase().includes(stationSearchQuery.toLowerCase()) ||
      station.address.toLowerCase().includes(stationSearchQuery.toLowerCase())
    );
  }, [enhancedStations, stationSearchQuery]);

  // 충전소 필터링 로직 (최적화됨)
  const filteredStationsForManagement = useMemo(() => {
    return StationFilterSystem.applyFilters(enhancedStations, stationFilters);
  }, [enhancedStations, stationFilters]);

  const paginatedStations = useMemo(() => {
    const startIndex = (stationPage - 1) * stationsPerPage;
    const endIndex = startIndex + stationsPerPage;
    return filteredStationsForManagement.slice(startIndex, endIndex);
  }, [filteredStationsForManagement, stationPage, stationsPerPage]);

  const totalStationPages = Math.ceil(filteredStationsForManagement.length / stationsPerPage);

  const getBillsByStatus = useCallback((status) => {
    let filteredBills = bills.filter(bill => bill.status === status);
    
    if (globalFilters.category !== 'all') {
      filteredBills = filteredBills.filter(bill => bill.category === globalFilters.category);
    }
    
    if (globalFilters.stationSearch) {
      filteredBills = filteredBills.filter(bill => 
        bill.stationName?.toLowerCase().includes(globalFilters.stationSearch.toLowerCase()) ||
        bill.address?.toLowerCase().includes(globalFilters.stationSearch.toLowerCase())
      );
    }
    
    if (globalFilters.startDate || globalFilters.endDate) {
      filteredBills = filteredBills.filter(bill => {
        const billDate = new Date(bill.dueDate);
        const startDate = globalFilters.startDate ? new Date(globalFilters.startDate) : null;
        const endDate = globalFilters.endDate ? new Date(globalFilters.endDate) : null;
        
        if (startDate && endDate) {
          return billDate >= startDate && billDate <= endDate;
        } else if (startDate) {
          return billDate >= startDate;
        } else if (endDate) {
          return billDate <= endDate;
        }
        return true;
      });
    }
    
    filteredBills.sort((a, b) => {
      let aValue, bValue;
      
      switch (filters.sortBy) {
        case 'amount':
          aValue = utils.getAmount(a.amount);
          bValue = utils.getAmount(b.amount);
          break;
        case 'uploadedAt':
          aValue = new Date(a.uploadedAt);
          bValue = new Date(b.uploadedAt);
          break;
        case 'stationName':
          aValue = a.stationName || '';
          bValue = b.stationName || '';
          break;
        default:
          aValue = new Date(a.dueDate);
          bValue = new Date(b.dueDate);
          break;
      }
      
      if (aValue < bValue) return filters.sortOrder === 'asc' ? -1 : 1;
      if (aValue > bValue) return filters.sortOrder === 'asc' ? 1 : -1;
      return 0;
    });
    
    return filteredBills;
  }, [bills, globalFilters, filters]);

  const overallStats = useMemo(() => {
    const totalAmount = bills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
    const completedAmount = bills
      .filter(bill => bill.status === 'completed')
      .reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
    const pendingAmount = bills
      .filter(bill => bill.status === 'pending' || bill.status === 'accounting_review')
      .reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
    
    const overdueBills = bills.filter(bill => {
      const daysLeft = utils.getDaysUntilDue(bill.dueDate);
      return daysLeft < 0 && bill.status === 'pending';
    });
    
    return {
      totalAmount,
      completedAmount,
      pendingAmount,
      completionRate: bills.length > 0 ? Math.round((bills.filter(b => b.status === 'completed').length / bills.length) * 100) : 0,
      overdueCount: overdueBills.length,
      totalBills: bills.length,
      stationsCount: enhancedStations.length
    };
  }, [bills, enhancedStations]);

  const getMonthlyStats = useMemo(() => {
    const months = [];
    const currentDate = new Date();
    
    for (let i = 0; i < 12; i++) {
      const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
      const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      const monthName = date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'short' });
      
      const monthBills = bills.filter(bill => {
        const billDate = new Date(bill.dueDate);
        const billMonthKey = `${billDate.getFullYear()}-${String(billDate.getMonth() + 1).padStart(2, '0')}`;
        return billMonthKey === monthKey;
      });
      
      const totalAmount = monthBills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
      const completedAmount = monthBills
        .filter(bill => bill.status === 'completed')
        .reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
      
      months.push({
        month: monthName,
        total: totalAmount,
        completed: completedAmount,
        pending: totalAmount - completedAmount,
        count: monthBills.length
      });
    }
    
    return months;
  }, [bills]);

  const getCategoryStats = useMemo(() => {
    const categories = ['취득세', '재산세', '기타세'];
    return categories.map(category => {
      const categoryBills = bills.filter(bill => bill.category === category);
      const totalAmount = categoryBills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
      const completedAmount = categoryBills
        .filter(bill => bill.status === 'completed')
        .reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
      
      return {
        category,
        total: totalAmount,
        completed: completedAmount,
        pending: totalAmount - completedAmount,
        count: categoryBills.length,
        completionRate: categoryBills.length > 0 ? Math.round((categoryBills.filter(b => b.status === 'completed').length / categoryBills.length) * 100) : 0
      };
    });
  }, [bills]);

  const getTopStations = useMemo(() => {
    return enhancedStations
      .sort((a, b) => b.totalAmount - a.totalAmount)
      .slice(0, 5)
      .map(station => ({
        ...station,
        completionRate: station.totalBills > 0 ? Math.round((station.completedBills / station.totalBills) * 100) : 0
      }));
  }, [enhancedStations]);

  const getBillsForDate = useCallback((date) => {
    // 한국 시간 기준으로 날짜 문자열 생성
    const dateStr = koreaTimeUtils.formatKoreaDate(date);
    
    return bills.filter(bill => 
      bill.dueDate === dateStr && 
      (bill.status === 'pending' || bill.status === 'accounting_review')
    );
  }, [bills]);

  const getStationEventsForDate = useCallback((date) => {
    // 한국 시간 기준으로 날짜 문자열 생성
    const dateStr = koreaTimeUtils.formatKoreaDate(date);
    
    const events = [];
    
    enhancedStations.forEach(station => {
      if (station.approvalDate === dateStr) {
        events.push({
          type: 'approval',
          stationName: station.name,
          title: '사용 승인일'
        });
      }
      if (station.safetyCheckDate === dateStr) {
        events.push({
          type: 'safety',
          stationName: station.name,
          title: '전기 안전 점검일'
        });
      }
    });
    
    return events;
  }, [enhancedStations]);

  const getCompletedBillsForDate = useCallback((date) => {
    // 한국 시간 기준으로 날짜 문자열 생성
    const dateStr = koreaTimeUtils.formatKoreaDate(date);
    
    return bills.filter(bill => 
      bill.status === 'completed' && bill.completedDate === dateStr
    );
  }, [bills]);

// 날짜 모달 관련 컴포넌트들
const DateModalSummaryCard = ({ type, title, count, amount, icon: IconComponent, colorClass }) => (
  <div className={`${colorClass} rounded-xl p-4`}>
    <div className="flex items-center justify-between mb-2">
      <div className="flex items-center space-x-2">
        <IconComponent className="w-5 h-5" />
        <span className="font-medium">{title}</span>
      </div>
      <span className="text-2xl font-bold">{count}</span>
    </div>
    {amount !== undefined && (
      <div className="text-sm">
        총 ₩{amount}
      </div>
    )}
  </div>
);

const DateModalBillCard = ({ bill, utils }) => (
  <div className="bg-amber-900/10 rounded-xl p-4 border border-amber-500/20 hover:bg-amber-900/20 transition-colors">
    <div className="flex items-start justify-between mb-3">
      <div className="flex-1">
        <div className="flex items-center space-x-2 mb-2">
          <CategoryBadge category={bill.category} />
          <span className={`px-2 py-1 rounded text-xs font-medium border ${
            utils.getDaysUntilDue(bill.dueDate) < 0 
              ? 'bg-red-500/20 text-red-300 border-red-500/30'
              : bill.status === 'accounting_review'
              ? 'bg-amber-500/20 text-amber-300 border-amber-500/30'
              : 'bg-blue-500/20 text-blue-300 border-blue-500/30'
          }`}>
            {utils.getDaysUntilDue(bill.dueDate) < 0 ? '지연' : 
             bill.status === 'accounting_review' ? '검토 중' : '예정'}
          </span>
        </div>
        <h4 className="font-medium text-gray-100 mb-1" title={bill.name}>{bill.name}</h4>
        <div className="text-sm text-gray-300 mb-1 truncate" title={bill.stationName}>{bill.stationName}</div>
        <div className="text-xs text-gray-400 truncate">{bill.address}</div>
      </div>
      <div className="text-right ml-3">
        <div className="text-lg font-bold text-amber-300 font-mono">₩{utils.formatAmount(bill.amount)}</div>
      </div>
    </div>
  </div>
);

const DateModalCompletedCard = ({ bill, utils }) => (
  <div className="bg-emerald-900/10 rounded-xl p-3 border border-emerald-500/20">
    <div className="flex items-center justify-between mb-2">
      <CategoryBadge category={bill.category} />
      <CheckCircle className="w-4 h-4 text-emerald-400" />
    </div>
    <h4 className="text-sm font-medium text-gray-200 mb-1 truncate" title={bill.name}>{bill.name}</h4>
    <div className="text-xs text-gray-400 mb-1 truncate" title={bill.stationName}>{bill.stationName}</div>
    <div className="text-sm font-mono text-emerald-300 mb-1">₩{utils.formatAmount(bill.amount)}</div>
    <div className="text-xs text-gray-500">완료: {bill.completedDate}</div>
  </div>
);

const DateModalStationEvent = ({ event, index }) => (
  <div className="bg-blue-900/10 rounded-xl p-4 border border-blue-500/20">
    <div className="flex items-center justify-between">
      <div className="flex items-center space-x-3">
        <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
          event.type === 'approval' ? 'bg-emerald-500/20' : 'bg-purple-500/20'
        }`}>
          {event.type === 'approval' ? (
            <CheckCircle className="w-5 h-5 text-emerald-400" />
          ) : (
            <Zap className="w-5 h-5 text-purple-400" />
          )}
        </div>
        <div>
          <h4 className="font-medium text-gray-100 mb-1">{event.stationName}</h4>
          <p className="text-sm text-gray-400">
            {event.type === 'approval' ? '충전소 사용 승인 날짜입니다' : '전기 안전 점검 예정일입니다'}
          </p>
        </div>
      </div>
      <span className={`px-4 py-2 rounded-lg text-sm font-medium ${
        event.type === 'approval' 
          ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30' 
          : 'bg-purple-500/20 text-purple-300 border border-purple-500/30'
      }`}>
        {event.title}
      </span>
    </div>
  </div>
);

const DateModalContent = ({ selectedDateBills, selectedCompletedBills, selectedStationEvents, utils }) => {
  const pendingAmount = utils.formatKoreanCurrency(selectedDateBills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0));
  const completedAmount = utils.formatKoreanCurrency(selectedCompletedBills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0));

  return (
    <div className="h-full flex flex-col">
      {/* 상단 고정 영역 - 요약 카드들 */}
      <div className="flex-shrink-0 mb-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {selectedDateBills.length > 0 && (
            <DateModalSummaryCard
              type="pending"
              title="납부 예정"
              count={selectedDateBills.length}
              amount={pendingAmount}
              icon={Clock}
              colorClass="bg-amber-900/20 border border-amber-500/30 text-amber-200"
            />
          )}
          
          {selectedCompletedBills.length > 0 && (
            <DateModalSummaryCard
              type="completed"
              title="납부 완료"
              count={selectedCompletedBills.length}
              amount={completedAmount}
              icon={CheckCircle}
              colorClass="bg-emerald-900/20 border border-emerald-500/30 text-emerald-200"
            />
          )}
          
          {selectedStationEvents.length > 0 && (
            <DateModalSummaryCard
              type="events"
              title="충전소 일정"
              count={selectedStationEvents.length}
              icon={Zap}
              colorClass="bg-blue-900/20 border border-blue-500/30 text-blue-200"
            />
          )}
        </div>
      </div>

      {/* 중간 스크롤 가능 영역 - 세부 내용 */}
      <div className="flex-1 overflow-y-auto custom-scrollbar min-h-0">
        <div className="space-y-6">
          {/* 납부 예정 세금 */}
          {selectedDateBills.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold text-amber-300 mb-4 flex items-center">
                <Clock className="w-5 h-5 mr-2" />
                납부 예정 세금 ({selectedDateBills.length}건)
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                {selectedDateBills.slice(0, 8).map(bill => (
                  <DateModalBillCard key={bill.id} bill={bill} utils={utils} />
                ))}
              </div>
              {selectedDateBills.length > 8 && (
                <div className="text-center p-3 bg-slate-800/30 rounded-lg border border-slate-600/30">
                  <p className="text-sm text-gray-400">
                    처음 8개만 표시됩니다. 전체 {selectedDateBills.length}건 중 {selectedDateBills.length - 8}건이 더 있습니다.
                  </p>
                </div>
              )}
            </div>
          )}

          {/* 납부 완료 세금 */}
          {selectedCompletedBills.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold text-emerald-300 mb-4 flex items-center">
                <CheckCircle className="w-5 h-5 mr-2" />
                납부 완료 세금 ({selectedCompletedBills.length}건)
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4">
                {selectedCompletedBills.slice(0, 9).map(bill => (
                  <DateModalCompletedCard key={bill.id} bill={bill} utils={utils} />
                ))}
              </div>
              {selectedCompletedBills.length > 9 && (
                <div className="text-center p-3 bg-slate-800/30 rounded-lg border border-slate-600/30">
                  <p className="text-sm text-gray-400">
                    처음 9개만 표시됩니다. 전체 {selectedCompletedBills.length}건 중 {selectedCompletedBills.length - 9}건이 더 있습니다.
                  </p>
                </div>
              )}
            </div>
          )}
          
          {/* 충전소 일정 */}
          {selectedStationEvents.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold text-blue-300 mb-4 flex items-center">
                <Zap className="w-5 h-5 mr-2" />
                충전소 일정 ({selectedStationEvents.length}건)
              </h3>
              <div className="space-y-3">
                {selectedStationEvents.map((event, index) => (
                  <DateModalStationEvent key={index} event={event} index={index} />
                ))}
              </div>
            </div>
          )}

          {/* 내용이 없는 경우 */}
          {selectedDateBills.length === 0 && selectedCompletedBills.length === 0 && selectedStationEvents.length === 0 && (
            <div className="text-center py-12">
              <Calendar className="w-16 h-16 mx-auto mb-4 text-gray-500" />
              <p className="text-gray-400 text-lg mb-2">이 날짜에는 일정이 없습니다</p>
              <p className="text-gray-500 text-sm">다른 날짜를 선택해보세요</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

  const getBillStatus = useCallback((bill) => {
    const daysLeft = utils.getDaysUntilDue(bill.dueDate);
    if (daysLeft < 0 && bill.status === 'pending') return 'overdue';
    return bill.status;
  }, []);

  const getStatusColor = useCallback((status) => {
    const colors = {
      pending: 'bg-blue-500',
      review: 'bg-orange-500',
      overdue: 'bg-red-500'
    };
    return colors[status] || 'bg-gray-500';
  }, []);

  // 이벤트 핸들러들
  const handleCreateAccount = useCallback(async () => {
    // 유효성 검사
    if (!newAccount.email || !newAccount.password || !newAccount.confirmPassword || !newAccount.name) {
      showError('모든 필드를 입력해주세요.');
      return;
    }
    
    // 이메일 형식 검증
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(newAccount.email)) {
      showError('올바른 이메일 형식을 입력해주세요.');
      return;
    }
    
    // 패스워드 확인
    if (newAccount.password !== newAccount.confirmPassword) {
      showError('패스워드가 일치하지 않습니다.');
      return;
    }
    
    // 패스워드 길이 검증
    if (newAccount.password.length < 6) {
      showError('패스워드는 최소 6자 이상이어야 합니다.');
      return;
    }
    
    // 중복 이메일 검사
    if (accounts.some(account => account.email === newAccount.email)) {
      showError('이미 사용 중인 이메일입니다.');
      return;
    }
    
    setIsCreatingAccount(true);
    
    try {
      // 실제 구현에서는 여기서 API 호출
      setTimeout(() => {
        const account = {
          id: Date.now(),
          email: newAccount.email,
          password: newAccount.password, // 실제로는 해시 처리 필요
          name: newAccount.name,
          role: newAccount.role,
          createdAt: new Date().toISOString().split('T')[0],
          status: 'active'
        };
        
        setAccounts(prev => [...prev, account]);
        setNewAccount({ email: '', password: '', confirmPassword: '', name: '', role: 'viewer' });
        setShowCreateAccountModal(false);
        setIsCreatingAccount(false);
        
        showSuccess(`${account.name} 계정이 성공적으로 생성되었습니다.`);
      }, 1000);
    } catch (error) {
      console.error('Account creation failed:', error);
      showError('계정 생성 중 오류가 발생했습니다. 다시 시도해주세요.');
      setIsCreatingAccount(false);
    }
  }, [newAccount, accounts, showError, showSuccess]);

  const handleUpdateAccount = useCallback(async () => {
    if (!editingAccount || !editAccountForm.name) {
      alert('이름을 입력해주세요.');
      return;
    }
    
    // 패스워드 변경 시 유효성 검사
    if (editAccountForm.newPassword) {
      if (editAccountForm.newPassword.length < 6) {
        alert('패스워드는 최소 6자 이상이어야 합니다.');
        return;
      }
      
      if (editAccountForm.newPassword !== editAccountForm.confirmPassword) {
        alert('패스워드가 일치하지 않습니다.');
        return;
      }
    }
    
    setIsUpdatingAccount(true);
    
    // 실제 구현에서는 여기서 API 호출
    setTimeout(() => {
      setAccounts(prev => prev.map(account => 
        account.id === editingAccount.id 
          ? { ...account, name: editAccountForm.name, role: editAccountForm.role }
          : account
      ));
      
      setShowEditAccountModal(false);
      setEditingAccount(null);
      setEditAccountForm({ name: '', role: '', newPassword: '', confirmPassword: '' });
      setIsUpdatingAccount(false);
      
      const passwordChanged = editAccountForm.newPassword ? ' (패스워드 변경됨)' : '';
      alert(`${editAccountForm.name} 계정이 수정되었습니다${passwordChanged}.`);
    }, 1000);
  }, [editingAccount, editAccountForm, setAccounts]);

  const handleDeleteAccount = useCallback(async () => {
    if (!accountToDelete) return;
    
    setIsDeletingAccount(true);
    
    // 실제 구현에서는 여기서 API 호출
    setTimeout(() => {
      setAccounts(prev => prev.filter(account => account.id !== accountToDelete.id));
      setShowDeleteAccountModal(false);
      setAccountToDelete(null);
      setIsDeletingAccount(false);
      
      alert(`${accountToDelete.name} 계정이 삭제되었습니다.`);
    }, 1000);
  }, [accountToDelete]);

  const handleLogin = useCallback(async () => {
    if (!loginForm.email || !loginForm.password) {
      setLoginError('이메일과 패스워드를 모두 입력해주세요.');
      return;
    }
    
    setIsLoggingIn(true);
    setLoginError('');
    
    // 실제 구현에서는 여기서 API 호출
    setTimeout(() => {
      // 등록된 계정에서 이메일과 패스워드 확인
      const foundAccount = accounts.find(account => 
        account.email === loginForm.email && 
        account.password === loginForm.password &&
        account.status === 'active'
      );
      
      if (foundAccount) {
        setIsLoggedIn(true);
        setCurrentUserId(foundAccount.id);
        // currentView는 useEffect에서 자동으로 dashboard로 변경됨
        setLoginForm({ email: '', password: '' });
        setLoginError('');
      } else {
        setLoginError('이메일 또는 패스워드가 올바르지 않습니다.');
      }
      setIsLoggingIn(false);
    }, 1000);
  }, [loginForm, accounts]);

  const handleForgotPassword = useCallback(async () => {
    if (!forgotPasswordEmail || !forgotPasswordEmail.trim()) {
      return;
    }
    
    // 이메일 형식 간단 검증
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(forgotPasswordEmail)) {
      return;
    }
    
    // 실제 구현에서는 여기서 API 호출
    setTimeout(() => {
      setForgotPasswordSent(true);
    }, 1000);
  }, [forgotPasswordEmail]);

  const handleReminderClick = useCallback((type, stationName, notificationId) => {
    // 알림 읽음 처리
    setReadNotifications(prev => new Set([...prev, notificationId]));
    
    // 리마인더 패널 닫기
    setShowReminderPanel(false);
    
    // 알림 타입에 따른 분기 처리
    if (type === 'approval_added' || type === 'safety_added' || type === 'missing_approval' || type === 'missing_safety') {
      // 충전소 정보 관련 알림 → 충전소 관리 뷰로 이동
      setCurrentView('stations');
      // 충전소 상세 페이지가 열려있다면 닫기
      setShowStationDetailPage(false);
      setSelectedStationForDetail(null);
      // 검색 필터 적용
      setStationFilters(prev => ({
        ...prev,
        search: stationName
      }));
      setStationPage(1);
    } else {
      // 세금 관련 알림 → 칸반 뷰로 이동
      setCurrentView('kanban');
      setGlobalFilters(prev => ({
        ...prev,
        stationSearch: stationName,
        category: 'all'
      }));
    }
  }, []);

  const handleMarkAllAsRead = useCallback(() => {
    // notificationSystem에서 모든 알림 ID를 가져와서 읽음 처리
    const allNotificationIds = new Set(readNotifications);
    
    // 현재 시스템의 모든 알림을 읽음 처리
    notificationSystem.notifications.forEach(notification => {
      allNotificationIds.add(notification.id);
    });
    
    console.log('📖 모든 알림 읽음 처리:', {
      이전읽음개수: readNotifications.size,
      새로운읽음개수: allNotificationIds.size,
      추가된알림: Array.from(allNotificationIds).filter(id => !readNotifications.has(id))
    });
    
    setReadNotifications(allNotificationIds);
  }, [notificationSystem.notifications, readNotifications]);

  const handleCSVUpload = useCallback((files) => {
    if (files?.length > 0) {
      const file = files[0];
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          
          // 첫 번째 줄이 헤더인지 확인
          const hasHeader = lines[0]?.toLowerCase().includes('충전소') || lines[0]?.toLowerCase().includes('name');
          const dataLines = hasHeader ? lines.slice(1) : lines;
          
          const parsedData = dataLines.map((line, index) => {
            const columns = line.split(',').map(col => col.trim().replace(/"/g, ''));
            
            if (columns.length >= 2) {
              const stationName = columns[0] || `충전소 ${index + 1}`;
              const stationAddress = columns[1] || '';
              
              // 기존 충전소와 중복 체크
              const isDuplicateName = enhancedStations.some(station => 
                station.name.toLowerCase() === stationName.toLowerCase()
              );
              
              let validationErrors = [];
              let isValid = true;
              
              // 필수 필드 체크
              if (!stationName || stationName.trim() === '') {
                validationErrors.push('충전소명이 필요합니다');
                isValid = false;
              }
              
              if (!stationAddress || stationAddress.trim() === '') {
                validationErrors.push('주소가 필요합니다');
                isValid = false;
              }
              
              // 중복 체크
              if (isDuplicateName) {
                validationErrors.push('이미 존재하는 충전소명입니다');
                isValid = false;
              }
              
              // 이름 길이 체크
              if (stationName.length > 30) {
                validationErrors.push('충전소명은 30자 이하여야 합니다');
                isValid = false;
              }
              
              // 상태 매핑 로직 개선 및 디버깅 정보 추가
              let mappedStatus = 'operating'; // 기본값
              const statusText = columns[2]?.trim() || '';
              const originalStatusText = statusText; // 원본 텍스트 보관
              const statusLower = statusText.toLowerCase();
              
              console.log(`CSV 행 ${index + 1}: 원본 상태 텍스트 = "${originalStatusText}"`);
              
              // 순서 중요: 더 구체적인 조건을 먼저 확인
              if (statusText.includes('종료') || statusText.includes('closed') || statusLower === 'closed') {
                mappedStatus = 'closed';
              } else if (statusText.includes('예정') || statusText.includes('준비') || statusText.includes('오픈') || 
                        statusText.includes('preparing') || statusLower === 'preparing' || 
                        statusText.includes('개장') || statusText.includes('개업')) {
                mappedStatus = 'preparing';
              } else if (statusText.includes('운영') || statusText.includes('operating') || statusLower === 'operating' || statusText === '') {
                mappedStatus = 'operating';
              }
              
              console.log(`CSV 행 ${index + 1}: "${originalStatusText}" -> ${mappedStatus}`);
              
              return {
                id: `bulk_${index}`,
                name: stationName,
                address: stationAddress,
                status: mappedStatus,
                originalStatus: originalStatusText, // 디버깅용
                isValid: isValid,
                validationErrors: validationErrors,
                isDuplicate: isDuplicateName
              };
            }
            return null;
          }).filter(Boolean);
          
          setBulkUploadPreview(parsedData);
          setShowBulkUploadModal(true);
        } catch (error) {
          showError('CSV 파일을 읽는 중 오류가 발생했습니다. 파일 형식을 확인해주세요.');
        }
      };
      
      reader.readAsText(file, 'UTF-8');
    }
  }, [enhancedStations, showError]);

  const handleTaxCSVUpload = useCallback((files) => {
    if (files?.length > 0) {
      const file = files[0];
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          
          // 첫 번째 줄이 헤더인지 확인
          const hasHeader = lines[0]?.toLowerCase().includes('세금') || 
                           lines[0]?.toLowerCase().includes('충전소') || 
                           lines[0]?.toLowerCase().includes('name');
          const dataLines = hasHeader ? lines.slice(1) : lines;
          
          const parsedData = dataLines.map((line, index) => {
            const columns = line.split(',').map(col => col.trim().replace(/"/g, ''));
            
            if (columns.length >= 4) {
              const taxName = columns[0] || '';
              const stationName = columns[1] || '';
              const category = columns[2] || '';
              const dueDate = columns[3] || '';
              const amount = columns[4] || '미정';
              const status = columns[5] || '';  // 새로 추가: 상태
              const isRecurring = columns[6] || '';  // 새로 추가: 반복 납부
              
              let validationErrors = [];
              let isValid = true;
              
              // 상태 유효성 검사
              const validStatuses = ['회계사 검토', '납부 예정', '납부 완료', 'accounting_review', 'pending', 'completed'];
              let mappedStatus = 'pending'; // 기본값
              
              if (status && status.trim() !== '') {
                const statusLower = status.toLowerCase().trim();
                if (status === '회계사 검토' || statusLower === 'accounting_review') {
                  mappedStatus = 'accounting_review';
                } else if (status === '납부 예정' || statusLower === 'pending') {
                  mappedStatus = 'pending';
                } else if (status === '납부 완료' || statusLower === 'completed') {
                  mappedStatus = 'completed';
                } else {
                  validationErrors.push('상태는 "회계사 검토", "납부 예정", "납부 완료" 중 하나여야 합니다');
                  isValid = false;
                }
              } else {
                // 기본 상태 설정 로직 (기존 로직 유지)
                mappedStatus = category === '취득세' ? 'accounting_review' : 'pending';
              }
              
              // 반복 납부 유효성 검사
              let recurringValue = false; // 기본값
              
              // 취득세는 무조건 일회성으로 처리
              if (category === '취득세') {
                recurringValue = false;
              } else if (isRecurring && isRecurring.trim() !== '') {
                const recurringLower = isRecurring.toLowerCase().trim();
                if (recurringLower === 'y' || recurringLower === 'yes' || recurringLower === '예' || recurringLower === 'true') {
                  recurringValue = true;
                } else if (recurringLower === 'n' || recurringLower === 'no' || recurringLower === '아니오' || recurringLower === 'false') {
                  recurringValue = false;
                } else {
                  validationErrors.push('반복 납부는 Y/N, 예/아니오, true/false 중 하나여야 합니다');
                  isValid = false;
                }
              }
              
              // 반복 납부 로직 검증 (취득세는 제외)
              if (recurringValue && category !== '재산세' && category !== '기타세') {
                validationErrors.push('반복 납부는 재산세와 기타세만 설정할 수 있습니다');
                isValid = false;
              }
              // 필수 필드 체크
              if (!taxName || taxName.trim() === '') {
                validationErrors.push('세금 제목이 필요합니다');
                isValid = false;
              }
              
              if (!stationName || stationName.trim() === '') {
                validationErrors.push('충전소명이 필요합니다');
                isValid = false;
              }
              
              // 충전소 존재 여부 체크
              const stationExists = enhancedStations.some(station => 
                station.name.toLowerCase() === stationName.toLowerCase()
              );
              if (stationName && !stationExists) {
                validationErrors.push('존재하지 않는 충전소입니다');
                isValid = false;
              }
              
              // 세금 분류 체크
              const validCategories = ['취득세', '재산세', '기타세'];
              if (!category || !validCategories.includes(category)) {
                validationErrors.push('올바른 세금 분류가 필요합니다 (취득세/재산세/기타세)');
                isValid = false;
              }
              
              // 날짜 형식 체크 (YYYY-MM-DD)
              const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
              if (!dueDate || !dateRegex.test(dueDate)) {
                validationErrors.push('날짜는 YYYY-MM-DD 형식이어야 합니다');
                isValid = false;
              } else {
                // 유효한 날짜인지 체크
                const testDate = new Date(dueDate);
                if (isNaN(testDate.getTime())) {
                  validationErrors.push('유효하지 않은 날짜입니다');
                  isValid = false;
                }
              }
              
              // 금액 체크 (선택사항)
              if (amount && amount !== '미정' && !amountValidation.isValidAmount(amount)) {
                validationErrors.push('올바르지 않은 금액 형식입니다');
                isValid = false;
              }
              
              // 중복 세금 체크
              const isDuplicate = bills.some(bill => 
                bill.name.toLowerCase() === taxName.toLowerCase() &&
                bill.stationName.toLowerCase() === stationName.toLowerCase() &&
                bill.dueDate === dueDate
              );
              
              if (isDuplicate) {
                validationErrors.push('이미 존재하는 세금입니다');
                isValid = false;
              }
              
              return {
                id: `tax_bulk_${index}`,
                name: taxName,
                stationName: stationName,
                category: category,
                dueDate: dueDate,
                amount: amount || '미정',
                status: mappedStatus,
                isRecurring: recurringValue,
                address: stationExists ? enhancedStations.find(s => s.name.toLowerCase() === stationName.toLowerCase())?.address : '',
                isValid: isValid,
                validationErrors: validationErrors,
                isDuplicate: isDuplicate
              };
            }
            return null;
          }).filter(Boolean);
          
          setTaxBulkUploadPreview(parsedData);
          setShowTaxBulkUploadModal(true);
        } catch (error) {
          showError('CSV 파일을 읽는 중 오류가 발생했습니다. 파일 형식을 확인해주세요.');
        }
      };
      
      reader.readAsText(file, 'UTF-8');
    }
  }, [enhancedStations, bills, showError]);

  const handleBulkUploadConfirm = useCallback(() => {
    setIsProcessingBulk(true);
    
    setTimeout(() => {
      const validStations = bulkUploadPreview.filter(station => station.isValid);
      const invalidCount = bulkUploadPreview.length - validStations.length;
      
      validStations.forEach(station => {
        const { id, isValid, validationErrors, isDuplicate, ...stationData } = station;
        addStation(stationData);
      });
      
      setBulkUploadPreview([]);
      setShowBulkUploadModal(false);
      setIsProcessingBulk(false);
      
      // 결과에 따른 메시지 표시
      if (invalidCount === 0) {
        showSuccess(`${validStations.length}개의 충전소가 성공적으로 등록되었습니다!`);
      } else {
        showSuccess(`${validStations.length}개의 충전소가 등록되었습니다. ${invalidCount}개 항목은 오류로 인해 제외되었습니다.`);
      }
    }, 1000);
  }, [bulkUploadPreview, addStation, showSuccess]);

  const handleTaxBulkUploadConfirm = useCallback(async () => {
    setIsProcessingTaxBulk(true);
    
    try {
      const validTaxes = taxBulkUploadPreview.filter(tax => tax.isValid);
      const invalidCount = taxBulkUploadPreview.length - validTaxes.length;
      
      // 세금들을 순차적으로 등록
      for (const tax of validTaxes) {
        const { id, isValid, validationErrors, isDuplicate, ...taxData } = tax;
        const bill = {
          ...taxData,
          // 이미 매핑된 상태 사용
          // isRecurring은 이미 설정됨
        };
        
        await addBill(bill);
      }
      
      setTaxBulkUploadPreview([]);
      setShowTaxBulkUploadModal(false);
      setIsProcessingTaxBulk(false);
      
      // 결과에 따른 메시지 표시
      if (invalidCount === 0) {
        showSuccess(`${validTaxes.length}개의 세금이 성공적으로 등록되었습니다!`);
      } else {
        showSuccess(`${validTaxes.length}개의 세금이 등록되었습니다. ${invalidCount}개 항목은 오류로 인해 제외되었습니다.`);
      }
    } catch (error) {
      setIsProcessingTaxBulk(false);
      showError('세금 일괄등록 중 오류가 발생했습니다: ' + error.message);
    }
  }, [taxBulkUploadPreview, addBill, showSuccess, showError]);

  const handleFileUpload = useCallback(async (files) => {
    if (!files?.length) return;
    
    const file = files[0];
    
    // 파일 크기 체크 (10MB 제한)
    if (file.size > 10 * 1024 * 1024) {
      showError('파일 크기가 너무 큽니다. 10MB 이하의 파일을 업로드해주세요.');
      return;
    }
    
    // 파일 타입 체크
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
      showError('지원되지 않는 파일 형식입니다. JPG, PNG, WEBP, PDF 파일만 지원합니다.');
      return;
    }
    
    setIsAnalyzing(true);
    setShowAnalysisModal(true);
    setAnalyzedData(null);
    
    try {
      // PDF 파일 처리
      if (file.type === 'application/pdf') {
        showSuccess('PDF 파일을 처리하고 있습니다. 첫 번째 페이지를 분석합니다.');
        
        try {
          // PDF를 이미지로 변환
          console.log('PDF 변환 시작:', file.name);
          const convertedFile = await convertPdfToImage(file);
          
          if (!convertedFile) {
            throw new Error('PDF를 이미지로 변환하는데 실패했습니다.');
          }
          
          console.log('PDF → 이미지 변환 성공:', convertedFile.name);
          showSuccess('PDF → 이미지 변환 완료. OCR 분석을 시작합니다.');
          
          // 변환된 이미지로 구글 비전 API 진행
          const analyzedData = await OCRAnalyzer.analyze(convertedFile, (strategy, progress) => {
            const strategyNames = {
              'googleVisionOCR': 'PDF → 이미지 변환 완료, 구글 비전 API 분석',
              'localAnalysis': '로컬 이미지 분석',
              'fallbackAnalysis': '기본 분석 처리',
              '완료': '분석 완료'
            };
            
            const strategyName = strategyNames[strategy] || strategy;
            console.log(`${strategyName} 진행률: ${Math.round(progress * 100)}%`);
          });
          
          analyzedData.fileName = file.name; // 원본 PDF 파일명 유지
          analyzedData.sourceType = 'pdf';
          
          setAnalyzedData(analyzedData);
          
          if (analyzedData.confidence > 0.8) {
            showSuccess(`PDF 분석 완료! (${Math.round(analyzedData.confidence * 100)}% 신뢰도)`);
          } else if (analyzedData.confidence > 0.6) {
            showWarning(`PDF 분석 완료 (${Math.round(analyzedData.confidence * 100)}% 신뢰도). 내용을 확인해주세요.`);
          } else {
            showWarning(`PDF 기본 분석 완료 (${Math.round(analyzedData.confidence * 100)}% 신뢰도). 내용을 꼼꼼히 확인하고 수정해주세요.`);
          }
          
          return;
          
        } catch (pdfError) {
          console.error('PDF 처리 중 오류:', pdfError);
          showError(`PDF 처리 실패: ${pdfError.message}`);
          
          // PDF 처리 실패 시 기본값으로 대체
          const fallbackData = {
            fileName: file.name,
            category: '재산세',
            name: 'PDF 세금 고지서',
            amount: '미정',
            dueDate: koreaTimeUtils.formatKoreaDate(new Date(koreaTimeUtils.getKoreaTime().getTime() + 90 * 24 * 60 * 60 * 1000)),
            confidence: 0.3,
            stationName: '',
            address: '서울특별시 강남구 테헤란로 123',
            error: `PDF 분석 실패: ${pdfError.message}. 아래 정보를 확인하고 수정해주세요.`,
            sourceType: 'pdf'
          };
          
          setAnalyzedData(fallbackData);
          return;
        }
      }
      
      // 이미지 파일 유효성 검사
      const isValidImage = await new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = URL.createObjectURL(file);
      });
      
      if (!isValidImage) {
        throw new Error('유효하지 않은 이미지 파일입니다.');
      }
      
      showSuccess('파일 업로드 완료. 다중 분석 시스템을 시작합니다.');
      
      // 개선된 다중 전략 OCR 분석 (구글 비전 API 우선)
      const analyzedData = await OCRAnalyzer.analyze(file, (strategy, progress) => {
        const strategyNames = {
          'googleVisionOCR': '구글 비전 API로 고정밀 분석',
          'localAnalysis': '로컬 패턴 분석',
          'fallbackAnalysis': '기본 분석 처리',
          '완료': '분석 완료'
        };
        
        const strategyName = strategyNames[strategy] || strategy;
        console.log(`${strategyName} 진행률: ${Math.round(progress * 100)}%`);
      });
      
      // 결과에 따른 메시지 표시
      if (analyzedData.confidence > 0.8) {
        showSuccess(`고신뢰도 분석 완료! (${Math.round(analyzedData.confidence * 100)}% 신뢰도)`);
      } else if (analyzedData.confidence > 0.6) {
        showWarning(`중간 신뢰도 분석 완료 (${Math.round(analyzedData.confidence * 100)}% 신뢰도). 내용을 확인해주세요.`);
      } else {
        showWarning(`기본 분석 완료 (${Math.round(analyzedData.confidence * 100)}% 신뢰도). 내용을 꼼꼼히 확인하고 수정해주세요.`);
      }
      
      // 충전소 매칭 시도
      if (!analyzedData.stationName && analyzedData.address) {
        const matchingStation = enhancedStations.find(station => {
          const stationAddressParts = station.address.split(' ').slice(0, 3).join(' ');
          const analyzedAddressParts = analyzedData.address.split(' ').slice(0, 3).join(' ');
          return stationAddressParts === analyzedAddressParts;
        });
        
        if (matchingStation) {
          analyzedData.stationName = matchingStation.name;
          analyzedData.address = matchingStation.address;
          analyzedData.confidence = Math.min(analyzedData.confidence + 0.1, 0.98);
          showSuccess(`충전소 자동 매칭 완료: ${matchingStation.name}`);
        }
      }
      
      setAnalyzedData(analyzedData);
      
    } catch (error) {
      console.error('파일 업로드 실패:', error);
      showError(error.message || '파일 분석 중 오류가 발생했습니다.');
      
      // 완전 실패 시에도 기본값 제공
      const fallbackData = OCRAnalyzer.generateFallbackResult(file);
      fallbackData.error = `분석 실패: ${error.message}. 아래 정보를 확인하고 수정해주세요.`;
      setAnalyzedData(fallbackData);
      
    } finally {
      setIsAnalyzing(false);
    }
  }, [enhancedStations, showError, showSuccess, showWarning]);
  
  // 날짜에서 60일 더하는 유틸리티 함수
  const calculateTaxDueDate = useCallback((originalDate) => {
    const date = new Date(originalDate);
    date.setDate(date.getDate() + 60); // 60일 후
    return date.toISOString().split('T')[0];
  }, []);

  // 중복 취득세 체크 함수
  const checkDuplicateTax = useCallback((stationName, taxName, dueDate) => {
    return bills.some(bill => 
      bill.stationName === stationName && 
      bill.name === taxName && 
      bill.dueDate === dueDate &&
      bill.category === '취득세'
    );
  }, [bills]);
  const generateSimulationData = useCallback((fileName) => {
    const fileNameLower = fileName.toLowerCase();
    let predictedData = {
      fileName: fileName,
      category: '재산세',
      name: '충전소 재산세',
      amount: '2,350,000',
      dueDate: koreaTimeUtils.formatKoreaDate(new Date(koreaTimeUtils.getKoreaTime().getTime() + 90 * 24 * 60 * 60 * 1000)),
      confidence: 0.75,
      stationName: '',
      address: ''
    };

    // 파일명 기반 추측
    if (fileNameLower.includes('충전기') || fileNameLower.includes('charger')) {
      predictedData = { ...predictedData, category: '취득세', name: '충전기 취득세', amount: '미정' };
    } else if (fileNameLower.includes('캐노피') || fileNameLower.includes('canopy')) {
      predictedData = { ...predictedData, category: '취득세', name: '캐노피 취득세', amount: '미정' };
    } else if (fileNameLower.includes('공유') || fileNameLower.includes('사용료')) {
      predictedData = { ...predictedData, category: '기타세', name: '공유재산 사용료' };
    }

    // 시뮬레이션 주소 할당
    const simulatedAddresses = [
      '서울특별시 강남구 테헤란로 123',
      '서울특별시 마포구 양화로 234', 
      '서울특별시 송파구 올림픽로 345',
      '경기도 수원시 팔달구 덕영대로 456',
      '부산광역시 동구 중앙대로 567'
    ];
    
    const randomAddress = simulatedAddresses[Math.floor(Math.random() * simulatedAddresses.length)];
    
    // 기존 충전소와 매칭 시도
    const matchingStation = enhancedStations.find(station => {
      const stationAddressParts = station.address.split(' ').slice(0, 3).join(' ');
      const randomAddressParts = randomAddress.split(' ').slice(0, 3).join(' ');
      return stationAddressParts === randomAddressParts;
    });

    if (matchingStation) {
      predictedData.stationName = matchingStation.name;
      predictedData.address = matchingStation.address;
    } else {
      predictedData.address = randomAddress;
    }

    return predictedData;
  }, [enhancedStations]);

  // OCR로 추출된 텍스트를 분석하는 함수 (공통 분석 사용)
  const analyzeExtractedText = useCallback(async (extractedText, fileName, confidence) => {
    // 공통 분석 함수 사용
    return AnalysisUtils.analyzeText(extractedText, fileName);
  }, []);

  const handleDrag = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true);
    } else if (e.type === 'dragleave') {
      setDragActive(false);
    }
  }, []);

  const handleDrop = useCallback((e) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    handleFileUpload(Array.from(e.dataTransfer.files));
  }, [handleFileUpload]);

  const handleBillClick = useCallback((bill) => {
    setEditingBill(bill);
    setNewBill({
      name: bill.name,
      amount: bill.amount,
      dueDate: bill.dueDate,
      category: bill.category,
      stationName: bill.stationName || '',
      address: bill.address || '',
      isRecurring: bill.isRecurring || false
    });
    setStationSearchQuery('');
    setShowStationDropdown(false);
    setShowAddForm(true);
  }, []);

  const handleDateClick = useCallback((date, dateBills, stationEvents = [], completedBills = []) => {
    if (dateBills.length === 0 && stationEvents.length === 0 && completedBills.length === 0) return;
    setSelectedDateBills(dateBills);
    setSelectedStationEvents(stationEvents || []);
    setSelectedCompletedBills(completedBills || []);
    // 모달 열 때 페이지네이션 상태 초기화
    setDateModalPage(1);
    setDateModalSearch('');
    setShowDateModal(true);
  }, []);

  const confirmAnalysis = useCallback(async () => {
    console.log('=== confirmAnalysis 시작 ===');
    console.log('analyzedData:', analyzedData);
    console.log('현재 bills 개수:', bills.length);
    console.log('현재 bills 상태:', bills);
    
    if (!analyzedData) {
      console.error('analyzedData가 없음');
      showError('분석된 데이터가 없습니다.');
      return;
    }
      
    // 필수 필드 검증
    const requiredFields = {
      name: analyzedData.name?.trim(),
      dueDate: analyzedData.dueDate,
      stationName: analyzedData.stationName?.trim(),
      category: analyzedData.category
    };
    
    console.log('필수 필드 검증:', requiredFields);
    
    const missingFields = [];
    if (!requiredFields.name) missingFields.push('세금 제목');
    if (!requiredFields.dueDate) missingFields.push('납부 기한');
    if (!requiredFields.stationName) missingFields.push('충전소');
    if (!requiredFields.category) missingFields.push('세금 분류');
    
    if (missingFields.length > 0) {
      console.error('필수 필드가 누락됨:', missingFields);
      showError(`필수 정보가 누락되었습니다: ${missingFields.join(', ')}`);
      return;
    }

    // 충전소 존재 여부 확인
    console.log('충전소 존재 여부 확인 중...');
    console.log('등록된 충전소 목록:', enhancedStations.map(s => s.name));
    const stationExists = enhancedStations.some(station => station.name === requiredFields.stationName);
    console.log('충전소 존재 여부:', stationExists);
    
    if (!stationExists) {
      console.error('충전소를 찾을 수 없음:', requiredFields.stationName);
      showError('선택된 충전소를 찾을 수 없습니다. 충전소를 다시 선택해주세요.');
      return;
    }

    // 금액 유효성 검사
    if (analyzedData.amount && !amountValidation.isValidAmount(analyzedData.amount)) {
      console.error('유효하지 않은 금액:', analyzedData.amount);
      showError('입력된 금액이 유효하지 않습니다.');
      return;
    }
    
    const bill = {
      name: requiredFields.name,
      amount: utils.normalizeAmount(analyzedData.amount),
      dueDate: requiredFields.dueDate,
      category: requiredFields.category,
      stationName: requiredFields.stationName,
      address: analyzedData.address ? analyzedData.address.trim() : '',
      status: requiredFields.category === '취득세' ? 'accounting_review' : 'pending',
      isRecurring: requiredFields.category === '재산세' || requiredFields.category === '기타세' // 재산세/기타세는 기본 반복
    };
    
    console.log('생성될 bill 객체:', bill);
    
    try {
      console.log('addBill 호출 시작...');
      console.log('addBill 함수 타입:', typeof addBill);
      console.log('addBill 함수:', addBill);
      
      // addBill 함수를 await로 변경
      const result = await addBill(bill);
      console.log('addBill 호출 결과:', result);
      console.log('addBill 호출 완료 - 즉시 bills 상태:', bills.length);
      
      // 성공 메시지와 모달 닫기를 즉시 실행
      console.log('✅ 세금이 성공적으로 등록되었습니다');
      showSuccess(`${bill.category} "${bill.name}"이(가) 성공적으로 등록되었습니다.`);
      
      // 모달 닫기
      setShowAnalysisModal(false);
      setAnalyzedData(null);
      
      console.log('=== confirmAnalysis 완료 ===');
    } catch (error) {
      console.error('❌ addBill 실행 중 오류:', error);
      console.error('Error stack:', error.stack);
      showError(`세금 등록 중 오류가 발생했습니다: ${error.message}`);
    }
  }, [analyzedData, addBill, enhancedStations, showError, showSuccess, bills]);

  const handleAddBill = useCallback(() => {
    if (newBill.name && newBill.dueDate && newBill.stationName) {
      const bill = {
        ...newBill,
        amount: utils.normalizeAmount(newBill.amount),
        status: newBill.category === '취득세' ? 'accounting_review' : 'pending'
      };
      addBill(bill);
      setNewBill({ name: '', amount: '', dueDate: '', category: '', stationName: '', address: '', isRecurring: false });
      setShowAddForm(false);
    }
  }, [newBill, addBill]);

  const handleEditBill = useCallback(() => {
    if (editingBill && newBill.name && newBill.dueDate && newBill.stationName) {
      const updatedBill = {
        ...newBill,
        amount: utils.normalizeAmount(newBill.amount)
      };
      updateBill(editingBill.id, updatedBill);
      setEditingBill(null);
      setNewBill({ name: '', amount: '', dueDate: '', category: '', stationName: '', address: '' });
      setShowAddForm(false);
    }
  }, [editingBill, newBill, updateBill]);

  const handleStationDetailClick = useCallback((station) => {
    setSelectedStationDetail(station);
    setShowStationDetailModal(true);
  }, []);

  const handleStationClick = useCallback((station) => {
    setEditingStation(station);
    setNewStation({ ...station });
    setShowStationForm(true);
  }, []);

  const handleAddStation = useCallback(async () => {
    if (newStation.name && newStation.address) {
      console.log('=== handleAddStation 실행 ===');
      console.log('newStation:', newStation);
      
      // 날짜에서 60일 더하는 함수 (로컬)
      const calculateTaxDueDate = (originalDate) => {
        const date = new Date(originalDate);
        date.setDate(date.getDate() + 60); // 60일 후
        return date.toISOString().split('T')[0];
      };

      // 중복 취득세 체크 함수 (로컬)
      const checkDuplicateTax = (stationName, taxName, dueDate) => {
        return bills.some(bill => 
          bill.stationName === stationName && 
          bill.name === taxName && 
          bill.dueDate === dueDate &&
          bill.category === '취득세'
        );
      };

      // 충전소 먼저 추가
      addStation(newStation);
      
      // 스테이션 데이터를 미리 저장 (setTimeout에서 참조가 사라지는 문제 방지)
      const stationData = { ...newStation };
      
      // 생성할 취득세 리스트
      const taxesToCreate = [];
      
      // 승인일 처리 - 캐노피 취득세
      if (stationData.approvalDate && stationData.approvalDate.trim() !== '') {
        console.log('승인일이 입력됨:', stationData.approvalDate);
        
        const taxDueDate = calculateTaxDueDate(stationData.approvalDate);
        const taxName = "캐노피 취득세";
        
        console.log('계산된 캐노피 세금 납부일:', taxDueDate);
        
        const isDuplicate = checkDuplicateTax(stationData.name, taxName, taxDueDate);
        console.log('캐노피 세금 중복 여부:', isDuplicate);
        
        if (!isDuplicate) {
          const canopyTax = {
            name: taxName,
            amount: '미정',
            dueDate: taxDueDate,
            category: '취득세',
            stationName: stationData.name,
            address: stationData.address,
            status: 'accounting_review',
            isRecurring: false,
            uploadedAt: koreaTimeUtils.getKoreaToday(),
            completedDate: null,
            // 추가 메타데이터
            autoGenerated: true,
            sourceType: 'station_approval',
            sourceDate: stationData.approvalDate
          };
          
          taxesToCreate.push(canopyTax);
          console.log('캐노피 취득세 생성 준비:', canopyTax);
        }
      }
      
      // 점검일 처리 - 충전기 취득세
      if (stationData.safetyCheckDate && stationData.safetyCheckDate.trim() !== '') {
        console.log('점검일이 입력됨:', stationData.safetyCheckDate);
        
        const taxDueDate = calculateTaxDueDate(stationData.safetyCheckDate);
        const taxName = "충전기 취득세";
        
        console.log('계산된 충전기 세금 납부일:', taxDueDate);
        
        const isDuplicate = checkDuplicateTax(stationData.name, taxName, taxDueDate);
        console.log('충전기 세금 중복 여부:', isDuplicate);
        
        if (!isDuplicate) {
          const chargerTax = {
            name: taxName,
            amount: '미정',
            dueDate: taxDueDate,
            category: '취득세',
            stationName: stationData.name,
            address: stationData.address,
            status: 'accounting_review',
            isRecurring: false,
            uploadedAt: koreaTimeUtils.getKoreaToday(),
            completedDate: null,
            // 추가 메타데이터
            autoGenerated: true,
            sourceType: 'station_safety',
            sourceDate: stationData.safetyCheckDate
          };
          
          taxesToCreate.push(chargerTax);
          console.log('충전기 취득세 생성 준비:', chargerTax);
        }
      }
      
      // 취득세들을 순차적으로 생성
      const createdTaxes = [];
      for (const tax of taxesToCreate) {
        try {
          console.log(`${tax.name} addBill 실행...`);
          const result = await addBill(tax);
          console.log(`${tax.name} addBill 성공:`, result);
          createdTaxes.push(tax);
        } catch (error) {
          console.error(`${tax.name} addBill 실패:`, error);
          showError(`${tax.name} 자동 등록에 실패했습니다: ${error.message}`);
        }
      }
      
      // 알림 생성
      if (stationData.approvalDate && stationData.approvalDate.trim() !== '' && stationData.needsApproval) {
        const canopyTax = createdTaxes.find(tax => tax.name === "캐노피 취득세");
        setNotifications(prev => [...prev, {
          id: `approval-${Date.now()}-${Math.random()}`,
          type: 'approval_added',
          stationName: stationData.name,
          date: stationData.approvalDate,
          createdAt: koreaTimeUtils.getKoreaToday(),
          message: canopyTax 
            ? `${stationData.name} 사용 승인일 추가됨\n캐노피 취득세 자동 등록 완료 (납부 기한: ${canopyTax.dueDate})`
            : `${stationData.name} 사용 승인일 추가됨`
        }]);
        console.log('승인일 알림 생성됨');
      }
      
      if (stationData.safetyCheckDate && stationData.safetyCheckDate.trim() !== '') {
        const chargerTax = createdTaxes.find(tax => tax.name === "충전기 취득세");
        setNotifications(prev => [...prev, {
          id: `safety-${Date.now()}-${Math.random()}`,
          type: 'safety_added',
          stationName: stationData.name,
          date: stationData.safetyCheckDate,
          createdAt: koreaTimeUtils.getKoreaToday(),
          message: chargerTax 
            ? `${stationData.name} 전기 안전 점검일 추가됨\n충전기 취득세 자동 등록 완료 (납부 기한: ${chargerTax.dueDate})`
            : `${stationData.name} 전기 안전 점검일 추가됨`
        }]);
        console.log('점검일 알림 생성됨');
      }
      
      // 폼 업데이트
      if (showAnalysisModal && analyzedData) {
        setAnalyzedData({ ...analyzedData, stationName: newStation.name, address: newStation.address });
      } else if (showAddForm) {
        setNewBill({ ...newBill, stationName: newStation.name, address: newStation.address });
      }
      
      // 폼 초기화
      setNewStation({ name: '', address: '', status: 'operating', approvalDate: '', safetyCheckDate: '', registeredDate: koreaTimeUtils.getKoreaToday() });
      setShowStationForm(false);
      
      // 성공 메시지 표시
      if (createdTaxes.length > 0) {
        const taxNames = createdTaxes.map(tax => tax.name).join(', ');
        showSuccess(`충전소가 추가되었습니다. ${taxNames}이(가) 자동 등록되었습니다.`);
      } else {
        showSuccess('충전소가 추가되었습니다.');
      }
    }
      }, [newStation, addStation, showAnalysisModal, analyzedData, showAddForm, newBill, showSuccess, showError, bills]);

  const handleEditStation = useCallback(async () => {
    if (editingStation && newStation.name && newStation.address) {
      // 날짜에서 60일 더하는 함수 (로컬)
      const calculateTaxDueDate = (originalDate) => {
        const date = new Date(originalDate);
        date.setDate(date.getDate() + 60); // 60일 후
        return date.toISOString().split('T')[0];
      };

      // 중복 취득세 체크 함수 (로컬)
      const checkDuplicateTax = (stationName, taxName, dueDate) => {
        return bills.some(bill => 
          bill.stationName === stationName && 
          bill.name === taxName && 
          bill.dueDate === dueDate &&
          bill.category === '취득세'
        );
      };

      const oldStation = editingStation;
      
      // 충전소 정보 업데이트
      updateStation(editingStation.name, newStation);
      
      // 관련 세금의 충전소명과 주소 업데이트
      setBills(prev => prev.map(bill => 
        bill.stationName === editingStation.name ? 
        { ...bill, stationName: newStation.name, address: newStation.address } : bill
      ));
      
      // 새로 추가된 날짜에 대한 취득세 자동 생성
      const taxesToCreate = [];
      
      // 승인일이 새로 입력되거나 변경된 경우 - 캐노피 취득세
      if (newStation.approvalDate && newStation.approvalDate.trim() !== '' && 
          (!oldStation.approvalDate || oldStation.approvalDate.trim() === '' || oldStation.approvalDate !== newStation.approvalDate)) {
        
        const taxDueDate = calculateTaxDueDate(newStation.approvalDate);
        const taxName = "캐노피 취득세";
        
        const isDuplicate = checkDuplicateTax(newStation.name, taxName, taxDueDate);
        
        if (!isDuplicate) {
          const canopyTax = {
            name: taxName,
            amount: '미정',
            dueDate: taxDueDate,
            category: '취득세',
            stationName: newStation.name,
            address: newStation.address,
            status: 'accounting_review',
            isRecurring: false,
            uploadedAt: koreaTimeUtils.getKoreaToday(),
            completedDate: null,
            // 추가 메타데이터
            autoGenerated: true,
            sourceType: 'station_approval',
            sourceDate: newStation.approvalDate
          };
          
          taxesToCreate.push(canopyTax);
          console.log('캐노피 취득세 생성 준비 (편집):', canopyTax);
        }
        
        // 승인일 알림 생성 (알림 체크된 경우만)
        if (newStation.needsApproval) {
          const canopyTax = taxesToCreate.find(tax => tax.name === "캐노피 취득세");
          setNotifications(prev => [...prev, {
            id: `approval-${Date.now()}-${Math.random()}`,
            type: 'approval_added',
            stationName: newStation.name,
            date: newStation.approvalDate,
            createdAt: koreaTimeUtils.getKoreaToday(),
            message: canopyTax 
              ? `${newStation.name} 사용 승인일이 추가되었습니다: ${newStation.approvalDate}\n캐노피 취득세 자동 등록 완료 (납부 기한: ${canopyTax.dueDate})`
              : `${newStation.name} 사용 승인일이 추가되었습니다: ${newStation.approvalDate}`
          }]);
          console.log('사용 승인일 알림 생성 (알림 체크됨):', newStation.name, newStation.approvalDate);
        }
      }
      
      // 점검일이 새로 입력되거나 변경된 경우 - 충전기 취득세
      if (newStation.safetyCheckDate && newStation.safetyCheckDate.trim() !== '' && 
          (!oldStation.safetyCheckDate || oldStation.safetyCheckDate.trim() === '' || oldStation.safetyCheckDate !== newStation.safetyCheckDate)) {
        
        const taxDueDate = calculateTaxDueDate(newStation.safetyCheckDate);
        const taxName = "충전기 취득세";
        
        const isDuplicate = checkDuplicateTax(newStation.name, taxName, taxDueDate);
        
        if (!isDuplicate) {
          const chargerTax = {
            name: taxName,
            amount: '미정',
            dueDate: taxDueDate,
            category: '취득세',
            stationName: newStation.name,
            address: newStation.address,
            status: 'accounting_review',
            isRecurring: false,
            uploadedAt: koreaTimeUtils.getKoreaToday(),
            completedDate: null,
            // 추가 메타데이터
            autoGenerated: true,
            sourceType: 'station_safety',
            sourceDate: newStation.safetyCheckDate
          };
          
          taxesToCreate.push(chargerTax);
          console.log('충전기 취득세 생성 준비 (편집):', chargerTax);
        }
        
        // 점검일 알림 생성
        const chargerTax = taxesToCreate.find(tax => tax.name === "충전기 취득세");
        setNotifications(prev => [...prev, {
          id: `safety-${Date.now()}-${Math.random()}`,
          type: 'safety_added',
          stationName: newStation.name,
          date: newStation.safetyCheckDate,
          createdAt: koreaTimeUtils.getKoreaToday(),
          message: chargerTax 
            ? `${newStation.name} 전기 안전 점검일이 추가되었습니다: ${newStation.safetyCheckDate}\n충전기 취득세 자동 등록 완료 (납부 기한: ${chargerTax.dueDate})`
            : `${newStation.name} 전기 안전 점검일이 추가되었습니다: ${newStation.safetyCheckDate}`
        }]);
        console.log('안전 점검일 알림 생성:', newStation.name, newStation.safetyCheckDate);
      }
      
      // 취득세들을 순차적으로 생성
      const createdTaxes = [];
      for (const tax of taxesToCreate) {
        try {
          console.log(`${tax.name} addBill 실행 (편집)...`);
          const result = await addBill(tax);
          console.log(`${tax.name} addBill 성공 (편집):`, result);
          createdTaxes.push(tax);
        } catch (error) {
          console.error(`${tax.name} addBill 실패 (편집):`, error);
          showError(`${tax.name} 자동 등록에 실패했습니다: ${error.message}`);
        }
      }
      
      // 폼 초기화
      setEditingStation(null);
      setNewStation({ name: '', address: '', status: 'operating', approvalDate: '', safetyCheckDate: '', registeredDate: koreaTimeUtils.getKoreaToday() });
      setShowStationForm(false);
      
      // 성공 메시지 표시
      if (createdTaxes.length > 0) {
        const taxNames = createdTaxes.map(tax => tax.name).join(', ');
        showSuccess(`충전소 정보가 수정되었습니다. ${taxNames}이(가) 자동 등록되었습니다.`);
      } else {
        showSuccess('충전소 정보가 수정되었습니다.');
      }
    }
      }, [editingStation, newStation, updateStation, setBills, showSuccess, showError, bills]);

// 칸반 보드 관련 컴포넌트들
const KanbanColumnHeader = ({ title, status, icon: IconComponent, billsCount }) => (
  <div className="flex items-center justify-between mb-6">
    <h2 className="font-medium text-gray-100 flex items-center">
      <IconComponent className="w-5 h-5 mr-3 text-slate-400" />
      {title}
      <span className="ml-3 bg-slate-600/30 text-slate-300 px-3 py-1 rounded-full text-sm font-medium">
        {billsCount}
      </span>
    </h2>
  </div>
);

const KanbanPagination = ({ 
  currentPage, 
  totalPages, 
  onPageChange, 
  status,
  totalItems,
  itemsPerPage 
}) => {
  if (totalPages <= 1) return null;

  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalItems);

  return (
    <>
      {/* 페이지네이션 버튼 */}
      <div className="flex items-center justify-center mt-4 pt-4 border-t border-slate-600/30">
        <div className="flex items-center space-x-2">
          <button
            onClick={() => onPageChange(status, Math.max(currentPage - 1, 1))}
            disabled={currentPage === 1}
            className={`px-3 py-1 text-sm rounded-lg transition-colors ${
              currentPage === 1 
                ? 'bg-slate-700/30 text-gray-500 cursor-not-allowed' 
                : `${COLOR_SYSTEM.secondary.bg} ${COLOR_SYSTEM.secondary.text} ${COLOR_SYSTEM.secondary.bgHover} border ${COLOR_SYSTEM.secondary.border}/30`
            }`}
          >
            이전
          </button>
          
          <div className="flex items-center space-x-1">
            {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
              let pageNum;
              if (totalPages <= 5) {
                pageNum = i + 1;
              } else if (currentPage <= 3) {
                pageNum = i + 1;
              } else if (currentPage >= totalPages - 2) {
                pageNum = totalPages - 4 + i;
              } else {
                pageNum = currentPage - 2 + i;
              }
              
              return (
                <button
                  key={pageNum}
                  onClick={() => onPageChange(status, pageNum)}
                  className={`w-8 h-8 text-sm rounded-lg transition-colors ${
                    currentPage === pageNum
                      ? `${COLOR_SYSTEM.primary.bg} text-white`
                      : `bg-slate-700/50 text-gray-300 hover:bg-slate-600/50`
                  }`}
                >
                  {pageNum}
                </button>
              );
            })}
          </div>
          
          <button
            onClick={() => onPageChange(status, Math.min(currentPage + 1, totalPages))}
            disabled={currentPage === totalPages}
            className={`px-3 py-1 text-sm rounded-lg transition-colors ${
              currentPage === totalPages 
                ? 'bg-slate-700/30 text-gray-500 cursor-not-allowed' 
                : `${COLOR_SYSTEM.secondary.bg} ${COLOR_SYSTEM.secondary.text} ${COLOR_SYSTEM.secondary.bgHover} border ${COLOR_SYSTEM.secondary.border}/30`
            }`}
          >
            다음
          </button>
        </div>
      </div>
      
      {/* 페이지 정보 */}
      <div className="text-center mt-2 text-xs text-slate-400">
        {totalItems > 0 ? (
          <>
            {startIndex + 1}-{endIndex} / {totalItems}개
            {totalPages > 1 && ` (${currentPage}/${totalPages} 페이지)`}
          </>
        ) : (
          `총 ${totalItems}개`
        )}
      </div>
    </>
  );
};

const KanbanColumn = ({ 
  title, 
  status, 
  icon, 
  bills, 
  onStatusChange, 
  onBillClick, 
  isViewerOnly,
  currentPage,
  onPageChange 
}) => {
  const IconComponent = icon;
  const itemsPerPage = 5;
  const totalPages = Math.ceil(bills.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedBills = bills.slice(startIndex, endIndex);
  
  return (
    <div className={`${COLOR_SYSTEM.cards.primary} backdrop-blur-md rounded-2xl p-6 border`}>
      <KanbanColumnHeader 
        title={title}
        status={status}
        icon={IconComponent}
        billsCount={bills.length}
      />
      
      <div className="space-y-3 min-h-[400px]">
        {paginatedBills.map(bill => (
          <BillCard 
            key={bill.id} 
            bill={bill} 
            onStatusChange={!isViewerOnly ? onStatusChange : null} 
            onClick={!isViewerOnly ? () => onBillClick(bill) : null} 
          />
        ))}
        {bills.length === 0 && (
          <div className="text-center py-8 text-gray-500 text-sm">
            조회된 세금 정보가 없습니다
          </div>
        )}
      </div>
      
      <KanbanPagination
        currentPage={currentPage}
        totalPages={totalPages}
        onPageChange={onPageChange}
        status={status}
        totalItems={bills.length}
        itemsPerPage={itemsPerPage}
      />
    </div>
  );
};

const KanbanBoard = ({ 
  getBillsByStatus, 
  updateBillStatus, 
  handleBillClick, 
  isViewerOnly,
  kanbanPages,
  setKanbanPages 
}) => {
  const handlePageChange = (status, newPage) => {
    setKanbanPages(prev => ({ ...prev, [status]: newPage }));
  };

  const kanbanColumns = [
    {
      title: '회계사 검토',
      status: 'accounting_review',
      icon: AlertCircle,
      bills: getBillsByStatus('accounting_review')
    },
    {
      title: '납부 예정',
      status: 'pending',
      icon: Clock,
      bills: getBillsByStatus('pending')
    },
    {
      title: '납부 완료',
      status: 'completed',
      icon: CheckCircle,
      bills: getBillsByStatus('completed')
    }
  ];

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 lg:gap-8 mb-6">
      {kanbanColumns.map(column => (
        <KanbanColumn
          key={column.status}
          title={column.title}
          status={column.status}
          icon={column.icon}
          bills={column.bills}
          onStatusChange={updateBillStatus}
          onBillClick={handleBillClick}
          isViewerOnly={isViewerOnly}
          currentPage={kanbanPages[column.status] || 1}
          onPageChange={handlePageChange}
        />
      ))}
    </div>
  );
};

  const renderDashboardView = () => (
    <div className="w-full px-6 py-8 min-h-screen">
      {/* 헤더 섹션 */}
      <div className="mb-6">
        <div className="mb-4">
          <h1 className="text-4xl font-bold text-gray-100 mb-2">
            대시보드
          </h1>
          <div className="text-sm text-gray-400 mb-4">
            최종 업데이트: {new Date().toLocaleDateString('ko-KR', { 
              timeZone: 'Asia/Seoul',
              year: 'numeric',
              month: '2-digit', 
              day: '2-digit'
            }).replace(/\./g, '-').replace(/ /g, '').slice(0, -1)}
          </div>
          
          {/* 빠른 액션 버튼들 - 좌측 정렬로 이동 */}
          <div className="flex items-center space-x-3">
            <Button 
              onClick={() => setCurrentView('kanban')} 
              variant="primary"
              icon={CheckCircle}
              size="sm"
            >
              세금 관리
            </Button>
            <Button 
              onClick={() => setCurrentView('stations')} 
              variant="secondary"
              icon={Zap}
              size="sm"
            >
              충전소 관리
            </Button>
            <Button 
              onClick={() => setCurrentView('calendar')} 
              variant="accent"
              icon={Calendar}
              size="sm"
            >
              캘린더 보기
            </Button>
          </div>
        </div>
      </div>

      {/* 핵심 KPI 카드들 */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <DashboardKPICard 
          title="총 세금액"
          value={`₩${utils.formatKoreanCurrency(overallStats.totalAmount)}`}
          subtitle={`${overallStats.totalBills}건`}
          icon={FileText}
          progressWidth={100}
          progressColor="bg-slate-500"
        />
        <DashboardKPICard 
          title="납부 완료"
          value={`₩${utils.formatKoreanCurrency(overallStats.completedAmount)}`}
          subtitle={`${bills.filter(b => b.status === 'completed').length}건`}
          icon={CheckCircle}
          progressWidth={overallStats.totalAmount > 0 ? (overallStats.completedAmount / overallStats.totalAmount) * 100 : 0}
          progressColor="bg-slate-600"
        />
        <DashboardKPICard 
          title="납부 예정"
          value={`₩${utils.formatKoreanCurrency(overallStats.pendingAmount)}`}
          subtitle={`${bills.filter(b => b.status === 'pending' || b.status === 'accounting_review').length}건`}
          icon={Clock}
          progressWidth={overallStats.totalAmount > 0 ? (overallStats.pendingAmount / overallStats.totalAmount) * 100 : 0}
          progressColor="bg-slate-700"
        />
      </div>

      {/* 월별 세금 현황 */}
      <DashboardMonthlyChart 
        monthlyStats={getMonthlyStats}
        formatKoreanCurrency={utils.formatKoreanCurrency}
      />


    </div>
  );

// 캘린더 관련 컴포넌트들
const CalendarHeader = ({ currentDate, setCurrentDate, koreaTimeUtils }) => (
  <div className={CARD_STYLES + " p-6 mb-6"}>
    <div className="flex items-center justify-between mb-6">
      <h2 className="text-2xl font-bold text-gray-100">
        {currentDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' })}
      </h2>
      <div className="flex items-center space-x-4">
        <Button 
          onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))}
          variant="ghost"
          size="sm"
          className="!p-2"
          title="이전 달"
        >
          ←
        </Button>
        <div className="text-center">
          <Button 
            onClick={() => setCurrentDate(koreaTimeUtils.getKoreaTime())}
            variant="primary"
            size="sm"
          >
            오늘
          </Button>
        </div>
        <Button 
          onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))}
          variant="ghost"
          size="sm"
          className="!p-2"
          title="다음 달"
        >
          →
        </Button>
      </div>
    </div>
  </div>
);

const CalendarWeekHeader = () => (
  <div className="grid grid-cols-7 gap-2 mb-4">
    {['일', '월', '화', '수', '목', '금', '토'].map(day => (
      <div key={day} className="text-center text-gray-400 font-medium py-2">{day}</div>
    ))}
  </div>
);

const CalendarDayCell = ({ 
  date, 
  currentDate, 
  koreaTimeUtils, 
  dateBills, 
  completedBills, 
  stationEvents, 
  handleDateClick, 
  utils 
}) => {
  const isCurrentMonth = date.getMonth() === currentDate.getMonth();
  const isToday = koreaTimeUtils.formatKoreaDate(date) === koreaTimeUtils.getKoreaToday();
  
  // 세금 분류별 금액 합계 계산
  const taxSummary = {};
  ['취득세', '재산세', '기타세'].forEach(category => {
    const categoryBills = dateBills.filter(bill => bill.category === category);
    const totalAmount = categoryBills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
    const hasUndefinedAmount = categoryBills.some(bill => bill.amount === '미정' || bill.amount === '' || !bill.amount);
    
    taxSummary[category] = {
      amount: totalAmount,
      hasUndefined: hasUndefinedAmount,
      count: categoryBills.length
    };
  });
  
  const hasEvents = dateBills.length > 0 || completedBills.length > 0 || stationEvents.length > 0;
  
  return (
    <div className={`min-h-[100px] p-2 rounded-lg border transition-all duration-200 ${
      isCurrentMonth 
        ? 'border-slate-600/50 hover:border-slate-500/50 hover:bg-slate-700/30' 
        : 'border-slate-700/30 opacity-50'
    } ${isToday ? 'bg-blue-900/30 border-blue-500/50' : ''}`}>
      <div className={`text-sm font-medium mb-2 ${
        isCurrentMonth ? 'text-gray-200' : 'text-gray-500'
      } ${isToday ? 'text-blue-300' : ''}`}>
        {date.getDate()}
      </div>
      
      <div className="space-y-1">
        {/* 세금 분류별 금액 표시 */}
        {Object.entries(taxSummary).map(([category, data]) => {
          if (data.count === 0) return null;
          
          const colorClass = {
            '취득세': 'bg-orange-500/80 hover:bg-orange-500 border-orange-400/50',
            '재산세': 'bg-blue-500/80 hover:bg-blue-500 border-blue-400/50',
            '기타세': 'bg-purple-500/80 hover:bg-purple-500 border-purple-400/50'
          }[category];
          
          return (
            <button 
              key={category}
              onClick={() => handleDateClick(date, dateBills.filter(bill => bill.category === category), stationEvents, completedBills)}
              className={`w-full ${colorClass} text-white text-xs px-2 py-1 rounded border transition-all duration-200 font-medium cursor-pointer hover:shadow-md`}
            >
              <div className="flex items-center justify-between">
                <span className="text-[10px] opacity-90">{category}</span>
                <span className="font-mono text-[10px]">
                  {data.hasUndefined && data.amount === 0 ? '미정' : 
                   data.hasUndefined && data.amount > 0 ? `₩${utils.formatKoreanCurrency(data.amount)}+미정` :
                   `₩${utils.formatKoreanCurrency(data.amount)}`}
                </span>
              </div>
            </button>
          );
        })}
        
        {/* 납부 완료 */}
        {completedBills.length > 0 && (
          <Button 
            onClick={() => handleDateClick(date, [], stationEvents, completedBills)}
            variant="ghost"
            size="sm"
            className="w-full bg-gray-500/10 hover:bg-gray-500/20 text-white text-xs border border-gray-400/50 font-medium cursor-pointer hover:shadow-md !p-2"
          >
            <div className="flex items-center justify-between w-full">
              <span className="text-[10px] opacity-90">완료</span>
              <span className="font-mono text-[10px]">
                ₩{utils.formatKoreanCurrency(completedBills.reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0))}
              </span>
            </div>
          </Button>
        )}
        
        {/* 충전소 이벤트 */}
        {stationEvents.length > 0 && (
          <Button 
            onClick={() => handleDateClick(date, dateBills, stationEvents, completedBills)}
            variant="ghost"
            size="sm"
            className="w-full bg-emerald-500/10 hover:bg-emerald-500/20 text-white text-xs border border-emerald-400/50 font-medium cursor-pointer hover:shadow-md !p-2"
          >
            <div className="text-center w-full">
              <span className="text-[10px]">충전소 일정 {stationEvents.length}건</span>
            </div>
          </Button>
        )}
      </div>
    </div>
  );
};

const CalendarGrid = ({ 
  currentDate, 
  koreaTimeUtils, 
  getBillsForDate, 
  getCompletedBillsForDate, 
  getStationEventsForDate, 
  handleDateClick, 
  utils 
}) => {
  // 캘린더 날짜 생성 로직
  const getCalendarDays = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const days = [];
    const endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + 42);
    
    // 한국 시간 기준으로 날짜 생성
    for (let date = new Date(startDate); date < endDate; date.setDate(date.getDate() + 1)) {
      // 한국 시간 기준으로 정오 설정하여 시간대 변환 문제 방지
      const dayDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
      days.push(dayDate);
    }
    
    return days;
  };

  return (
    <div className="grid grid-cols-7 gap-2">
      {getCalendarDays().map((date, index) => {
        const dateBills = getBillsForDate(date);
        const completedBills = getCompletedBillsForDate(date);
        const stationEvents = getStationEventsForDate(date);
        
        return (
          <CalendarDayCell
            key={index}
            date={date}
            currentDate={currentDate}
            koreaTimeUtils={koreaTimeUtils}
            dateBills={dateBills}
            completedBills={completedBills}
            stationEvents={stationEvents}
            handleDateClick={handleDateClick}
            utils={utils}
          />
        );
      })}
    </div>
  );
};

const CalendarLegend = () => (
  <div className="flex justify-end mt-4">
    <div className="bg-slate-800/80 backdrop-blur-sm rounded-lg p-3 border border-slate-600/50">
      <div className="flex items-center space-x-4 text-xs">
        <div className="flex items-center space-x-2">
          <div className="w-2 h-2 bg-orange-500 rounded-full"></div>
          <span className="text-gray-300">취득세</span>
        </div>
        <div className="flex items-center space-x-2">
          <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
          <span className="text-gray-300">재산세</span>
        </div>
        <div className="flex items-center space-x-2">
          <div className="w-2 h-2 bg-purple-500 rounded-full"></div>
          <span className="text-gray-300">기타세</span>
        </div>
        <div className="flex items-center space-x-2">
          <div className="w-2 h-2 bg-gray-500 rounded-full"></div>
          <span className="text-gray-300">완료</span>
        </div>
        <div className="flex items-center space-x-2">
          <div className="w-2 h-2 bg-emerald-500 rounded-full"></div>
          <span className="text-gray-300">충전소 일정</span>
        </div>
      </div>
    </div>
  </div>
);

const CalendarView = ({ 
  currentDate, 
  setCurrentDate, 
  bills, 
  enhancedStations, 
  koreaTimeUtils, 
  utils, 
  getBillsForDate, 
  getStationEventsForDate, 
  getCompletedBillsForDate, 
  handleDateClick 
}) => (
  <div className="w-full px-6 py-8">
    <div className="mb-8">
      <h2 className="text-2xl font-bold text-gray-100 mb-2">캘린더</h2>
    </div>

    <CalendarHeader 
      currentDate={currentDate}
      setCurrentDate={setCurrentDate}
      koreaTimeUtils={koreaTimeUtils}
    />

    <div className={CARD_STYLES + " p-6"}>
      <CalendarWeekHeader />
      
      <CalendarGrid
        currentDate={currentDate}
        koreaTimeUtils={koreaTimeUtils}
        getBillsForDate={getBillsForDate}
        getCompletedBillsForDate={getCompletedBillsForDate}
        getStationEventsForDate={getStationEventsForDate}
        handleDateClick={handleDateClick}
        utils={utils}
      />
    </div>

    <CalendarLegend />
  </div>
);

// 충전소 테이블 행 컴포넌트 (재사용성 개선)
const StationTableRow = ({ station, bills, onStationSelect, utils }) => (
  <tr className="hover:bg-slate-700/30 transition-colors">
    <td className="px-4 py-4 min-w-[180px]">
      <button 
        onClick={() => onStationSelect(station)}
        className="font-semibold text-blue-400 hover:text-blue-300 transition-colors text-left max-w-[160px] truncate block"
        title={station.name}
      >
        {station.name}
      </button>
    </td>
    <td className="px-4 py-4 text-center min-w-[100px]">
      <span className="inline-flex items-center justify-center w-10 h-8 bg-blue-500/20 text-blue-300 rounded-lg text-sm font-medium whitespace-nowrap">
        {station.totalBills}
      </span>
    </td>
    <td className="px-4 py-4 text-right min-w-[140px]">
      <div className="font-mono text-emerald-300 font-medium whitespace-nowrap">
        ₩{utils.formatKoreanCurrency(
          bills.filter(bill => bill.stationName === station.name && bill.status === 'completed')
            .reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0)
        )}
      </div>
    </td>
    <td className="px-4 py-4 text-center min-w-[120px]">
      <span className={`text-sm whitespace-nowrap ${station.approvalDate ? 'text-blue-300 font-mono' : 'text-gray-500'}`}>
        {station.approvalDate || '미입력'}
      </span>
    </td>
    <td className="px-4 py-4 text-center min-w-[140px]">
      <span className={`text-sm whitespace-nowrap ${station.safetyCheckDate ? 'text-blue-300 font-mono' : 'text-gray-500'}`}>
        {station.safetyCheckDate || '미입력'}
      </span>
    </td>
    <td className="px-4 py-4 text-center min-w-[100px]">
      <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border whitespace-nowrap ${
        station.status === 'operating' 
          ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' 
          : station.status === 'preparing' 
          ? 'bg-amber-500/20 text-amber-300 border-amber-500/30' 
          : 'bg-gray-500/20 text-gray-300 border-gray-500/30'
      }`}>
        <div className={`w-2 h-2 rounded-full mr-1 flex-shrink-0 ${
          station.status === 'operating' 
            ? 'bg-emerald-500 animate-pulse' 
            : station.status === 'preparing' 
            ? 'bg-amber-500' 
            : 'bg-gray-500'
        }`}></div>
        <span className="truncate">
          {station.status === 'operating' ? '운영 중' : station.status === 'preparing' ? '오픈 예정' : '운영 종료'}
        </span>
      </span>
    </td>
  </tr>
);

// 충전소 테이블 페이지네이션 컴포넌트
const StationTablePagination = ({ 
  currentPage, 
  totalPages, 
  onPageChange, 
  filteredCount, 
  totalCount, 
  itemsPerPage 
}) => {
  if (totalPages <= 1) return null;

  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, filteredCount);

  return (
    <div className="flex items-center justify-between">
      <div className="text-sm text-gray-400">
        {filteredCount > 0 && (
          <>
            {startIndex + 1}-{endIndex} / {filteredCount}개 표시
            {filteredCount !== totalCount && ` (전체 ${totalCount}개 중)`}
          </>
        )}
      </div>
      
      <div className="flex items-center space-x-2">
        <button
          onClick={() => onPageChange(1)}
          disabled={currentPage === 1}
          className="px-3 py-1 text-sm bg-slate-600/50 text-gray-300 rounded-lg hover:bg-slate-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          처음
        </button>
        <button
          onClick={() => onPageChange(Math.max(currentPage - 1, 1))}
          disabled={currentPage === 1}
          className="px-3 py-1 text-sm bg-slate-600/50 text-gray-300 rounded-lg hover:bg-slate-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          이전
        </button>
        
        <div className="flex items-center space-x-1">
          {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
            let pageNum;
            if (totalPages <= 5) {
              pageNum = i + 1;
            } else if (currentPage <= 3) {
              pageNum = i + 1;
            } else if (currentPage >= totalPages - 2) {
              pageNum = totalPages - 4 + i;
            } else {
              pageNum = currentPage - 2 + i;
            }
            
            return (
              <button
                key={pageNum}
                onClick={() => onPageChange(pageNum)}
                className={`w-8 h-8 text-sm rounded-lg transition-colors ${
                  currentPage === pageNum
                    ? 'bg-blue-600 text-white'
                    : 'bg-slate-600/50 text-gray-300 hover:bg-slate-500/50'
                }`}
              >
                {pageNum}
              </button>
            );
          })}
        </div>
        
        <button
          onClick={() => onPageChange(Math.min(currentPage + 1, totalPages))}
          disabled={currentPage === totalPages}
          className="px-3 py-1 text-sm bg-slate-600/50 text-gray-300 rounded-lg hover:bg-slate-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          다음
        </button>
        <button
          onClick={() => onPageChange(totalPages)}
          disabled={currentPage === totalPages}
          className="px-3 py-1 text-sm bg-slate-600/50 text-gray-300 rounded-lg hover:bg-slate-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          마지막
        </button>
      </div>
    </div>
  );
};

// 충전소 테이블 액션 버튼들
const StationTableActions = ({ 
  isViewerOnly, 
  onDownloadCSV, 
  onCSVUpload, 
  onAddStation 
}) => (
  <div className="flex justify-end items-center space-x-3 mt-4">
    <Button
      onClick={onDownloadCSV}
      variant="accent"
      size="sm"
      icon={(props) => (
        <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      )}
    >
      CSV 다운로드
    </Button>
    
    {!isViewerOnly && (
      <>
        <label className="inline-flex items-center px-4 py-2 bg-gradient-to-r from-slate-800 to-slate-700 hover:from-slate-700 hover:to-slate-600 text-white rounded-xl transition-all duration-200 font-medium shadow-lg hover:shadow-slate-600/25 cursor-pointer text-sm">
          <Upload className="w-4 h-4 mr-2" />
          CSV 일괄등록
          <input 
            type="file" 
            accept=".csv" 
            onChange={onCSVUpload} 
            className="hidden" 
          />
        </label>
        
        <Button
          onClick={onAddStation}
          variant="primary"
          size="sm"
          icon={Plus}
        >
          충전소 추가
        </Button>
      </>
    )}
  </div>
);

// 충전소 빈 상태 컴포넌트
const StationEmptyState = ({ hasFilters, isViewerOnly, onAddStation }) => (
  <div className="text-center py-12">
    <div className="text-gray-400 mb-4">
      {hasFilters ? '검색 조건에 맞는 충전소가 없습니다' : '등록된 충전소가 없습니다'}
    </div>
    {!hasFilters && !isViewerOnly && (
      <Button
        onClick={onAddStation}
        variant="primary"
        size="md"
      >
        첫 충전소 추가하기
      </Button>
    )}
  </div>
);

  const renderStationsView = () => {
    const handleStationSelect = (station) => {
      setSelectedStationForDetail(station);
      setShowStationDetailPage(true);
    };

    const handleDownloadCSV = () => {
      try {
        if (enhancedStations.length === 0) {
          showError('다운로드할 충전소 데이터가 없습니다.');
          return;
        }
        
        const csvData = ExcelExportUtils.formatStationsForExcel(enhancedStations, bills);
        const today = koreaTimeUtils.getKoreaToday().replace(/-/g, '');
        const filename = `충전소현황_${today}.csv`;
        
        ExcelExportUtils.downloadCSVInstant(csvData, filename);
        showSuccess('CSV 파일 다운로드가 시작되었습니다.');
      } catch (error) {
        showError(error.message || 'CSV 다운로드에 실패했습니다.');
      }
    };

    const handleAddStation = () => {
      setShowStationForm(true);
      setEditingStation(null);
      setNewStation({ 
        name: '', 
        address: '', 
        status: 'operating', 
        approvalDate: '', 
        safetyCheckDate: '',
        registeredDate: koreaTimeUtils.getKoreaToday()
      });
    };

    const hasFilters = stationFilters.search || stationFilters.status !== 'all';

    return (
      <div className="w-full px-6 py-8">
        <div className="mb-8">
          <h2 className="text-2xl font-bold text-gray-100 mb-2">충전소 관리</h2>
        </div>

        <StationFiltersPanel 
          filters={stationFilters}
          onFiltersChange={setStationFilters}
          onReset={() => { resetStationFilters(); setStationPage(1); }}
          isMobile={isMobile}
          showMobileFilters={showMobileFilters}
          setShowMobileFilters={setShowMobileFilters}
        />
        
        {filteredStationsForManagement.length === 0 ? (
          <StationEmptyState 
            hasFilters={hasFilters}
            isViewerOnly={isViewerOnly}
            onAddStation={handleAddStation}
          />
        ) : (
          <>
            <div className={CARD_STYLES + " overflow-hidden"}>
              <div className="border border-slate-600/50 rounded-lg mx-4 my-4 overflow-hidden">
                <div className="overflow-x-auto custom-scrollbar">
                  <table className="w-full min-w-[1000px] bg-slate-800/30">
                    <thead className="bg-slate-700/70 border-b border-slate-600/50">
                      <tr>
                        <th className="px-4 py-4 text-left text-sm font-medium text-gray-300 min-w-[180px] whitespace-nowrap">충전소명</th>
                        <th className="px-4 py-4 text-center text-sm font-medium text-gray-300 min-w-[100px] whitespace-nowrap">납부 완료 건수</th>
                        <th className="px-4 py-4 text-right text-sm font-medium text-gray-300 min-w-[140px] whitespace-nowrap">총 납부 금액</th>
                        <th className="px-4 py-4 text-center text-sm font-medium text-gray-300 min-w-[120px] whitespace-nowrap">사용 승인일</th>
                        <th className="px-4 py-4 text-center text-sm font-medium text-gray-300 min-w-[140px] whitespace-nowrap">전기 안전 점검일</th>
                        <th className="px-4 py-4 text-center text-sm font-medium text-gray-300 min-w-[100px] whitespace-nowrap">상태</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-600/30">
                      {paginatedStations.map((station, index) => (
                        <StationTableRow
                          key={station.name || index}
                          station={station}
                          bills={bills}
                          onStationSelect={handleStationSelect}
                          utils={utils}
                        />
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div className="px-6 py-4 bg-slate-700/30 border-t border-slate-600/50">
                <StationTablePagination
                  currentPage={stationPage}
                  totalPages={totalStationPages}
                  onPageChange={setStationPage}
                  filteredCount={filteredStationsForManagement.length}
                  totalCount={enhancedStations.length}
                  itemsPerPage={stationsPerPage}
                />
              </div>
            </div>
            
            {/* 액션 버튼들 - 통일된 스타일 */}
            <div className="flex justify-end items-center space-x-3 mt-4">
              <Button
                onClick={handleDownloadCSV}
                variant="secondary"
                size="sm"
                icon={(props) => (
                  <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                )}
              >
                CSV 다운로드
              </Button>
              
              {!isViewerOnly && (
                <>
                  <Button
                    onClick={() => document.getElementById('station-csv-upload').click()}
                    variant="accent"
                    size="sm"
                    icon={Upload}
                  >
                    CSV 일괄등록
                    <input 
                      id="station-csv-upload"
                      type="file" 
                      accept=".csv" 
                      onChange={(e) => handleCSVUpload(e.target.files)} 
                      className="hidden" 
                    />
                  </Button>
                  
                  <Button
                    onClick={handleAddStation}
                    variant="primary"
                    size="sm"
                    icon={Plus}
                  >
                    충전소 추가
                  </Button>
                </>
              )}
            </div>
          </>
        )}
      </div>
    );
  };

  // 로그인 상태 변화 감지 및 뷰 동기화 - Vercel 배포용 수정
  useEffect(() => {
    if (isLoggedIn) {
      // 로그인 성공 시 대시보드로 이동 (login 뷰에서 벗어남)
      if (currentView === 'login') {
        setCurrentView('dashboard');
      }
    } else {
      // 로그아웃 시 login 뷰로 강제 이동
      setCurrentView('login');
    }
  }, [isLoggedIn, currentView]);

  // 로그인이 필요한 경우에만 로그인 화면 표시
  if (!isLoggedIn) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-gray-900 to-slate-800 flex items-center justify-center p-4">
        <style>{scrollbarStyles}</style>
        
        <div className="w-full max-w-md">
          {/* 로고 및 타이틀 */}
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent mb-2">
              Water TT
            </h1>
            <p className="text-gray-400 text-sm">세금 관리 시스템</p>
          </div>



          {/* 로그인 폼 */}
          <div className="bg-gradient-to-br from-slate-800/50 to-slate-700/30 backdrop-blur-md rounded-2xl p-8 border border-slate-600/30 shadow-2xl">
            {!showForgotPassword ? (
              <>
                <h2 className="text-xl font-semibold text-gray-100 mb-6 text-center">로그인</h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">아이디</label>
                    <input
                      type="email"
                      value={loginForm.email}
                      onChange={(e) => setLoginForm({...loginForm, email: e.target.value})}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm"
                      placeholder="이메일을 입력하세요"
                      disabled={isLoggingIn}
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">패스워드</label>
                    <input
                      type="password"
                      value={loginForm.password}
                      onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm"
                      placeholder="••••••••"
                      disabled={isLoggingIn}
                    />
                  </div>
                  
                  {loginError && (
                    <div className="bg-red-900/20 border border-red-500/30 rounded-xl p-3">
                      <p className="text-red-200 text-sm">{loginError}</p>
                    </div>
                  )}
                </div>
                
                <button
                  onClick={handleLogin}
                  disabled={isLoggingIn || !loginForm.email || !loginForm.password}
                  className="w-full mt-6 px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl hover:from-blue-500 hover:to-blue-400 transition-all duration-200 font-medium shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                >
                  {isLoggingIn ? (
                    <>
                      <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"></div>
                      로그인 중...
                    </>
                  ) : (
                    '로그인'
                  )}
                </button>
                
                <div className="mt-4 text-center">
                  <button
                    onClick={() => setShowForgotPassword(true)}
                    className="text-sm text-gray-400 hover:text-gray-200 transition-colors"
                  >
                    패스워드를 잊으셨나요?
                  </button>
                </div>
              </>
            ) : (
              <>
                <h2 className="text-xl font-semibold text-gray-100 mb-6 text-center">패스워드 찾기</h2>
                
                {!forgotPasswordSent ? (
                  <>
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-300 mb-2">아이디</label>
                        <input
                          type="email"
                          value={forgotPasswordEmail}
                          onChange={(e) => setForgotPasswordEmail(e.target.value)}
                          onKeyPress={(e) => e.key === 'Enter' && handleForgotPassword()}
                          className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm"
                          placeholder="이메일을 입력하세요"
                        />
                      </div>
                      <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-3">
                        <p className="text-blue-200 text-sm">
                          {forgotPasswordEmail && forgotPasswordEmail.trim() 
                            ? '입력하신 아이디로 임시 패스워드를 보내드립니다.' 
                            : '아이디 입력 후 패스워드 전송을 눌러주세요.'}
                        </p>
                      </div>
                    </div>
                    
                    <button
                      onClick={handleForgotPassword}
                      disabled={!forgotPasswordEmail || !forgotPasswordEmail.trim() || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(forgotPasswordEmail)}
                      className="w-full mt-6 px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl hover:from-blue-500 hover:to-blue-400 transition-all duration-200 font-medium shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      패스워드 전송
                    </button>
                  </>
                ) : (
                  <>
                    <div className="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-4 mb-6">
                      <div className="flex items-center">
                        <CheckCircle className="w-5 h-5 text-emerald-300 mr-2" />
                        <p className="text-emerald-200 text-sm">
                          <strong>{forgotPasswordEmail}</strong>로<br />
                          임시 패스워드를 전송했습니다.
                        </p>
                      </div>
                    </div>
                    <div className="text-sm text-gray-400 mb-6">
                      • 이메일을 확인해주세요<br />
                      • 임시 패스워드로 로그인 후 패스워드를 변경하세요<br />
                      • 이메일이 오지 않으면 스팸함을 확인해주세요
                    </div>
                  </>
                )}
                
                <button
                  onClick={() => {
                    setShowForgotPassword(false);
                    setForgotPasswordEmail('');
                    setForgotPasswordSent(false);
                  }}
                  className="w-full px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium"
                >
                  로그인으로 돌아가기
                </button>
              </>
            )}
          </div>
          

        </div>
      </div>
    );
  }

  // === 계정 관리 유틸리티 & 컴포넌트들 ===

// 역할별 설정 유틸리티
const RoleUtils = {
  config: {
    super_admin: {
      label: '시스템 최고 관리자',
      shortLabel: '슈퍼 관리자',
      bgColor: 'bg-gradient-to-br from-purple-600 to-purple-500',
      badgeColor: 'bg-purple-500/20 text-purple-300 border-purple-500/30',
      textColor: 'text-purple-300'
    },
    admin: {
      label: '관리자',
      shortLabel: '관리자',
      bgColor: 'bg-gradient-to-br from-red-600 to-red-500',
      badgeColor: 'bg-red-500/20 text-red-300 border-red-500/30',
      textColor: 'text-red-300'
    },
    editor: {
      label: '편집자',
      shortLabel: '편집자',
      bgColor: 'bg-gradient-to-br from-blue-600 to-blue-500',
      badgeColor: 'bg-blue-500/20 text-blue-300 border-blue-500/30',
      textColor: 'text-blue-300'
    },
    viewer: {
      label: '뷰어',
      shortLabel: '뷰어',
      bgColor: 'bg-gradient-to-br from-gray-600 to-gray-500',
      badgeColor: 'bg-gray-500/20 text-gray-300 border-gray-500/30',
      textColor: 'text-gray-300'
    }
  },

  getRoleConfig: (role) => {
    return RoleUtils.config[role] || RoleUtils.config.viewer;
  },

  getRoleBadgeClass: (role) => {
    return `text-xs px-2 py-1 rounded font-medium border ${RoleUtils.getRoleConfig(role).badgeColor}`;
  },

  getAvatarClass: (role, size = 'md') => {
    const sizes = {
      sm: 'w-8 h-8',
      md: 'w-10 h-10', 
      lg: 'w-16 h-16'
    };
    return `${sizes[size]} rounded-lg flex items-center justify-center ${RoleUtils.getRoleConfig(role).bgColor}`;
  }
};

// 알림 설정 체크박스 컴포넌트
const NotificationCheckbox = ({ 
  type, 
  accountId, 
  isChecked, 
  onChange, 
  icon: IconComponent, 
  label, 
  color 
}) => (
  <label className="flex items-center space-x-2 cursor-pointer">
    <input 
      type="checkbox" 
      checked={isChecked}
      onChange={onChange}
      className={`w-4 h-4 bg-slate-700 border-slate-600 rounded focus:ring-2 focus:ring-${color}-500`}
      style={{ accentColor: `var(--${color}-600)` }}
    />
    <div className="flex items-center space-x-1">
      <IconComponent className={`w-3 h-3 text-${color}-400`} />
      <span className={`text-xs text-${color}-300`}>{label}</span>
    </div>
  </label>
);

// 계정 카드 컴포넌트
const AccountCard = ({ 
  account, 
  onEdit, 
  onDelete, 
  notificationAssignments, 
  onNotificationChange,
  canManage = true 
}) => {
  const roleConfig = RoleUtils.getRoleConfig(account.role);

  return (
    <div className="bg-slate-700/30 rounded-xl p-4 border border-slate-600/30 hover:bg-slate-600/20 transition-colors">
      {/* 계정 기본 정보 */}
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center space-x-3">
          <div className={RoleUtils.getAvatarClass(account.role)}>
            <User className="w-5 h-5 text-white" />
          </div>
          <div>
            <div className="font-medium text-gray-100">{account.name}</div>
            <div className="text-sm text-gray-400 font-mono">{account.email}</div>
            <div className="flex items-center space-x-2 mt-1">
              <span className={RoleUtils.getRoleBadgeClass(account.role)}>
                {roleConfig.shortLabel}
              </span>
              <span className={`text-xs px-2 py-1 rounded font-medium border ${
                account.status === 'active' 
                  ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' 
                  : 'bg-gray-500/20 text-gray-300 border-gray-500/30'
              }`}>
                {account.status === 'active' ? '활성' : '비활성'}
              </span>
              <span className="text-xs text-gray-500">{account.createdAt}</span>
            </div>
          </div>
        </div>
        
        {/* 계정 관리 버튼 */}
        <div className="flex items-center space-x-2">
          {account.role === 'super_admin' ? (
            <span className="text-xs text-purple-400 font-medium">시스템 최고 관리자</span>
          ) : canManage ? (
            <>
              <Button
                onClick={() => onEdit(account)}
                variant="secondary"
                size="sm"
              >
                수정
              </Button>
              <Button
                onClick={() => onDelete(account)}
                variant="outline"
                size="sm"
                className="!text-red-300 !border-red-500/30 hover:!bg-red-600/20"
              >
                삭제
              </Button>
            </>
          ) : null}
        </div>
      </div>
      
      {/* 알림 설정 - 컴팩트 버전 */}
      <div className="border-t border-slate-600/30 pt-4">
        <div className="flex items-center justify-between mb-2">
          <div className="text-sm font-medium text-gray-300">알림 설정</div>
          <div className="flex items-center space-x-4">
            <NotificationCheckbox
              type="tax_alerts"
              accountId={account.id}
              isChecked={notificationAssignments.tax_alerts.includes(account.id)}
              onChange={(e) => onNotificationChange('tax_alerts', account.id, e.target.checked)}
              icon={AlertCircle}
              label="세금"
              color="orange"
            />
            <NotificationCheckbox
              type="station_alerts"
              accountId={account.id}
              isChecked={notificationAssignments.station_alerts.includes(account.id)}
              onChange={(e) => onNotificationChange('station_alerts', account.id, e.target.checked)}
              icon={Zap}
              label="충전소"
              color="blue"
            />
          </div>
        </div>
      </div>
    </div>
  );
};

// 계정 목록 페이지네이션 컴포넌트
const AccountsPagination = ({ 
  currentPage,
  totalPages,
  totalAccounts,
  activeAccounts,
  itemsPerPage,
  onPageChange
}) => {
  if (totalPages <= 1) return null;

  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalAccounts);

  return (
    <div className="flex items-center justify-center space-x-2 mb-4">
      <button
        onClick={() => onPageChange(1)}
        disabled={currentPage === 1}
        className="px-3 py-1 text-sm bg-slate-600/50 text-gray-300 rounded-lg hover:bg-slate-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        처음
      </button>
      <button
        onClick={() => onPageChange(prev => Math.max(prev - 1, 1))}
        disabled={currentPage === 1}
        className="px-3 py-1 text-sm bg-slate-600/50 text-gray-300 rounded-lg hover:bg-slate-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        이전
      </button>
      
      <div className="flex items-center space-x-1">
        {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
          let pageNum;
          if (totalPages <= 5) {
            pageNum = i + 1;
          } else if (currentPage <= 3) {
            pageNum = i + 1;
          } else if (currentPage >= totalPages - 2) {
            pageNum = totalPages - 4 + i;
          } else {
            pageNum = currentPage - 2 + i;
          }
          
          return (
            <button
              key={pageNum}
              onClick={() => onPageChange(pageNum)}
              className={`w-8 h-8 text-sm rounded-lg transition-colors ${
                currentPage === pageNum
                  ? 'bg-blue-600 text-white'
                  : 'bg-slate-600/50 text-gray-300 hover:bg-slate-500/50'
              }`}
            >
              {pageNum}
            </button>
          );
        })}
      </div>
      
      <button
        onClick={() => onPageChange(prev => Math.min(prev + 1, totalPages))}
        disabled={currentPage === totalPages}
        className="px-3 py-1 text-sm bg-slate-600/50 text-gray-300 rounded-lg hover:bg-slate-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        다음
      </button>
      <button
        onClick={() => onPageChange(totalPages)}
        disabled={currentPage === totalPages}
        className="px-3 py-1 text-sm bg-slate-600/50 text-gray-300 rounded-lg hover:bg-slate-500/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      >
        마지막
      </button>
    </div>
  );
};

// 계정 목록 통계 컴포넌트
const AccountsStats = ({ 
  currentPage,
  totalPages, 
  totalAccounts,
  activeAccounts,
  itemsPerPage,
  taxAlertsCount,
  stationAlertsCount
}) => {
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, totalAccounts);

  return (
    <div className="flex items-center justify-between">
      <div className="text-sm text-gray-400">
        {startIndex + 1}-{endIndex} / {totalAccounts}개 계정
        {totalPages > 1 && ` (${currentPage}/${totalPages} 페이지)`}
        {' • 활성 '}{activeAccounts}개
      </div>
      <div className="flex items-center space-x-6">
        <div className="text-sm text-gray-400">
          <span className="text-orange-300 font-medium">{taxAlertsCount}</span> 세금 알림
        </div>
        <div className="text-sm text-gray-400">
          <span className="text-blue-300 font-medium">{stationAlertsCount}</span> 충전소 알림
        </div>
      </div>
    </div>
  );
};

// 계정 목록 메인 컴포넌트
const AccountsList = ({
  accounts,
  notificationAssignments,
  accountsPage,
  accountsPerPage,
  canManageAccounts,
  onPageChange,
  onNotificationChange,
  onEditAccount,
  onDeleteAccount,
  onCreateAccount
}) => {
  // 페이지네이션 계산
  const startIndex = (accountsPage - 1) * accountsPerPage;
  const endIndex = startIndex + accountsPerPage;
  const paginatedAccounts = accounts.slice(startIndex, endIndex);
  const totalPages = Math.ceil(accounts.length / accountsPerPage);
  const activeAccounts = accounts.filter(a => a.status === 'active').length;

  return (
    <div className={CARD_STYLES + " overflow-hidden mb-6"}>
      {/* 헤더 */}
      <div className="p-6 border-b border-slate-600/30">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-semibold text-gray-100">사용자 계정 및 알림 설정</h3>
          {canManageAccounts && (
            <button 
              onClick={onCreateAccount}
              className="inline-flex items-center px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-lg hover:from-blue-500 hover:to-blue-400 transition-all duration-200 font-medium shadow-lg"
            >
              <Plus className="w-4 h-4 mr-2" />
              계정 생성
            </button>
          )}
        </div>
        {!canManageAccounts && (
          <p className="text-xs text-gray-500 mt-2">계정 관리 권한이 없습니다</p>
        )}
      </div>
      
      {/* 계정 카드 목록 */}
      <div className="p-6">
        <div className="space-y-4 mb-6">
          {paginatedAccounts.map((account) => (
            <AccountCard
              key={account.id}
              account={account}
              onEdit={onEditAccount}
              onDelete={onDeleteAccount}
              notificationAssignments={notificationAssignments}
              onNotificationChange={onNotificationChange}
              canManage={canManageAccounts}
            />
          ))}
        </div>
        
        {/* 페이지네이션 */}
        <AccountsPagination
          currentPage={accountsPage}
          totalPages={totalPages}
          totalAccounts={accounts.length}
          activeAccounts={activeAccounts}
          itemsPerPage={accountsPerPage}
          onPageChange={onPageChange}
        />
      </div>
      
      {/* 하단 통계 */}
      <div className="px-6 py-4 bg-slate-700/30 border-t border-slate-600/50">
        <AccountsStats
          currentPage={accountsPage}
          totalPages={totalPages}
          totalAccounts={accounts.length}
          activeAccounts={activeAccounts}
          itemsPerPage={accountsPerPage}
          taxAlertsCount={notificationAssignments.tax_alerts.length}
          stationAlertsCount={notificationAssignments.station_alerts.length}
        />
      </div>
    </div>
  );
};

// 프로필 관련 컴포넌트들 (기존 UserRoleBadge를 RoleUtils 사용하도록 수정)
const UserRoleBadge = (role) => {
  const config = RoleUtils.getRoleConfig(role);
  
  return {
    avatarClass: RoleUtils.getAvatarClass(role, 'lg'),
    textClass: `text-xs mt-1 font-medium ${config.textColor}`,
    label: config.label
  };
};

const PasswordChangeForm = ({ 
  profilePasswordForm, 
  setProfilePasswordForm, 
  onPasswordChange 
}) => {
  const isFormValid = () => {
    return profilePasswordForm.currentPassword &&
           profilePasswordForm.newPassword &&
           profilePasswordForm.confirmPassword &&
           profilePasswordForm.newPassword.length >= 6 &&
           profilePasswordForm.newPassword === profilePasswordForm.confirmPassword;
  };

  // 안전한 input 핸들러 - 포커스 손실 방지
  const handleInputChange = (field) => (e) => {
    e.preventDefault();
    e.stopPropagation();
    const value = e.target.value;
    
    setProfilePasswordForm(prev => ({
      ...prev,
      [field]: value
    }));
  };

  return (
    <div className={CARD_STYLES + " p-4"}>
      <h3 className="text-lg font-semibold text-gray-100 mb-4">패스워드 변경</h3>
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-2">현재 패스워드</label>
          <input 
            type="password" 
            value={profilePasswordForm.currentPassword || ''}
            onChange={handleInputChange('currentPassword')}
            autoComplete="current-password"
            className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
            placeholder="현재 패스워드를 입력하세요"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-2">새 패스워드</label>
          <input 
            type="password" 
            value={profilePasswordForm.newPassword || ''}
            onChange={handleInputChange('newPassword')}
            autoComplete="new-password"
            className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
            placeholder="새 패스워드를 입력하세요"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-2">새 패스워드 확인</label>
          <input 
            type="password" 
            value={profilePasswordForm.confirmPassword || ''}
            onChange={handleInputChange('confirmPassword')}
            autoComplete="new-password"
            className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
            placeholder="새 패스워드를 다시 입력하세요"
          />
        </div>
      </div>
      
      <div className="mt-6">
        <button 
          onClick={onPasswordChange}
          disabled={!isFormValid()}
          className={`w-full px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
            !isFormValid()
              ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
              : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
          }`}
        >
          패스워드 변경
        </button>
      </div>
    </div>
  );
};

const ProfileModal = ({ 
  isOpen, 
  onClose, 
  currentUser, 
  profilePasswordForm, 
  setProfilePasswordForm,
  onLogout,
  onPasswordChange 
}) => {
  const roleInfo = UserRoleBadge(currentUser?.role);

  return (
    <Modal 
      isOpen={isOpen} 
      onClose={onClose} 
      title="내 정보" 
      size="md" 
      heightMode="fixed"
    >
      <div className="space-y-6">
        {/* 프로필 정보 */}
        <div className="flex items-center justify-between p-4 bg-gradient-to-r from-blue-900/20 to-blue-800/10 rounded-xl border border-blue-500/20">
          <div className="flex items-center space-x-4">
            <div className={roleInfo.avatarClass}>
              <User className="w-8 h-8 text-white" />
            </div>
            <div>
              <div className="text-lg font-semibold text-gray-100">
                {currentUser?.name || '사용자'}
              </div>
              <div className="text-sm text-gray-400 font-mono">
                {currentUser?.email || 'unknown@email.com'}
              </div>
              <div className={roleInfo.textClass}>
                {roleInfo.label}
              </div>
            </div>
          </div>
          <button 
            onClick={onLogout}
            className="px-4 py-2 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-lg hover:from-red-500 hover:to-red-400 transition-all duration-200 font-medium text-sm shadow-lg"
          >
            로그아웃
          </button>
        </div>

        {/* 패스워드 변경 */}
        <PasswordChangeForm
          profilePasswordForm={profilePasswordForm}
          setProfilePasswordForm={setProfilePasswordForm}
          onPasswordChange={onPasswordChange}
        />
      </div>
    </Modal>
  );
};

const MenuItems = ({ currentUser, canManageAccounts }) => [
  { id: 'kanban', label: '세금 현황', icon: CheckCircle },
  { id: 'calendar', label: '캘린더', icon: Calendar },
  { id: 'stations', label: '충전소 관리', icon: Zap },
  ...(canManageAccounts ? [{ id: 'accounts', label: '계정 관리', icon: Lock }] : []),
  ...(currentUser?.role === 'super_admin' ? [{ id: 'api-settings', label: 'API 설정', icon: ApiSettingsIcon }] : [])
];

const ActionMenuItems = ({ 
  isViewerOnly, 
  unreadNotificationCount,
  onReminderClick,
  onTrashClick,
  trash,
  isMobile = false
}) => {
  if (isViewerOnly) return null;
  
  const items = [
    {
      id: 'reminder',
      icon: Bell,
      label: '리마인더',
      onClick: onReminderClick,
      badge: unreadNotificationCount > 0 ? unreadNotificationCount : null
    },
    {
      id: 'trash',
      icon: Trash2,
      label: '휴지통',
      onClick: onTrashClick,
      badge: trash.length > 0 ? trash.length : null,
      iconColor: trash.length > 0 ? 'text-red-400' : 'text-gray-400'
    }
  ];

  return (
    <div className="space-y-3">
      {items.map(item => {
        const IconComponent = item.icon;
        
        if (item.isFileUpload) {
          return (
            <label key={item.id} className="w-full flex items-center px-4 py-3 text-gray-300 hover:text-white hover:bg-slate-700/50 rounded-xl transition-all duration-200 cursor-pointer">
              <IconComponent className="w-4 h-4 mr-3" />
              <span className="text-sm">{item.label}</span>
              <input 
                type="file" 
                accept=".pdf,.jpg,.jpeg,.png,.webp" 
                onChange={(e) => item.onFileChange(e.target.files)} 
                className="hidden" 
              />
            </label>
          );
        }

        return (
          <button 
            key={item.id}
            onClick={item.onClick}
            className="w-full flex items-center px-4 py-3 text-gray-300 hover:text-white hover:bg-slate-700/50 rounded-xl transition-all duration-200 relative"
          >
            <IconComponent className={`w-4 h-4 mr-3 ${item.iconColor || ''}`} />
            <span className="text-sm">{item.label}</span>
            {item.badge && (
              <span className="ml-auto bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-medium">
                {item.badge}
              </span>
            )}
          </button>
        );
      })}
    </div>
  );
};

const CollapsedActionItems = ({ 
  isViewerOnly, 
  unreadNotificationCount,
  onReminderClick,
  onTrashClick,
  trash
}) => {
  if (isViewerOnly) return null;

  const items = [
    {
      id: 'reminder',
      icon: Bell,
      title: '리마인더',
      onClick: onReminderClick,
      hasBadge: unreadNotificationCount > 0
    },
    {
      id: 'trash',
      icon: Trash2,
      title: '휴지통',
      onClick: onTrashClick,
      hasBadge: trash.length > 0,
      iconColor: trash.length > 0 ? 'text-red-400' : 'text-gray-400'
    }
  ];

  return (
    <>
      {items.map(item => {
        const IconComponent = item.icon;
        
        if (item.isFileUpload) {
          return (
            <label
              key={item.id}
              className="w-12 h-12 flex items-center justify-center text-gray-300 hover:text-white hover:bg-slate-700/50 rounded-xl transition-all duration-200 cursor-pointer"
              title={item.title}
            >
              <IconComponent className="w-5 h-5" />
              <input type="file" accept=".pdf,.jpg,.jpeg,.png" onChange={(e) => item.onFileChange(e.target.files)} className="hidden" />
            </label>
          );
        }

        return (
          <button 
            key={item.id}
            onClick={item.onClick}
            className="w-12 h-12 flex items-center justify-center text-gray-300 hover:text-white hover:bg-slate-700/50 rounded-xl transition-all duration-200 relative"
            title={item.title}
          >
            <IconComponent className={`w-5 h-5 ${item.iconColor || ''}`} />
            {item.hasBadge && (
              <div className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
            )}
          </button>
        );
      })}
    </>
  );
};

const SidebarContent = ({ 
  isCollapsed, 
  currentView, 
  setCurrentView, 
  currentUser, 
  canManageAccounts, 
  isViewerOnly,
  unreadNotificationCount,
  trash,
  onProfileClick,
  onReminderClick,
  onAddBillClick,
  onAddStationClick,
  onFileUpload,
  onTrashClick
}) => {
  const menuItems = MenuItems({ currentUser, canManageAccounts });

  if (isCollapsed) {
    return (
      <div className="flex flex-col items-center space-y-2">
        {menuItems.map(item => {
          const IconComponent = item.icon;
          return (
            <button 
              key={item.id}
              onClick={() => setCurrentView(item.id)} 
              className={`w-12 h-12 flex items-center justify-center rounded-xl transition-all duration-200 ${
                currentView === item.id ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-300 hover:text-white hover:bg-slate-700/50'
              }`}
              title={item.label}
            >
              <IconComponent className="w-5 h-5" />
            </button>
          );
        })}
        
        <div className="w-8 my-4 border-t border-slate-600/30"></div>
        
        <CollapsedActionItems
          isViewerOnly={isViewerOnly}
          unreadNotificationCount={unreadNotificationCount}
          onReminderClick={onReminderClick}
          onTrashClick={onTrashClick}
          trash={trash}
        />
        
        <button 
          onClick={onProfileClick} 
          className="w-12 h-12 flex items-center justify-center text-gray-200 hover:text-white hover:bg-slate-600/50 rounded-xl transition-all duration-200 mt-4"
          title="내 정보"
        >
          <User className="w-5 h-5" />
        </button>
      </div>
    );
  }

  return (
    <>
      <nav className="space-y-2">
        {menuItems.map(item => {
          const IconComponent = item.icon;
          return (
            <button 
              key={item.id} 
              onClick={() => setCurrentView(item.id)} 
              className={`w-full flex items-center px-4 py-3 rounded-xl text-left transition-all duration-200 ${
                currentView === item.id ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/25' : 'text-gray-200 hover:text-white hover:bg-slate-600/50'
              }`}
            >
              <IconComponent className="w-5 h-5 mr-3" />
              {item.label}
            </button>
          );
        })}
      </nav>

      {!isViewerOnly && <div className="my-6 border-t border-slate-600/30"></div>}

      <ActionMenuItems
        isViewerOnly={isViewerOnly}
        unreadNotificationCount={unreadNotificationCount}
        onReminderClick={onReminderClick}
        onAddBillClick={onAddBillClick}
        onAddStationClick={onAddStationClick}
        onFileUpload={onFileUpload}
        onTrashClick={onTrashClick}
        trash={trash}
      />

      <div className={isViewerOnly ? "mt-6 pt-6 border-t border-slate-600/30" : "mt-4 pt-4 border-t border-slate-600/30"}>
        <button 
          onClick={onProfileClick} 
          className="w-full flex items-center px-4 py-3 text-gray-200 hover:text-white hover:bg-slate-600/50 rounded-xl transition-all duration-200"
        >
          <User className="w-4 h-4 mr-3" />
          <span className="text-sm">내 정보</span>
        </button>
      </div>
    </>
  );
};

// 메인 렌더링
  return (
    <div className="h-screen bg-gradient-to-br from-slate-900 via-gray-900 to-slate-800 flex flex-col">
      {/* 커스텀 스크롤바 스타일 적용 */}
      <style>{scrollbarStyles}</style>
      
      {/* 모바일/태블릿 헤더 */}
      {isMobileOrTablet && (
        <div className="flex items-center justify-between p-4 bg-slate-800/50 border-b border-slate-700/50 lg:hidden">
          <button 
            onClick={() => setShowMobileSidebar(true)}
            className="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-gray-400 hover:text-gray-200"
          >
            <Menu className="w-6 h-6" />
          </button>
          <h1 
            className="text-xl font-semibold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent cursor-pointer hover:opacity-80 transition-opacity"
            onClick={() => setCurrentView('dashboard')}
            title="통계 화면으로 이동"
          >
            water tt
          </h1>
          <div className="w-10"></div> {/* 균형을 위한 빈 공간 */}
        </div>
      )}
      
      <div className="flex flex-1 overflow-hidden">
        {isDesktop && (
          <div className={`${sidebarCollapsed ? 'w-16' : 'w-64'} bg-gradient-to-b from-slate-700/80 to-slate-800/80 backdrop-blur-xl border-r border-slate-600/50 transition-all duration-300 flex flex-col flex-shrink-0 shadow-xl`}>
            <div className="flex items-center px-4 py-3 border-b border-slate-600/50 bg-slate-600/20">
              <button 
                onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                onMouseEnter={() => setIsToggleHovered(true)}
                onMouseLeave={() => setIsToggleHovered(false)}
                className="p-1.5 hover:bg-slate-600/50 rounded-md transition-colors text-gray-300 hover:text-gray-100 flex-shrink-0"
                title={sidebarCollapsed ? "사이드바 확대" : "사이드바 축소"}
              >
                {isToggleHovered ? (
                  sidebarCollapsed ? <ChevronRight className="w-4 h-4" /> : <ChevronLeft className="w-4 h-4" />
                ) : (
                  <PanelLeft className="w-4 h-4" />
                )}
              </button>
              {!sidebarCollapsed && (
                <h1 
                  className="text-2xl font-semibold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent ml-3 cursor-pointer hover:opacity-80 transition-opacity"
                  onClick={() => setCurrentView('dashboard')}
                  title="통계 화면으로 이동"
                >
                  water tt
                </h1>
              )}
            </div>
            
            <div className="flex-1 p-4">
              <SidebarContent
                isCollapsed={sidebarCollapsed}
                currentView={currentView}
                setCurrentView={setCurrentView}
                currentUser={currentUser}
                canManageAccounts={canManageAccounts}
                isViewerOnly={isViewerOnly}
                unreadNotificationCount={unreadNotificationCount}
                trash={trash}
                onProfileClick={() => setShowProfileModal(true)}
                onReminderClick={() => setShowReminderPanel(true)}
                onTrashClick={() => setShowTrashModal(true)}
              />
            </div>
          </div>
        )}

        {showMobileSidebar && (
          <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 lg:hidden">
            <div 
              className="absolute inset-0" 
              onClick={() => setShowMobileSidebar(false)}
            ></div>
            
            <div className="absolute left-0 top-0 h-full w-80 bg-gradient-to-b from-slate-800 to-slate-900 shadow-2xl border-r border-slate-700/50 flex flex-col animate-slide-in-left">
              <div className="flex items-center justify-between p-4 border-b border-slate-600/50 bg-slate-600/20">
                <h1 className="text-xl font-semibold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                  water tt
                </h1>
                <button 
                  onClick={() => setShowMobileSidebar(false)}
                  className="p-2 hover:bg-slate-600/50 rounded-lg transition-colors text-gray-300 hover:text-gray-100"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <div className="flex-1 p-4">
                <nav className="space-y-2">
                  {MenuItems({ currentUser, canManageAccounts }).map(item => {
                    const IconComponent = item.icon;
                    return (
                      <button 
                        key={item.id} 
                        onClick={() => { setCurrentView(item.id); setShowMobileSidebar(false); }} 
                        className={`w-full flex items-center px-4 py-3 rounded-xl text-left transition-all duration-200 ${
                          currentView === item.id ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/25' : 'text-gray-200 hover:text-white hover:bg-slate-600/50'
                        }`}
                      >
                        <IconComponent className="w-5 h-5 mr-3" />
                        {item.label}
                      </button>
                    );
                  })}
                </nav>

                {!isViewerOnly && <div className="my-6 border-t border-slate-600/30"></div>}

                <ActionMenuItems
                  isViewerOnly={isViewerOnly}
                  unreadNotificationCount={unreadNotificationCount}
                  onReminderClick={() => { setShowReminderPanel(true); setShowMobileSidebar(false); }}
                  onTrashClick={() => { setShowTrashModal(true); setShowMobileSidebar(false); }}
                  trash={trash}
                  isMobile={true}
                />

                <div className={isViewerOnly ? "mt-6 pt-6 border-t border-slate-600/30" : "mt-4 pt-4 border-t border-slate-600/30"}>
                  <button 
                    onClick={() => { setShowProfileModal(true); setShowMobileSidebar(false); }} 
                    className="w-full flex items-center px-4 py-3 text-gray-300 hover:text-white hover:bg-slate-700/50 rounded-xl transition-all duration-200"
                  >
                    <User className="w-4 h-4 mr-3" />
                    <span className="text-sm">내 정보</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* 메인 컨텐츠 */}
        <div className="flex-1 overflow-auto">
          {currentView === 'dashboard' && renderDashboardView()}
          {currentView === 'kanban' && (
            <div className="w-full px-6 py-8">
              <div className="mb-8">
                <h2 className="text-2xl font-bold text-gray-100 mb-2">세금 현황</h2>
              </div>

              <TaxFiltersPanel 
                globalFilters={globalFilters}
                setGlobalFilters={setGlobalFilters}
                resetFilters={resetFilters}
                setVisibleCounts={setVisibleCounts}
                isMobile={isMobile}
                showMobileFilters={showMobileFilters}
                setShowMobileFilters={setShowMobileFilters}
              />
              
              <KanbanBoard 
                getBillsByStatus={getBillsByStatus}
                updateBillStatus={updateBillStatus}
                handleBillClick={handleBillClick}
                isViewerOnly={isViewerOnly}
                kanbanPages={kanbanPages}
                setKanbanPages={setKanbanPages}
              />

              {/* 세금 분류별 간단 요약 */}
              <div className={CARD_STYLES + " p-4 mb-6"}>
                {(() => {
                  const allFilteredBills = ['accounting_review', 'pending', 'completed']
                    .flatMap(status => getBillsByStatus(status));
                  
                  const 취득세Amount = allFilteredBills
                    .filter(bill => bill.category === '취득세')
                    .reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
                  
                  const 재산세Amount = allFilteredBills
                    .filter(bill => bill.category === '재산세')
                    .reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
                  
                  const 기타세Amount = allFilteredBills
                    .filter(bill => bill.category === '기타세')
                    .reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
                  
                  const totalAmount = 취득세Amount + 재산세Amount + 기타세Amount;
                  
                  return (
                    <div className="space-y-2">
                      <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center space-x-2">
                          <div className="w-3 h-3 bg-slate-500 rounded-full"></div>
                          <span className="text-slate-300 font-medium">취득세</span>
                          <span className="text-gray-400">({allFilteredBills.filter(bill => bill.category === '취득세').length}건)</span>
                        </div>
                        <span className="text-gray-200 font-mono">₩{utils.formatKoreanCurrency(취득세Amount)}</span>
                      </div>
                      
                      <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center space-x-2">
                          <div className="w-3 h-3 bg-slate-600 rounded-full"></div>
                          <span className="text-slate-300 font-medium">재산세</span>
                          <span className="text-gray-400">({allFilteredBills.filter(bill => bill.category === '재산세').length}건)</span>
                        </div>
                        <span className="text-gray-200 font-mono">₩{utils.formatKoreanCurrency(재산세Amount)}</span>
                      </div>
                      
                      <div className="flex items-center justify-between text-sm">
                        <div className="flex items-center space-x-2">
                          <div className="w-3 h-3 bg-slate-400 rounded-full"></div>
                          <span className="text-slate-300 font-medium">기타세</span>
                          <span className="text-gray-400">({allFilteredBills.filter(bill => bill.category === '기타세').length}건)</span>
                        </div>
                        <span className="text-gray-200 font-mono">₩{utils.formatKoreanCurrency(기타세Amount)}</span>
                      </div>
                      
                      <div className="border-t border-slate-600/30 pt-2 mt-3">
                        <div className="flex items-center justify-between text-sm">
                          <span className="text-gray-200 font-semibold">전체 합계</span>
                          <span className="text-slate-200 font-bold font-mono">₩{utils.formatKoreanCurrency(totalAmount)}</span>
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
              
              {/* 액션 버튼들 - 통일된 스타일 */}
              <div className="flex justify-end items-center space-x-3">
                <Button
                  onClick={() => {
                    try {
                      const allBills = ['accounting_review', 'pending', 'completed']
                        .flatMap(status => getBillsByStatus(status));
                      
                      if (allBills.length === 0) {
                        showError('다운로드할 데이터가 없습니다.');
                        return;
                      }
                      
                      const csvData = ExcelExportUtils.formatBillsForExcel(allBills, enhancedStations);
                      const today = koreaTimeUtils.getKoreaToday().replace(/-/g, '');
                      const filename = `세금현황_${today}.csv`;
                      
                      ExcelExportUtils.downloadCSVInstant(csvData, filename);
                      showSuccess('CSV 파일 다운로드가 시작되었습니다.');
                    } catch (error) {
                      showError(error.message || 'CSV 다운로드에 실패했습니다.');
                    }
                  }}
                  variant="secondary"
                  size="sm"
                  icon={(props) => (
                    <svg {...props} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  )}
                >
                  CSV 다운로드
                </Button>

                {!isViewerOnly && (
                  <>
                    <Button
                      onClick={() => document.getElementById('tax-csv-upload').click()}
                      variant="secondary"
                      size="sm"
                      icon={Upload}
                    >
                      CSV 일괄등록
                      <input 
                        id="tax-csv-upload"
                        type="file" 
                        accept=".csv" 
                        onChange={(e) => handleTaxCSVUpload(e.target.files)} 
                        className="hidden" 
                      />
                    </Button>
                    
                    <Button
                      onClick={() => document.getElementById('tax-file-upload').click()}
                      variant="accent"
                      size="sm"
                      icon={Upload}
                    >
                      고지서 업로드
                      <input 
                        id="tax-file-upload"
                        type="file" 
                        accept=".pdf,.jpg,.jpeg,.png,.webp" 
                        onChange={(e) => handleFileUpload(e.target.files)} 
                        className="hidden" 
                      />
                    </Button>
                    
                    <Button 
                      onClick={() => { 
                        setShowAddForm(true); 
                        setEditingBill(null); 
                        setNewBill({ name: '', amount: '', dueDate: '', category: '', stationName: '', address: '', isRecurring: false }); 
                        setStationSearchQuery(''); 
                        setShowStationDropdown(false); 
                      }} 
                      variant="primary"
                      size="sm"
                      icon={Plus}
                    >
                      세금 추가
                    </Button>
                  </>
                )}
              </div>
            </div>
          )}
          {currentView === 'calendar' && (
            <CalendarView 
              currentDate={currentDate}
              setCurrentDate={setCurrentDate}
              bills={bills}
              enhancedStations={enhancedStations}
              koreaTimeUtils={koreaTimeUtils}
              utils={utils}
              getBillsForDate={getBillsForDate}
              getStationEventsForDate={getStationEventsForDate}
              getCompletedBillsForDate={getCompletedBillsForDate}
              handleDateClick={handleDateClick}
            />
          )}
          {currentView === 'stations' && !showStationDetailPage && renderStationsView()}
          {currentView === 'stations' && showStationDetailPage && (
            <div className="w-full px-6 py-8">
              <div className="mb-8">
                <h2 className="text-2xl font-bold text-gray-100">충전소 상세 정보</h2>
              </div>
              
              <div className="space-y-8">
                {/* 기본 정보 & 수정 섹션 */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  {/* 기본 정보 */}
                  <div className={`${CARD_STYLES} p-6`}>
                    <h3 className="text-lg font-semibold text-gray-100 flex items-center mb-6">
                      <MapPin className="w-5 h-5 mr-3 text-blue-400" />
                      기본 정보
                    </h3>
                    
                    <div className="space-y-5">
                      {/* 충전소명 */}
                      <div>
                        <label className="text-sm font-medium text-gray-400 block mb-2">충전소명</label>
                        {!isViewerOnly ? (
                          <input 
                            type="text" 
                            value={editStationData.name || selectedStationForDetail?.name || ''}
                            onChange={(e) => setEditStationData({...editStationData, name: e.target.value})}
                            className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                          />
                        ) : (
                          <div className="text-gray-100 font-medium">{selectedStationForDetail?.name}</div>
                        )}
                      </div>
                      
                      {/* 주소 */}
                      <div>
                        <label className="text-sm font-medium text-gray-400 block mb-2">주소</label>
                        {!isViewerOnly ? (
                          <input 
                            type="text" 
                            value={editStationData.address || selectedStationForDetail?.address || ''}
                            onChange={(e) => setEditStationData({...editStationData, address: e.target.value})}
                            className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                          />
                        ) : (
                          <div className="text-gray-100 leading-relaxed">{selectedStationForDetail?.address}</div>
                        )}
                      </div>
                      
                      {/* 운영 상태 */}
                      <div>
                        <label className="text-sm font-medium text-gray-400 block mb-2">운영 상태</label>
                        {!isViewerOnly ? (
                          <select 
                            value={editStationData.status || selectedStationForDetail?.status || 'operating'}
                            onChange={(e) => setEditStationData({...editStationData, status: e.target.value})}
                            className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                          >
                            <option value="preparing">오픈 예정</option>
                            <option value="operating">운영 중</option>
                            <option value="closed">운영 종료</option>
                          </select>
                        ) : (
                          <span className={`inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium border ${
                            selectedStationForDetail?.status === 'operating' 
                              ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' 
                              : selectedStationForDetail?.status === 'preparing' 
                              ? 'bg-amber-500/20 text-amber-300 border-amber-500/30' 
                              : 'bg-gray-500/20 text-gray-300 border-gray-500/30'
                          }`}>
                            <div className={`w-2 h-2 rounded-full mr-2 ${
                              selectedStationForDetail?.status === 'operating' 
                                ? 'bg-emerald-500 animate-pulse' 
                                : selectedStationForDetail?.status === 'preparing' 
                                ? 'bg-amber-500' 
                                : 'bg-gray-500'
                            }`}></div>
                            {selectedStationForDetail?.status === 'operating' ? '운영 중' : 
                             selectedStationForDetail?.status === 'preparing' ? '오픈 예정' : '운영 종료'}
                          </span>
                        )}
                      </div>
                      
                                              
                        {/* 승인일, 점검일 */}
                      <div className="space-y-5">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-5">
                          <div>
                            <label className="text-sm font-medium text-gray-400 block mb-2">사용 승인일</label>
                            {!isViewerOnly ? (
                              <input 
                                type="date" 
                                value={editStationData.approvalDate || selectedStationForDetail?.approvalDate || ''}
                                onChange={(e) => setEditStationData({...editStationData, approvalDate: e.target.value})}
                                className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                              />
                            ) : (
                              <div className={`${selectedStationForDetail?.approvalDate ? 'text-blue-300 font-mono' : 'text-gray-500'}`}>
                                {selectedStationForDetail?.approvalDate || '미입력'}
                              </div>
                            )}
                            
                            {/* 건축물 사용 승인 알림 체크박스 */}
                            {!isViewerOnly && (
                              <div className="mt-3 bg-slate-800/30 rounded-lg p-3 border border-slate-600/30">
                                <div className="flex items-center space-x-3">
                                  <input 
                                    type="checkbox" 
                                    id="needs-approval-detail" 
                                    checked={editStationData.needsApproval !== undefined ? editStationData.needsApproval : selectedStationForDetail?.needsApproval || false}
                                    onChange={(e) => setEditStationData({...editStationData, needsApproval: e.target.checked})}
                                    className="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2"
                                  />
                                  <label htmlFor="needs-approval-detail" className="text-sm font-medium text-gray-300">
                                    건축물 사용 승인 알림
                                  </label>
                                </div>
                                <p className="text-xs text-gray-400 ml-7 mt-1">
                                  체크 시 승인일 미입력 알림을 받습니다
                                </p>
                              </div>
                            )}
                            
                            {/* 뷰어용 표시 */}
                            {isViewerOnly && (selectedStationForDetail?.needsApproval || editStationData.needsApproval) && (
                              <div className="mt-3 bg-slate-800/30 rounded-lg p-3 border border-slate-600/30">
                                <div className="flex items-center space-x-2">
                                  <CheckCircle className="w-4 h-4 text-blue-400" />
                                  <span className="text-sm text-gray-300">건축물 사용 승인 알림 활성화</span>
                                </div>
                              </div>
                            )}
                          </div>
                          
                          <div>
                            <label className="text-sm font-medium text-gray-400 block mb-2">전기 안전 점검일</label>
                            {!isViewerOnly ? (
                              <input 
                                type="date" 
                                value={editStationData.safetyCheckDate || selectedStationForDetail?.safetyCheckDate || ''}
                                onChange={(e) => setEditStationData({...editStationData, safetyCheckDate: e.target.value})}
                                className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                              />
                            ) : (
                              <div className={`${selectedStationForDetail?.safetyCheckDate ? 'text-blue-300 font-mono' : 'text-gray-500'}`}>
                                {selectedStationForDetail?.safetyCheckDate || '미입력'}
                              </div>
                            )}
                          </div>
                        </div>

                      </div>
                    </div>
                  </div>
                  
                  {/* 세금 현황 */}
                  <div className={`${CARD_STYLES} p-6`}>
                    <div className="flex items-center justify-between mb-6">
                      <h3 className="text-lg font-semibold text-gray-100 flex items-center">
                        <DollarSign className="w-5 h-5 mr-3 text-emerald-400" />
                        세금 현황
                      </h3>
                      <button 
                        onClick={() => { 
                          setCurrentView('kanban'); 
                          setGlobalFilters(prev => ({...prev, stationSearch: selectedStationForDetail?.name})); 
                          setShowStationDetailPage(false);
                          setSelectedStationForDetail(null);
                        }} 
                        className="px-3 py-1.5 bg-emerald-600/20 text-emerald-300 rounded-lg hover:bg-emerald-600/30 transition-colors text-sm font-medium border border-emerald-500/30"
                      >
                        전체보기
                      </button>
                    </div>
                    
                    {(() => {
                      const stationBills = bills.filter(bill => bill.stationName === selectedStationForDetail?.name);
                      const pendingByCategory = {
                        '취득세': stationBills.filter(bill => bill.category === '취득세' && (bill.status === 'pending' || bill.status === 'accounting_review')),
                        '재산세': stationBills.filter(bill => bill.category === '재산세' && (bill.status === 'pending' || bill.status === 'accounting_review')),
                        '기타세': stationBills.filter(bill => bill.category === '기타세' && (bill.status === 'pending' || bill.status === 'accounting_review'))
                      };
                      const completedByCategory = {
                        '취득세': stationBills.filter(bill => bill.category === '취득세' && bill.status === 'completed'),
                        '재산세': stationBills.filter(bill => bill.category === '재산세' && bill.status === 'completed'),
                        '기타세': stationBills.filter(bill => bill.category === '기타세' && bill.status === 'completed')
                      };
                      const totalCompleted = stationBills.filter(bill => bill.status === 'completed').reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
                      const totalPending = stationBills.filter(bill => bill.status === 'pending' || bill.status === 'accounting_review').reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0);
                      
                      return (
                        <div className="space-y-6">
                          {/* 총계 */}
                          <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-600/20">
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <div className="text-sm text-gray-400 mb-1">납부 완료</div>
                                <div className="text-xl font-bold text-emerald-300 font-mono">₩{utils.formatKoreanCurrency(totalCompleted)}</div>
                              </div>
                              <div>
                                <div className="text-sm text-gray-400 mb-1">납부 예정</div>
                                <div className="text-xl font-bold text-amber-300 font-mono">₩{utils.formatKoreanCurrency(totalPending)}</div>
                              </div>
                            </div>
                          </div>
                          
                          {/* 분류별 현황 */}
                          <div className="space-y-3">
                            {[
                              { category: '취득세', color: 'orange', bgColor: 'bg-orange-500/10', borderColor: 'border-orange-500/20' },
                              { category: '재산세', color: 'blue', bgColor: 'bg-blue-500/10', borderColor: 'border-blue-500/20' },
                              { category: '기타세', color: 'gray', bgColor: 'bg-gray-500/10', borderColor: 'border-gray-500/20' }
                            ].map(({ category, color, bgColor, borderColor }) => (
                              <div key={category} className={`${bgColor} rounded-lg p-3 border ${borderColor}`}>
                                <div className="flex items-center justify-between mb-2">
                                  <CategoryBadge category={category} />
                                  <div className="text-xs text-gray-400">
                                    {pendingByCategory[category].length + completedByCategory[category].length}건
                                  </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                  <div className="flex justify-between">
                                    <span className="text-emerald-300">완료:</span>
                                    <span className="text-emerald-300 font-medium">{completedByCategory[category].length}</span>
                                  </div>
                                  <div className="flex justify-between">
                                    <span className="text-amber-300">예정:</span>
                                    <span className="text-amber-300 font-medium">{pendingByCategory[category].length}</span>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                </div>
                
                {/* 비고 섹션 */}
                <div className={`${CARD_STYLES} p-6`}>
                  <h3 className="text-lg font-semibold text-gray-100 mb-6 flex items-center">
                    <FileText className="w-5 h-5 mr-3 text-purple-400" />
                    비고
                  </h3>
                  
                  {!isViewerOnly ? (
                    <div className="space-y-4">
                      <textarea
                        value={editStationData.memo || selectedStationForDetail?.memo || ''}
                        onChange={(e) => setEditStationData({...editStationData, memo: e.target.value})}
                        placeholder="충전소에 대한 메모를 입력하세요..."
                        className="w-full h-32 px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500/50 resize-none custom-scrollbar"
                        maxLength={500}
                      />
                      <div className="text-xs text-gray-400 text-right">
                        {(editStationData.memo || selectedStationForDetail?.memo || '').length}/500자
                      </div>
                    </div>
                  ) : (
                    <div className="bg-slate-800/30 rounded-lg p-4 border border-slate-600/20 min-h-[8rem]">
                      {selectedStationForDetail?.memo ? (
                        <p className="text-gray-300 text-sm whitespace-pre-wrap leading-relaxed">
                          {selectedStationForDetail.memo}
                        </p>
                      ) : (
                        <p className="text-gray-500 text-sm italic">작성된 비고가 없습니다.</p>
                      )}
                    </div>
                  )}
                </div>
                
                {/* 하단 버튼들 (뷰어가 아닐 때만) */}
                {!isViewerOnly && (
                  <div className="flex justify-between pt-8 border-t border-slate-600/30">
                    <Button 
                      onClick={() => {
                        setShowStationDetailPage(false);
                        setSelectedStationForDetail(null);
                        setIsEditingStationDetail(false);
                        setEditStationData({});
                      }}
                      variant="secondary"
                      size="md"
                    >
                      목록
                    </Button>
                    
                    <div className="flex space-x-3">
                      {canDelete && (
                        <Button 
                          onClick={() => {
                            const hasRelatedBills = bills.some(bill => bill.stationName === selectedStationForDetail.name);
                            if (hasRelatedBills) {
                              showError('이 충전소에 연결된 세금이 있어 삭제할 수 없습니다.\n먼저 관련 세금을 삭제하거나 다른 충전소로 이전해주세요.');
                              return;
                            }
                            
                            // 확인 모달 표시
                            setStationToDelete(selectedStationForDetail);
                            setShowDeleteStationModal(true);
                          }}
                          disabled={bills.some(bill => bill.stationName === selectedStationForDetail?.name)}
                          variant="danger"
                          size="md"
                          title={bills.some(bill => bill.stationName === selectedStationForDetail?.name) ? '연결된 세금이 있어 삭제할 수 없습니다' : '충전소 삭제'}
                        >
                          삭제
                        </Button>
                      )}
                      
                      <Button 
                        onClick={async () => {
                          // 변경된 데이터가 있는지 확인
                          const hasChanges = Object.keys(editStationData).length > 0;
                          
                          if (hasChanges) {
                            // 변경사항 적용
                            const oldStation = selectedStationForDetail;
                            const updatedData = {
                              ...selectedStationForDetail,
                              ...editStationData
                            };
                            
                            updateStation(selectedStationForDetail.name, updatedData);
                            setSelectedStationForDetail(updatedData);
                            
                            // 세금 정보도 업데이트
                            setBills(prev => prev.map(bill => 
                              bill.stationName === selectedStationForDetail.name ? 
                              { ...bill, stationName: updatedData.name, address: updatedData.address } : bill
                            ));
                            
                            // 날짜에서 60일 더하는 함수 (로컬)
                            const calculateTaxDueDate = (originalDate) => {
                              const date = new Date(originalDate);
                              date.setDate(date.getDate() + 60); // 60일 후
                              return date.toISOString().split('T')[0];
                            };

                            // 중복 취득세 체크 함수 (로컬)
                            const checkDuplicateTax = (stationName, taxName, dueDate) => {
                              return bills.some(bill => 
                                bill.stationName === stationName && 
                                bill.name === taxName && 
                                bill.dueDate === dueDate &&
                                bill.category === '취득세'
                              );
                            };
                            
                            // 새로 추가된 날짜에 대한 취득세 자동 생성
                            const taxesToCreate = [];
                            
                            // 승인일이 새로 입력되거나 변경된 경우 - 캐노피 취득세
                            if (editStationData.approvalDate && editStationData.approvalDate.trim() !== '' && 
                                (!oldStation.approvalDate || oldStation.approvalDate.trim() === '' || oldStation.approvalDate !== editStationData.approvalDate) &&
                                (editStationData.needsApproval !== undefined ? editStationData.needsApproval : updatedData.needsApproval)) {
                              
                              const taxDueDate = calculateTaxDueDate(editStationData.approvalDate);
                              const taxName = "캐노피 취득세";
                              
                              const isDuplicate = checkDuplicateTax(updatedData.name, taxName, taxDueDate);
                              
                              if (!isDuplicate) {
                                const canopyTax = {
                                  name: taxName,
                                  amount: '미정',
                                  dueDate: taxDueDate,
                                  category: '취득세',
                                  stationName: updatedData.name,
                                  address: updatedData.address,
                                  status: 'accounting_review',
                                  isRecurring: false,
                                  uploadedAt: koreaTimeUtils.getKoreaToday(),
                                  completedDate: null,
                                  // 추가 메타데이터
                                  autoGenerated: true,
                                  sourceType: 'station_approval',
                                  sourceDate: editStationData.approvalDate
                                };
                                
                                taxesToCreate.push(canopyTax);
                                console.log('캐노피 취득세 생성 준비 (상세 페이지):', canopyTax);
                              }
                              
                              // 승인일 알림 생성
                              const canopyTax = taxesToCreate.find(tax => tax.name === "캐노피 취득세");
                              setNotifications(prev => [...prev, {
                                id: `approval-${Date.now()}-${Math.random()}`,
                                type: 'approval_added',
                                stationName: updatedData.name,
                                date: editStationData.approvalDate,
                                createdAt: koreaTimeUtils.getKoreaToday(),
                                message: canopyTax 
                                  ? `${updatedData.name} 사용 승인일이 추가되었습니다: ${editStationData.approvalDate}\n캐노피 취득세 자동 등록 완료 (납부 기한: ${canopyTax.dueDate})`
                                  : `${updatedData.name} 사용 승인일이 추가되었습니다: ${editStationData.approvalDate}`
                              }]);
                              console.log('상세 페이지에서 사용 승인일 알림 생성 (알림 체크됨):', updatedData.name, editStationData.approvalDate);
                            }
                            
                            // 점검일이 새로 입력되거나 변경된 경우 - 충전기 취득세
                            if (editStationData.safetyCheckDate && editStationData.safetyCheckDate.trim() !== '' && 
                                (!oldStation.safetyCheckDate || oldStation.safetyCheckDate.trim() === '' || oldStation.safetyCheckDate !== editStationData.safetyCheckDate)) {
                              
                              const taxDueDate = calculateTaxDueDate(editStationData.safetyCheckDate);
                              const taxName = "충전기 취득세";
                              
                              const isDuplicate = checkDuplicateTax(updatedData.name, taxName, taxDueDate);
                              
                              if (!isDuplicate) {
                                const chargerTax = {
                                  name: taxName,
                                  amount: '미정',
                                  dueDate: taxDueDate,
                                  category: '취득세',
                                  stationName: updatedData.name,
                                  address: updatedData.address,
                                  status: 'accounting_review',
                                  isRecurring: false,
                                  uploadedAt: koreaTimeUtils.getKoreaToday(),
                                  completedDate: null,
                                  // 추가 메타데이터
                                  autoGenerated: true,
                                  sourceType: 'station_safety',
                                  sourceDate: editStationData.safetyCheckDate
                                };
                                
                                taxesToCreate.push(chargerTax);
                                console.log('충전기 취득세 생성 준비 (상세 페이지):', chargerTax);
                              }
                              
                              // 점검일 알림 생성
                              const chargerTax = taxesToCreate.find(tax => tax.name === "충전기 취득세");
                              setNotifications(prev => [...prev, {
                                id: `safety-${Date.now()}-${Math.random()}`,
                                type: 'safety_added',
                                stationName: updatedData.name,
                                date: editStationData.safetyCheckDate,
                                createdAt: koreaTimeUtils.getKoreaToday(),
                                message: chargerTax 
                                  ? `${updatedData.name} 전기 안전 점검일이 추가되었습니다: ${editStationData.safetyCheckDate}\n충전기 취득세 자동 등록 완료 (납부 기한: ${chargerTax.dueDate})`
                                  : `${updatedData.name} 전기 안전 점검일이 추가되었습니다: ${editStationData.safetyCheckDate}`
                              }]);
                              console.log('상세 페이지에서 안전 점검일 알림 생성:', updatedData.name, editStationData.safetyCheckDate);
                            }
                            
                            // 취득세들을 순차적으로 생성
                            const createdTaxes = [];
                            for (const tax of taxesToCreate) {
                              try {
                                console.log(`${tax.name} addBill 실행 (상세 페이지)...`);
                                const result = await addBill(tax);
                                console.log(`${tax.name} addBill 성공 (상세 페이지):`, result);
                                createdTaxes.push(tax);
                              } catch (error) {
                                console.error(`${tax.name} addBill 실패 (상세 페이지):`, error);
                                showError(`${tax.name} 자동 등록에 실패했습니다: ${error.message}`);
                              }
                            }
                            
                            // 편집 데이터 초기화
                            setEditStationData({});
                            
                            // 성공 메시지 표시
                            if (createdTaxes.length > 0) {
                              const taxNames = createdTaxes.map(tax => tax.name).join(', ');
                              showSuccess(`충전소 정보가 저장되었습니다. ${taxNames}이(가) 자동 등록되었습니다.`);
                            } else {
                              showSuccess('충전소 정보가 저장되었습니다.');
                            }
                          }
                        }}
                        disabled={Object.keys(editStationData).length === 0}
                        variant="primary"
                        size="md"
                      >
                        저장
                      </Button>
                    </div>
                  </div>
                )}
                
                {/* 뷰어일 때는 목록 버튼만 */}
                {isViewerOnly && (
                  <div className="flex justify-start pt-8 border-t border-slate-600/30">
                    <Button 
                      onClick={() => {
                        setShowStationDetailPage(false);
                        setSelectedStationForDetail(null);
                        setIsEditingStationDetail(false);
                        setEditStationData({});
                      }}
                      variant="secondary"
                      size="md"
                    >
                      목록
                    </Button>
                  </div>
                )}
              </div>
            </div>
          )}
          {currentView === 'accounts' && !canManageAccounts && (
            <div className="w-full px-6 py-8">
              <div className="mb-8">
                <h2 className="text-2xl font-bold text-gray-100 mb-2">계정 관리</h2>
                <p className="text-gray-400 text-sm">계정 관리 권한이 필요합니다.</p>
              </div>
              
              <div className="text-center py-12">
                <Lock className="w-16 h-16 mx-auto mb-4 text-gray-400" />
                <p className="text-gray-300 text-lg mb-4">계정 관리 권한이 없습니다</p>
                <p className="text-gray-400 text-sm mb-6">이 기능은 관리자만 사용할 수 있습니다.</p>
                <button 
                  onClick={() => setCurrentView('dashboard')}
                  className="px-5 py-2 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl hover:from-blue-500 hover:to-blue-400 transition-all duration-200 font-medium shadow-lg text-xs"
                >
                  메인으로 돌아가기
                </button>
              </div>
            </div>
          )}
          {currentView === 'accounts' && canManageAccounts && (
            <div className="w-full px-6 py-8">
              <div className="mb-8">
                <h2 className="text-2xl font-bold text-gray-100 mb-2">계정 관리</h2>
              </div>

              {/* 탭 네비게이션 */}
              <div className="mb-8">
                <div className="border-b border-slate-600/30">
                  <div className="flex space-x-8">
                    <button
                      onClick={() => setActiveAccountTab('users')}
                      className={`py-3 px-1 border-b-2 font-medium text-sm transition-colors ${
                        activeAccountTab === 'users'
                          ? 'border-blue-500 text-blue-300'
                          : 'border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300'
                      }`}
                    >
                      사용자 계정
                    </button>
                    <button
                      onClick={() => setActiveAccountTab('notifications')}
                      className={`py-3 px-1 border-b-2 font-medium text-sm transition-colors ${
                        activeAccountTab === 'notifications'
                          ? 'border-blue-500 text-blue-300'
                          : 'border-transparent text-gray-400 hover:text-gray-300 hover:border-gray-300'
                      }`}
                    >
                      이메일 알림 설정
                    </button>
                  </div>
                </div>
              </div>

              {/* 탭 콘텐츠 */}
              {activeAccountTab === 'users' && (
                <AccountsList
                  accounts={accounts}
                  notificationAssignments={notificationAssignments}
                  accountsPage={accountsPage}
                  accountsPerPage={accountsPerPage}
                  canManageAccounts={canManageAccounts}
                  onPageChange={setAccountsPage}
                  onNotificationChange={(alertType, accountId, isChecked) => {
                    if (isChecked) {
                      setNotificationAssignments(prev => ({
                        ...prev,
                        [alertType]: [...prev[alertType], accountId]
                      }));
                    } else {
                      setNotificationAssignments(prev => ({
                        ...prev,
                        [alertType]: prev[alertType].filter(id => id !== accountId)
                      }));
                    }
                  }}
                  onEditAccount={(account) => {
                    setEditingAccount(account);
                    setEditAccountForm({
                      name: account.name,
                      role: account.role,
                      newPassword: '',
                      confirmPassword: ''
                    });
                    setShowEditAccountModal(true);
                  }}
                  onDeleteAccount={(account) => {
                    setAccountToDelete(account);
                    setShowDeleteAccountModal(true);
                  }}
                  onCreateAccount={() => {
                    setShowCreateAccountModal(true);
                    setNewAccount({ email: '', password: '', confirmPassword: '', name: '', role: 'viewer' });
                  }}
                />
              )}

              {activeAccountTab === 'notifications' && (
                <div className="space-y-8">
                  {/* 이메일 알림 설정 섹션 */}
                  <div className={`${CARD_STYLES} p-6`}>
                    <h3 className="text-lg font-semibold text-gray-100 mb-4 flex items-center">
                      <svg className="w-5 h-5 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      이메일 알림 설정
                    </h3>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                      {/* 전체 활성화/비활성화 */}
                      <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-600/30">
                        <div className="flex items-center justify-between mb-3">
                          <label className="text-sm font-medium text-gray-300">이메일 알림</label>
                          <input 
                            type="checkbox" 
                            checked={emailNotificationSettings.enabled}
                            onChange={(e) => setEmailNotificationSettings(prev => ({
                              ...prev, 
                              enabled: e.target.checked
                            }))}
                            className="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2"
                          />
                        </div>
                        <p className="text-xs text-gray-400">
                          핵심 알림만 이메일로 발송합니다 (MVP 모드)
                        </p>
                        {SendGridAPI.hasValidApiKey() ? (
                          <div className="mt-2 flex items-center text-xs text-emerald-300">
                            <CheckCircle className="w-3 h-3 mr-1" />
                            SendGrid 연결됨
                          </div>
                        ) : (
                          <div className="mt-2 flex items-center text-xs text-amber-300">
                            <AlertCircle className="w-3 h-3 mr-1" />
                            API 설정 필요
                          </div>
                        )}
                      </div>

                      {/* 세금 알림 설정 */}
                      <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-600/30">
                        <div className="flex items-center justify-between mb-3">
                          <label className="text-sm font-medium text-gray-300">🚨 긴급 세금 알림</label>
                          <input 
                            type="checkbox" 
                            checked={emailNotificationSettings.taxAlerts}
                            onChange={(e) => setEmailNotificationSettings(prev => ({
                              ...prev, 
                              taxAlerts: e.target.checked
                            }))}
                            disabled={!emailNotificationSettings.enabled}
                            className="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2 disabled:opacity-50"
                          />
                        </div>
                        <p className="text-xs text-gray-400">
                          납부 기한 3일 전 긴급 알림만 발송
                        </p>
                        <div className="mt-2 text-xs text-gray-500">
                          담당자: {notificationAssignments.tax_alerts.length}명
                        </div>
                      </div>

                      {/* 충전소 알림 설정 */}
                      <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-600/30">
                        <div className="flex items-center justify-between mb-3">
                          <label className="text-sm font-medium text-gray-300">🏢 충전소 정보 알림</label>
                          <input 
                            type="checkbox" 
                            checked={emailNotificationSettings.stationAlerts}
                            onChange={(e) => setEmailNotificationSettings(prev => ({
                              ...prev, 
                              stationAlerts: e.target.checked
                            }))}
                            disabled={!emailNotificationSettings.enabled}
                            className="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2 disabled:opacity-50"
                          />
                        </div>
                        <div className="text-xs text-gray-400 space-y-1">
                          <div>• 📅 승인일/점검일 최초 입력 완료 알림</div>
                          <div>• ⚠️ 승인일 미입력 알림 (30일 후)</div>
                          <div>• ⚠️ 점검일 미입력 알림 (30일 후)</div>
                          <div>• 🔄 취득세 자동 등록 안내 포함</div>
                        </div>
                        <div className="mt-2 text-xs text-gray-500">
                          담당자: {notificationAssignments.station_alerts.length}명
                        </div>
                      </div>
                    </div>

                    {/* MVP 설명 박스 */}
                    <div className="mt-4 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                      <div className="flex items-start">
                        <svg className="w-5 h-5 text-blue-300 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                          <p className="text-blue-200 font-medium text-sm">📧 MVP 이메일 알림 정책</p>
                          <p className="text-blue-300 text-sm mt-1">
                            스팸 방지를 위해 핵심 알림만 이메일로 발송합니다:
                          </p>
                          <ul className="text-blue-300 text-xs mt-2 space-y-1">
                            <li>• 🚨 <strong>세금 긴급 알림</strong>: 납부 기한 3일 전만</li>
                            <li>• 📅 <strong>승인일/점검일 입력 완료</strong>: 최초 입력 시 즉시 발송</li>
                            <li>• ⚠️ <strong>정보 미입력 알림</strong>: 승인일 30일 후, 점검일 30일 후</li>
                            <li>• 🔄 <strong>취득세 자동 등록</strong>: 날짜 입력 시 세금 자동 생성 안내</li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    {/* SendGrid 미설정 경고 */}
                    {!SendGridAPI.hasValidApiKey() && (
                      <div className="mt-4 p-4 bg-amber-900/20 border border-amber-500/30 rounded-lg">
                        <div className="flex items-start">
                          <AlertCircle className="w-5 h-5 text-amber-300 mr-3 flex-shrink-0 mt-0.5" />
                          <div>
                            <p className="text-amber-200 font-medium text-sm">SendGrid API 설정이 필요합니다</p>
                            <p className="text-amber-300 text-sm mt-1">
                              이메일 알림을 사용하려면 API 설정에서 SendGrid를 먼저 설정해주세요.
                            </p>
                            {currentUser?.role === 'super_admin' && (
                              <button 
                                onClick={() => setCurrentView('api-settings')}
                                className="mt-2 px-3 py-1 bg-amber-600/20 text-amber-200 rounded-lg hover:bg-amber-600/30 transition-colors text-sm font-medium border border-amber-500/30"
                              >
                                API 설정으로 이동
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                  </div>


                </div>
              )}
            </div>
          )}
          {currentView === 'api-settings' && currentUser?.role === 'super_admin' && (
            <div className="w-full px-6 py-8">
              <div className="mb-8">
                <h2 className="text-2xl font-bold text-gray-100 mb-2">API 설정</h2>
                <p className="text-gray-400">외부 API 서비스 연동을 관리합니다</p>
              </div>

              {/* API 카드 그리드 */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                {/* Google Vision API */}
                <div className={`${CARD_STYLES} p-6 hover:shadow-lg transition-all duration-300`}>
                  <div className="flex items-start justify-between mb-6">
                    <div className="flex items-center space-x-4">
                      <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                        currentApiKey ? 'bg-emerald-500/20' : 'bg-amber-500/20'
                      }`}>
                        <svg className={`w-6 h-6 ${currentApiKey ? 'text-emerald-400' : 'text-amber-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-100">Google Vision API</h3>
                        <p className="text-sm text-gray-400">OCR 문서 자동 인식</p>
                      </div>
                    </div>
                    <span className={`px-3 py-1 rounded-full text-xs font-medium border ${
                      currentApiKey 
                        ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' 
                        : 'bg-amber-500/20 text-amber-300 border-amber-500/30'
                    }`}>
                      {currentApiKey ? '연결됨' : '미설정'}
                    </span>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-300 mb-2">API 키</label>
                      <div className="relative">
                        <input 
                          type={currentApiKey && apiKeyForm.googleVisionApiKey === currentApiKey ? "password" : "text"}
                          value={apiKeyForm.googleVisionApiKey}
                          onChange={(e) => setApiKeyForm({...apiKeyForm, googleVisionApiKey: e.target.value})}
                          className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-gray-100 font-mono text-sm pr-12"
                          placeholder="Google Cloud Vision API 키를 입력하세요"
                        />
                        {currentApiKey && (
                          <button
                            type="button"
                            onClick={() => {
                              if (apiKeyForm.googleVisionApiKey === currentApiKey) {
                                setApiKeyForm({...apiKeyForm, googleVisionApiKey: ''});
                              } else {
                                setApiKeyForm({...apiKeyForm, googleVisionApiKey: currentApiKey});
                              }
                            }}
                            className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors"
                            title={apiKeyForm.googleVisionApiKey === currentApiKey ? "숨기기" : "표시"}
                          >
                            {apiKeyForm.googleVisionApiKey === currentApiKey ? (
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                              </svg>
                            ) : (
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                              </svg>
                            )}
                          </button>
                        )}
                      </div>
                    </div>

                    <div className="flex space-x-3">
                      <button 
                        onClick={handleUpdateApiKey}
                        disabled={!apiKeyForm.googleVisionApiKey?.trim() || apiKeyForm.googleVisionApiKey === currentApiKey || isUpdatingApiKey}
                        className={`flex-1 px-4 py-2 rounded-lg transition-all duration-200 font-medium ${
                          !apiKeyForm.googleVisionApiKey?.trim() || apiKeyForm.googleVisionApiKey === currentApiKey || isUpdatingApiKey
                            ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed'
                            : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
                        }`}
                      >
                        {isUpdatingApiKey ? '저장 중...' : currentApiKey ? 'API 키 업데이트' : 'API 키 설정'}
                      </button>
                      {currentApiKey && (
                        <button 
                          onClick={handleDeleteApiKey}
                          className="px-4 py-2 bg-red-600/20 text-red-300 rounded-lg hover:bg-red-600/30 transition-colors font-medium border border-red-500/30"
                        >
                          삭제
                        </button>
                      )}
                    </div>

                    {/* 현재 API 키 정보 */}
                    {currentApiKey && (
                      <div className="bg-slate-800/30 rounded-lg p-3 border border-slate-600/20">
                        <div className="text-xs text-gray-400 mb-1">현재 설정된 API 키</div>
                        <div className="text-xs font-mono text-gray-300 bg-slate-900/50 p-2 rounded">
                          {currentApiKey.substring(0, 8)}...{currentApiKey.substring(currentApiKey.length - 4)}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* SendGrid API */}
                <div className={`${CARD_STYLES} p-6 hover:shadow-lg transition-all duration-300`}>
                  <div className="flex items-start justify-between mb-6">
                    <div className="flex items-center space-x-4">
                      <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                        SendGridAPI.hasValidApiKey() ? 'bg-emerald-500/20' : 'bg-amber-500/20'
                      }`}>
                        <svg className={`w-6 h-6 ${SendGridAPI.hasValidApiKey() ? 'text-emerald-400' : 'text-amber-400'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-100">SendGrid Email</h3>
                        <p className="text-sm text-gray-400">자동 알림 이메일 전송</p>
                      </div>
                    </div>
                    <span className={`px-3 py-1 rounded-full text-xs font-medium border ${
                      SendGridAPI.hasValidApiKey()
                        ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' 
                        : 'bg-amber-500/20 text-amber-300 border-amber-500/30'
                    }`}>
                      {SendGridAPI.hasValidApiKey() ? '연결됨' : '미설정'}
                    </span>
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-300 mb-2">SendGrid API 키</label>
                      <input 
                        type="password"
                        value={sendGridForm.apiKey}
                        onChange={(e) => setSendGridForm({...sendGridForm, apiKey: e.target.value})}
                        className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-gray-100 font-mono text-sm"
                        placeholder="SG.xxxxxxxxxx"
                      />
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-300 mb-2">발신자 이메일</label>
                        <input 
                          type="email"
                          value={sendGridForm.fromEmail}
                          onChange={(e) => setSendGridForm({...sendGridForm, fromEmail: e.target.value})}
                          className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-gray-100 text-sm"
                          placeholder="noreply@yourcompany.com"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-medium text-gray-300 mb-2">발신자 이름</label>
                        <input 
                          type="text"
                          value={sendGridForm.fromName}
                          onChange={(e) => setSendGridForm({...sendGridForm, fromName: e.target.value})}
                          className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-gray-100 text-sm"
                          placeholder="Water TT 관리시스템"
                        />
                      </div>
                    </div>

                    <div className="flex space-x-3">
                      <button 
                        onClick={handleUpdateSendGrid}
                        disabled={!sendGridForm.apiKey?.trim() || !sendGridForm.fromEmail?.trim() || !sendGridForm.fromName?.trim() || isUpdatingSendGrid}
                        className={`flex-1 px-4 py-2 rounded-lg transition-all duration-200 font-medium ${
                          !sendGridForm.apiKey?.trim() || !sendGridForm.fromEmail?.trim() || !sendGridForm.fromName?.trim() || isUpdatingSendGrid
                            ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed'
                            : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
                        }`}
                      >
                        {isUpdatingSendGrid ? '저장 중...' : '설정 저장'}
                      </button>
                      {SendGridAPI.hasValidApiKey() && (
                        <button 
                          onClick={handleDeleteSendGrid}
                          className="px-4 py-2 bg-red-600/20 text-red-300 rounded-lg hover:bg-red-600/30 transition-colors font-medium border border-red-500/30"
                        >
                          삭제
                        </button>
                      )}
                    </div>

                    {/* 현재 SendGrid 설정 정보 */}
                    {SendGridAPI.hasValidApiKey() && (
                      <div className="bg-slate-800/30 rounded-lg p-3 border border-slate-600/20">
                        <div className="text-xs text-gray-400 mb-1">현재 설정</div>
                        <div className="text-xs space-y-1">
                          <div className="text-gray-300">
                            <span className="text-gray-400">API 키:</span> {SendGridAPI.config.apiKey.substring(0, 8)}...
                          </div>
                          <div className="text-gray-300">
                            <span className="text-gray-400">발신자:</span> {SendGridAPI.config.fromName} ({SendGridAPI.config.fromEmail})
                          </div>
                        </div>
                      </div>
                    )}

                    {/* 테스트 이메일 전송 */}
                    {SendGridAPI.hasValidApiKey() && (
                      <div className="border-t border-slate-600/30 pt-4">
                        <label className="block text-sm font-medium text-gray-300 mb-2">테스트 이메일 전송</label>
                        <div className="flex space-x-2">
                          <input 
                            type="email"
                            value={testEmailAddress}
                            onChange={(e) => setTestEmailAddress(e.target.value)}
                            className="flex-1 px-3 py-2 bg-slate-700/50 border border-slate-600/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/50 text-gray-100 text-sm"
                            placeholder="test@example.com"
                          />
                          <button 
                            onClick={handleSendTestEmail}
                            disabled={!testEmailAddress?.trim() || isSendingTestEmail}
                            className={`px-4 py-2 rounded-lg transition-all duration-200 font-medium text-sm ${
                              !testEmailAddress?.trim() || isSendingTestEmail
                                ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed'
                                : 'bg-gradient-to-r from-emerald-600 to-emerald-500 text-white hover:from-emerald-500 hover:to-emerald-400'
                            }`}
                          >
                            {isSendingTestEmail ? '전송 중...' : '테스트'}
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* API 설정 가이드 */}
              <div className={`${CARD_STYLES} p-6`}>
                <h3 className="text-lg font-semibold text-gray-100 mb-4 flex items-center">
                  <svg className="w-5 h-5 mr-3 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  API 설정 가이드
                </h3>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* Google Vision API 가이드 */}
                  <div>
                    <h4 className="text-sm font-medium text-gray-300 mb-3 flex items-center">
                      <svg className="w-4 h-4 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      Google Vision API 설정
                    </h4>
                    <ol className="text-sm text-gray-400 space-y-2 list-decimal list-inside mb-4">
                      <li>Google Cloud Console 접속</li>
                      <li>새 프로젝트 생성 또는 기존 프로젝트 선택</li>
                      <li>Vision API 활성화</li>
                      <li>사용자 인증 정보 → API 키 생성</li>
                      <li>생성된 API 키를 위 필드에 입력</li>
                    </ol>
                    <ul className="text-sm text-gray-400 space-y-2">
                      <li className="flex items-center">
                        <CheckCircle className="w-4 h-4 text-emerald-400 mr-2" />
                        세금 고지서 자동 인식
                      </li>
                      <li className="flex items-center">
                        <CheckCircle className="w-4 h-4 text-emerald-400 mr-2" />
                        금액 및 날짜 추출
                      </li>
                      <li className="flex items-center">
                        <CheckCircle className="w-4 h-4 text-emerald-400 mr-2" />
                        높은 정확도 OCR 분석
                      </li>
                      <li className="flex items-center">
                        <CheckCircle className="w-4 h-4 text-emerald-400 mr-2" />
                        PDF 파일 지원
                      </li>
                    </ul>
                  </div>
                  
                  {/* SendGrid API 가이드 */}
                  <div>
                    <h4 className="text-sm font-medium text-gray-300 mb-3 flex items-center">
                      <svg className="w-4 h-4 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      SendGrid Email 설정
                    </h4>
                    <ol className="text-sm text-gray-400 space-y-2 list-decimal list-inside mb-4">
                      <li>SendGrid 계정 생성 (sendgrid.com)</li>
                      <li>이메일 주소 또는 도메인 인증</li>
                      <li>API Keys → Create API Key</li>
                      <li>Full Access 또는 Mail Send 권한 선택</li>
                      <li>생성된 API 키를 복사하여 입력</li>
                    </ol>
                    <ul className="text-sm text-gray-400 space-y-2">
                      <li className="flex items-center">
                        <CheckCircle className="w-4 h-4 text-emerald-400 mr-2" />
                        납부 기한 자동 알림
                      </li>
                      <li className="flex items-center">
                        <CheckCircle className="w-4 h-4 text-emerald-400 mr-2" />
                        충전소 정보 미입력 알림
                      </li>
                      <li className="flex items-center">
                        <CheckCircle className="w-4 h-4 text-emerald-400 mr-2" />
                        HTML 이메일 템플릿
                      </li>
                      <li className="flex items-center">
                        <CheckCircle className="w-4 h-4 text-emerald-400 mr-2" />
                        높은 전송 성공률
                      </li>
                    </ul>
                  </div>
                </div>

                <div className="mt-6 p-4 bg-amber-900/20 border border-amber-500/30 rounded-lg">
                  <div className="flex items-start">
                    <AlertCircle className="w-5 h-5 text-amber-300 mr-3 flex-shrink-0 mt-0.5" />
                    <div>
                      <p className="text-amber-200 font-medium text-sm">보안 주의사항</p>
                      <p className="text-amber-300 text-sm mt-1">
                        API 키는 안전하게 보관하고 외부에 노출되지 않도록 주의하세요. 
                        정기적으로 키를 교체하는 것을 권장합니다.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* 시스템 알림 토스트 */}
      {systemNotifications.length > 0 && (
        <div className="fixed top-4 right-4 z-50 space-y-2">
          {systemNotifications.map((notification) => (
            <div
              key={notification.id}
              className={`max-w-sm w-full shadow-lg rounded-lg p-4 border transition-all duration-300 animate-slide-in-right ${
                notification.type === 'success'
                  ? 'bg-emerald-900/90 border-emerald-500/50 text-emerald-100'
                  : notification.type === 'error'
                  ? 'bg-red-900/90 border-red-500/50 text-red-100'
                  : notification.type === 'warning'
                  ? 'bg-amber-900/90 border-amber-500/50 text-amber-100'
                  : 'bg-blue-900/90 border-blue-500/50 text-blue-100'
              } backdrop-blur-md`}
            >
              <div className="flex items-center">
                <div className="flex-shrink-0">
                  {notification.type === 'success' && <CheckCircle className="w-5 h-5" />}
                  {notification.type === 'error' && <AlertCircle className="w-5 h-5" />}
                  {notification.type === 'warning' && <AlertCircle className="w-5 h-5" />}
                  {notification.type === 'info' && <Bell className="w-5 h-5" />}
                </div>
                <div className="ml-3 flex-1">
                  <p className="text-sm font-medium">{notification.message}</p>
                </div>
                <button
                  onClick={() => setSystemNotifications(prev => prev.filter(n => n.id !== notification.id))}
                  className="ml-4 text-gray-400 hover:text-gray-200"
                >
                  <X className="w-4 h-4" />
                </button>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* 모달들 */}
      <Modal isOpen={showAnalysisModal} onClose={() => setShowAnalysisModal(false)} title="스마트 문서 분석" size="md" heightMode="fixed">
        {isAnalyzing ? (
          <div className="text-center py-8">
            <div className="animate-spin rounded-full h-12 w-12 border-2 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <h2 className="text-lg font-medium text-gray-100 mb-2">데이터를 확인하고 있습니다</h2>
            <p className="text-gray-400 text-sm">잠시만 기다려주세요...</p>
          </div>
        ) : analyzedData && (
          <div className="h-full flex flex-col">
            {/* 전체 스크롤 영역 - 분석 헤더 + 폼 */}
            <div className="flex-1 overflow-y-auto custom-scrollbar min-h-0">
              {/* 분석 결과 헤더 */}
              <div className={`mb-4 p-4 rounded-xl border ${
                analyzedData.error 
                  ? 'bg-amber-900/30 border-amber-500/30' 
                  : analyzedData.confidence > 0.8
                  ? 'bg-emerald-900/30 border-emerald-500/30'
                  : analyzedData.confidence > 0.6
                  ? 'bg-blue-900/30 border-blue-500/30'
                  : 'bg-amber-900/30 border-amber-500/30'
              }`}>
                <div className="flex items-center justify-between mb-2">
                  <div className="flex items-center space-x-2">
                    {analyzedData.confidence > 0.8 ? (
                      <CheckCircle className="w-5 h-5 text-emerald-400" />
                    ) : analyzedData.confidence > 0.6 ? (
                      <Zap className="w-5 h-5 text-blue-400" />
                    ) : (
                      <AlertCircle className="w-5 h-5 text-amber-400" />
                    )}
                    <p className={`text-sm font-medium ${
                      analyzedData.error ? 'text-amber-200' : 
                      analyzedData.confidence > 0.8 ? 'text-emerald-200' :
                      analyzedData.confidence > 0.6 ? 'text-blue-200' : 'text-amber-200'
                    }`}>
                      {analyzedData.error ? '⚠ 기본 분석 모드' : 
                       analyzedData.confidence > 0.8 ? '✓ 고신뢰도 분석 완료' :
                       analyzedData.confidence > 0.6 ? '✓ 양호한 분석 완료' : '⚠ 기본 분석 완료'}
                    </p>
                  </div>
                  <div className="flex items-center space-x-2">
                    <span className={`text-xs px-2 py-1 rounded ${
                      analyzedData.error ? 'bg-amber-500/20 text-amber-300' : 
                      analyzedData.confidence > 0.8 ? 'bg-emerald-500/20 text-emerald-300' :
                      analyzedData.confidence > 0.6 ? 'bg-blue-500/20 text-blue-300' : 'bg-amber-500/20 text-amber-300'
                    }`}>
                      신뢰도 {Math.round(analyzedData.confidence * 100)}%
                    </span>
                    {analyzedData.method && (
                      <span className="text-xs px-2 py-1 bg-slate-500/20 text-slate-300 rounded">
                        {analyzedData.method === 'local_analysis' ? '로컬 분석' :
                         analyzedData.method === 'web_api' ? '웹 API' :
                         analyzedData.method === 'tesseract_ocr' ? 'OCR' : '기본값'}
                      </span>
                    )}
                  </div>
                </div>
                
                {analyzedData.error ? (
                  <p className="text-xs text-amber-300 mb-2">내용을 확인하고 수정해주세요</p>
                ) : (
                  <p className="text-xs text-gray-400 mb-2">
                    {analyzedData.confidence > 0.8 ? '높은 정확도로 분석되었습니다' :
                     analyzedData.confidence > 0.6 ? '양호한 정확도입니다. 일부 내용을 확인해주세요' : 
                     '기본 분석입니다. 모든 내용을 확인해주세요'}
                  </p>
                )}
                
                {/* 분석 방법 상세 정보 */}
                {analyzedData.allResults && analyzedData.allResults.length > 1 && (
                  <details className="mt-2">
                    <summary className="text-xs text-gray-400 cursor-pointer hover:text-gray-300">분석 방법 상세 보기</summary>
                    <div className="mt-2 space-y-1">
                      {analyzedData.allResults.map((result, index) => (
                        <div key={index} className="flex items-center justify-between text-xs">
                          <span className="text-gray-400">
                            {result.strategy === 'googleVisionOCR' ? '구글 비전 API' :
                             result.strategy === 'localAnalysis' ? '로컬 패턴 분석' :
                             result.strategy === 'fallbackAnalysis' ? '기본 분석 처리' : result.strategy}
                          </span>
                          <span className={result.success ? 'text-emerald-400' : 'text-red-400'}>
                            {result.success ? `✓ ${Math.round(result.confidence * 100)}%` : '✗ 실패'}
                          </span>
                        </div>
                      ))}
                    </div>
                  </details>
                )}
                
                {/* 원본 텍스트는 접을 수 있도록 */}
                {analyzedData.extractedText && (
                  <details className="mt-2">
                    <summary className="text-xs text-gray-400 cursor-pointer hover:text-gray-300">추출된 정보 보기</summary>
                    <div className="mt-2 p-2 bg-slate-800/50 rounded border text-xs text-gray-300 font-mono max-h-20 overflow-y-auto">
                      {analyzedData.extractedText}
                    </div>
                  </details>
                )}
              </div>
              
              {/* 폼 입력 영역 */}
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">충전소</label>
                  <div className="relative" ref={analysisStationDropdownRef}>
                    <input 
                      type="text" 
                      value={analyzedData.stationName || stationSearchQuery} 
                      onChange={(e) => {
                        const value = e.target.value;
                        setStationSearchQuery(value);
                        setShowStationDropdown(true);
                        
                        const exactMatch = enhancedStations.find(station => station.name === value);
                        if (exactMatch) {
                          setAnalyzedData({...analyzedData, stationName: exactMatch.name, address: exactMatch.address});
                          setShowStationDropdown(false);
                        } else if (!value) {
                          setAnalyzedData({...analyzedData, stationName: '', address: ''});
                        }
                      }} 
                      onFocus={() => setShowStationDropdown(true)} 
                      className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm text-sm" 
                      placeholder="충전소 이름이나 주소로 검색..." 
                    />
                    
                    {showStationDropdown && (
                      <div className="absolute z-10 w-full mt-1 bg-slate-800 border border-slate-600 rounded-xl shadow-xl max-h-48 overflow-y-auto">
                        {filteredStations.length > 0 ? (
                          <>
                            {filteredStations.map((station, index) => (
                              <button key={index} type="button" onClick={() => { 
                                setAnalyzedData({...analyzedData, stationName: station.name, address: station.address}); 
                                setStationSearchQuery(''); 
                                setShowStationDropdown(false); 
                              }} className="w-full px-4 py-3 text-left hover:bg-slate-700/50 transition-colors border-b border-slate-700/50 last:border-b-0">
                                <div className="font-medium text-gray-200 text-sm">{station.name}</div>
                                <div className="text-gray-400 text-xs">{station.address}</div>
                                <div className="text-blue-300 mt-1 text-xs">세금 {station.totalBills}건 • 총 ₩{utils.formatKoreanCurrency(station.totalAmount)}</div>
                              </button>
                            ))}
                            <button type="button" onClick={() => { 
                              const addressParts = analyzedData.address?.split(' ') || [];
                              const suggestedName = addressParts.length >= 3 ? `${addressParts[2]} 충전소` : addressParts.length > 0 ? `${addressParts[addressParts.length - 1]} 충전소` : '새 충전소';
                              setNewStation({ 
                                name: stationSearchQuery || suggestedName, 
                                address: analyzedData.address || '', 
                                status: 'operating', 
                                approvalDate: '', 
                                safetyCheckDate: '', 
                                registeredDate: koreaTimeUtils.getKoreaToday() 
                              }); 
                              setEditingStation(null);
                              setShowStationForm(true); 
                              setShowStationDropdown(false); 
                            }} className="w-full px-4 py-2 bg-blue-600 text-white hover:bg-blue-500 transition-colors font-medium text-sm">
                              <div className="flex items-center">
                                <Plus className="w-4 h-4 mr-2" />
                                <span>{stationSearchQuery ? `"${stationSearchQuery}" 새 충전소로 추가` : '새 충전소 추가'}</span>
                              </div>
                            </button>
                          </>
                        ) : (
                          <div className="px-4 py-6 text-center">
                            <div className="text-gray-400 mb-3 text-sm">검색 결과가 없습니다</div>
                            <button type="button" onClick={() => { 
                              const addressParts = analyzedData.address?.split(' ') || [];
                              const suggestedName = addressParts.length >= 3 ? `${addressParts[2]} 충전소` : addressParts.length > 0 ? `${addressParts[addressParts.length - 1]} 충전소` : '새 충전소';
                              setNewStation({ 
                                name: stationSearchQuery || suggestedName, 
                                address: analyzedData.address || '', 
                                status: 'operating', 
                                approvalDate: '', 
                                safetyCheckDate: '', 
                                registeredDate: koreaTimeUtils.getKoreaToday() 
                              }); 
                              setEditingStation(null);
                              setShowStationForm(true); 
                              setShowStationDropdown(false); 
                            }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors font-medium text-sm">
                              <Plus className="w-4 h-4 mr-2 inline" />
                              {stationSearchQuery ? `"${stationSearchQuery}" 새 충전소로 추가` : '새 충전소 추가'}
                            </button>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                </div>
                
                {analyzedData.stationName && (
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">주소</label>
                    <div className="w-full px-4 py-3 bg-slate-700/30 border border-slate-600/30 rounded-xl text-gray-300 text-sm">{analyzedData.address}</div>
                  </div>
                )}
                
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">세금 분류</label>
                    <select value={analyzedData.category} onChange={(e) => setAnalyzedData({...analyzedData, category: e.target.value})} className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm text-sm">
                      <option value="취득세">취득세</option>
                      <option value="재산세">재산세</option>
                      <option value="기타세">기타세</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">납부 기한</label>
                    <input 
                      type="date" 
                      value={analyzedData.dueDate} 
                      onChange={(e) => setAnalyzedData({...analyzedData, dueDate: e.target.value})} 
                      min={dateRanges.getDueDateRange().min}
                      max={dateRanges.getDueDateRange().max}
                      className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm text-sm" 
                    />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">세금 제목</label>
                  <input type="text" value={analyzedData.name} onChange={(e) => setAnalyzedData({...analyzedData, name: e.target.value})} className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm text-sm" placeholder="예: 충전기 취득세" />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">납부 금액</label>
                  <input 
                    type="text" 
                    value={analyzedData.amount} 
                    onChange={(e) => {
                      const sanitized = amountValidation.sanitizeInput(e.target.value);
                      setAnalyzedData({...analyzedData, amount: sanitized});
                    }}
                    className={`w-full px-4 py-3 bg-slate-700/50 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm font-mono text-sm ${
                      analyzedData.amount && !amountValidation.isValidAmount(analyzedData.amount) ? 'border-red-500/50' : 'border-slate-600/50'
                    }`}
                    placeholder="금액을 입력하세요. 비워두면 '미정'으로 처리됩니다" 
                  />
                  {analyzedData.amount && !amountValidation.isValidAmount(analyzedData.amount) && (
                    <div className="mt-2 p-2 bg-red-900/20 border border-red-500/30 rounded-lg">
                      <p className="text-red-200 text-xs flex items-center">
                        <AlertCircle className="w-3 h-3 mr-1" />
                        {amountValidation.getAmountErrorMessage(analyzedData.amount)}
                      </p>
                    </div>
                  )}
                </div>
                
                {/* 반복 납부 설정 */}
                {(analyzedData.category === '재산세' || analyzedData.category === '기타세') && (
                  <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-600/30">
                    <div className="flex items-center space-x-3">
                      <input 
                        type="checkbox" 
                        id="recurring-analysis" 
                        checked={analyzedData.isRecurring || false}
                        onChange={(e) => setAnalyzedData({...analyzedData, isRecurring: e.target.checked})}
                        className="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2"
                      />
                      <label htmlFor="recurring-analysis" className="text-sm font-medium text-gray-300">
                        매년 반복 납부
                      </label>
                      <div className="relative group">
                        <div 
                          className="w-4 h-4 bg-slate-600 rounded-full flex items-center justify-center cursor-help"
                          onMouseEnter={() => setShowTooltip('recurring-analysis')}
                          onMouseLeave={() => setShowTooltip(null)}
                          onClick={() => setShowTooltip(showTooltip === 'recurring-analysis' ? null : 'recurring-analysis')}
                        >
                          <span className="text-xs text-slate-300">?</span>
                        </div>
                        <div className={`absolute bottom-6 left-1/2 transform -translate-x-1/2 transition-opacity duration-200 z-10 ${showTooltip === 'recurring-analysis' ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                          <div className="bg-slate-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
                            <div className="space-y-1">
                              <div>• 매년 같은 날짜로 자동 생성</div>
                              <div>• 미래 납부는 금액 '미정'</div>
                              <div>• 총 6년치 자동 생성 (현재년도 포함)</div>
                            </div>
                            <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-900"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
            
            {/* 하단 고정 영역 - 버튼만 */}
            <div className="flex-shrink-0 flex space-x-3 mt-6 pt-4 border-t border-slate-600/30">
              <button onClick={() => setShowAnalysisModal(false)} className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium text-sm">취소</button>
              <button 
                onClick={confirmAnalysis} 
                disabled={!analyzedData?.name?.trim() || !analyzedData?.dueDate || !analyzedData?.stationName?.trim() || !analyzedData?.category || (analyzedData?.amount && !amountValidation.isValidAmount(analyzedData.amount))}
                className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg text-sm ${
                  !analyzedData?.name?.trim() || !analyzedData?.dueDate || !analyzedData?.stationName?.trim() || !analyzedData?.category || (analyzedData?.amount && !amountValidation.isValidAmount(analyzedData.amount))
                    ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
                    : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
                }`}
              >
                등록
              </button>
            </div>
          </div>
        )}
      </Modal>

      <Modal isOpen={showAddForm} onClose={() => { setShowAddForm(false); setEditingBill(null); setNewBill({ name: '', amount: '', dueDate: '', category: '', stationName: '', address: '' }); setStationSearchQuery(''); setShowStationDropdown(false); }} title={editingBill ? '세금 정보 수정' : '세금 정보 입력'} heightMode="fixed">
        <div className="flex flex-col h-full">
          {/* 상단 고정 영역 - 타이틀 및 안내 */}
          <div className="flex-shrink-0 mb-4">
            {editingBill && (
              <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-3 mb-4">
                <p className="text-blue-200 text-sm">기존 세금 정보를 수정합니다.</p>
              </div>
            )}
          </div>

          {/* 중간 스크롤 영역 - 폼 입력 */}
          <div className="flex-1 overflow-y-auto custom-scrollbar min-h-0">
            <div className={`space-y-4 ${isMobile ? 'space-y-6' : ''}`}>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">충전소</label>
                {editingBill ? (
                  <div className="w-full px-4 py-3 bg-gray-600/30 border border-gray-500/30 rounded-xl text-gray-300 text-sm cursor-not-allowed">{newBill.stationName}</div>
                ) : (
                  <div className="relative" ref={stationDropdownRef}>
                    <input type="text" value={newBill.stationName || stationSearchQuery} onChange={(e) => {
                      const value = e.target.value;
                      setStationSearchQuery(value);
                      setShowStationDropdown(true);
                      
                      const exactMatch = enhancedStations.find(station => station.name === value);
                      if (exactMatch) {
                        setNewBill({...newBill, stationName: exactMatch.name, address: exactMatch.address});
                        setShowStationDropdown(false);
                      } else if (!value) {
                        setNewBill({...newBill, stationName: '', address: ''});
                      }
                    }} onFocus={() => setShowStationDropdown(true)} className={`w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm ${isMobile ? 'h-12 text-base' : ''}`} placeholder="충전소 이름이나 주소로 검색..." />
                    
                    {showStationDropdown && (
                      <div className={`absolute z-10 w-full mt-1 bg-slate-800 border border-slate-600 rounded-xl shadow-xl ${isMobile ? 'max-h-48' : 'max-h-48'} overflow-y-auto`}>
                        {filteredStations.length > 0 ? (
                          <>
                            {filteredStations.map((station, index) => (
                              <button key={index} type="button" onClick={() => { setNewBill({...newBill, stationName: station.name, address: station.address}); setStationSearchQuery(''); setShowStationDropdown(false); }} className={`w-full px-4 py-3 text-left hover:bg-slate-700/50 transition-colors border-b border-slate-700/50 last:border-b-0 ${isMobile ? 'py-4' : ''}`}>
                                <div className={`font-medium text-gray-200 ${isMobile ? 'text-base' : 'text-sm'}`}>{station.name}</div>
                                <div className={`text-gray-400 ${isMobile ? 'text-sm mt-1' : 'text-xs'}`}>{station.address}</div>
                                <div className={`text-blue-300 mt-1 ${isMobile ? 'text-sm' : 'text-xs'}`}>세금 {station.totalBills}건 • 총 ₩{utils.formatKoreanCurrency(station.totalAmount)}</div>
                              </button>
                            ))}
                            <button type="button" onClick={() => { setShowStationForm(true); setEditingStation(null);       setNewStation({ name: stationSearchQuery, address: '', status: 'operating', approvalDate: '', safetyCheckDate: '', registeredDate: koreaTimeUtils.getKoreaToday() }); setShowStationDropdown(false); }} className={`px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors font-medium ${isMobile ? 'py-3 text-base' : 'text-sm'}`}>
                              <div className="flex items-center">
                                <Plus className={`mr-2 ${isMobile ? 'w-5 h-5' : 'w-4 h-4'}`} />
                                <span>{stationSearchQuery ? `"${stationSearchQuery}" 새 충전소로 추가` : '새 충전소 추가'}</span>
                              </div>
                            </button>
                          </>
                        ) : (
                          <div className={`px-4 py-6 text-center ${isMobile ? 'py-8' : ''}`}>
                            <div className={`text-gray-400 mb-3 ${isMobile ? 'text-base' : 'text-sm'}`}>검색 결과가 없습니다</div>
                            <button type="button" onClick={() => { setShowStationForm(true); setEditingStation(null); setNewStation({ name: stationSearchQuery, address: '', status: 'operating' }); setShowStationDropdown(false); }} className={`px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors font-medium ${isMobile ? 'py-3 text-base' : 'text-sm'}`}>
                              <Plus className={`mr-2 inline ${isMobile ? 'w-5 h-5' : 'w-4 h-4'}`} />
                              {stationSearchQuery ? `"${stationSearchQuery}" 새 충전소로 추가` : '새 충전소 추가'}
                            </button>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
              
              {newBill.stationName && newBill.stationName !== '__new__' && (
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">주소</label>
                  <div className={`w-full px-4 py-3 rounded-xl text-sm ${editingBill ? 'bg-gray-600/30 border border-gray-500/30 text-gray-300 cursor-not-allowed' : 'bg-slate-700/30 border border-slate-600/30 text-gray-300'} ${isMobile ? 'h-12 text-base' : ''}`}>{newBill.address}</div>
                </div>
              )}
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">세금 제목</label>
                <input type="text" value={newBill.name} onChange={(e) => setNewBill({...newBill, name: e.target.value})} className={`w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm ${isMobile ? 'h-12 text-base' : ''}`} placeholder="예: 충전기 취득세" />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">세금 분류</label>
                {editingBill ? (
                  <div className={`w-full px-4 py-3 bg-gray-600/30 border border-gray-500/30 rounded-xl text-gray-300 text-sm cursor-not-allowed ${isMobile ? 'h-12 text-base' : ''}`}>{newBill.category}</div>
                ) : (
                  <select value={newBill.category} onChange={(e) => setNewBill({...newBill, category: e.target.value})} className={`w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm ${isMobile ? 'h-12 text-base' : ''}`}>
                    <option value="">선택하세요</option>
                    <option value="취득세">취득세</option>
                    <option value="재산세">재산세</option>
                    <option value="기타세">기타세</option>
                  </select>
                )}
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">납부 기한</label>
                <input 
                  type="date" 
                  value={newBill.dueDate} 
                  onChange={(e) => setNewBill({...newBill, dueDate: e.target.value})} 
                  min={dateRanges.getDueDateRange().min}
                  max={dateRanges.getDueDateRange().max}
                  className={`w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm ${isMobile ? 'h-12 text-base' : ''}`} 
                />
              </div>
              
              {/* 반복 납부 설정 */}
              {!editingBill && (newBill.category === '재산세' || newBill.category === '기타세') && (
                <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-600/30">
                  <div className="flex items-center space-x-3">
                    <input 
                      type="checkbox" 
                      id="recurring" 
                      checked={newBill.isRecurring || false}
                      onChange={(e) => setNewBill({...newBill, isRecurring: e.target.checked})}
                      className="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2"
                    />
                    <label htmlFor="recurring" className="text-sm font-medium text-gray-300">
                      매년 반복 납부
                    </label>
                    <div className="relative group">
                      <div 
                        className="w-4 h-4 bg-slate-600 rounded-full flex items-center justify-center cursor-help"
                        onMouseEnter={() => setShowTooltip('recurring')}
                        onMouseLeave={() => setShowTooltip(null)}
                        onClick={() => setShowTooltip(showTooltip === 'recurring' ? null : 'recurring')}
                      >
                        <span className="text-xs text-slate-300">?</span>
                      </div>
                      <div className={`absolute bottom-6 left-1/2 transform -translate-x-1/2 transition-opacity duration-200 z-10 ${showTooltip === 'recurring' ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                        <div className="bg-slate-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
                          <div className="space-y-1">
                            <div>• 매년 같은 날짜로 자동 생성</div>
                            <div>• 미래 납부는 금액 '미정'</div>
                            <div>• 반복 해제 시 미래 납부 삭제</div>
                          </div>
                          <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-900"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* 반복 납부 편집 시 안내 */}
              {editingBill && editingBill.isRecurring && (
                <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-600/30">
                  <div className="flex items-center space-x-3">
                    <input 
                      type="checkbox" 
                      id="recurring-edit" 
                      checked={newBill.isRecurring !== false}
                      onChange={(e) => setNewBill({...newBill, isRecurring: e.target.checked})}
                      className="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2"
                      disabled={!editingBill.isOriginal}
                    />
                    <label htmlFor="recurring-edit" className="text-sm font-medium text-gray-300">
                      매년 반복 납부 {editingBill.isOriginal ? '' : '(연결됨)'}
                    </label>
                    <div className="relative group">
                      <div 
                        className="w-4 h-4 bg-slate-600 rounded-full flex items-center justify-center cursor-help"
                        onMouseEnter={() => setShowTooltip('recurring-edit')}
                        onMouseLeave={() => setShowTooltip(null)}
                        onClick={() => setShowTooltip(showTooltip === 'recurring-edit' ? null : 'recurring-edit')}
                      >
                        <span className="text-xs text-slate-300">?</span>
                      </div>
                      <div className={`absolute bottom-6 left-1/2 transform -translate-x-1/2 transition-opacity duration-200 z-10 ${showTooltip === 'recurring-edit' ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                        <div className="bg-slate-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg border border-slate-700 whitespace-nowrap">
                          <div className="space-y-1">
                            {editingBill.isOriginal ? (
                              <>
                                <div>• 반복 해제 시 미래 납부 삭제</div>
                                <div>• 정보 변경 시 미래 납부 반영</div>
                              </>
                            ) : (
                              <>
                                <div>• 반복 시리즈의 일부</div>
                                <div>• 원본에서만 반복 설정 변경</div>
                              </>
                            )}
                          </div>
                          <div className="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-slate-900"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">납부 금액</label>
                <input 
                  type="text" 
                  value={newBill.amount} 
                  onChange={(e) => {
                    const sanitized = amountValidation.sanitizeInput(e.target.value);
                    setNewBill({...newBill, amount: sanitized});
                  }}
                  className={`w-full px-4 py-3 bg-slate-700/50 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm font-mono ${isMobile ? 'h-12 text-base' : ''} ${
                    newBill.amount && !amountValidation.isValidAmount(newBill.amount) ? 'border-red-500/50' : 'border-slate-600/50'
                  }`}
                  placeholder="금액을 입력하세요. 비워두면 '미정'으로 처리됩니다" 
                />
                {newBill.amount && !amountValidation.isValidAmount(newBill.amount) && (
                  <div className="mt-2 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
                    <p className="text-red-200 text-sm flex items-center">
                      <AlertCircle className="w-4 h-4 mr-2" />
                      {amountValidation.getAmountErrorMessage(newBill.amount)}
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
          
          {/* 하단 고정 영역 - 버튼 */}
          <div className={`flex-shrink-0 flex space-x-3 ${isMobile ? 'mt-8 sticky bottom-0 bg-slate-800/95 backdrop-blur-sm p-4 -m-4 border-t border-slate-700/50' : 'mt-8'}`}>
            <button onClick={() => { setShowAddForm(false); setEditingBill(null); setNewBill({ name: '', amount: '', dueDate: '', category: '', stationName: '', address: '' }); setStationSearchQuery(''); setShowStationDropdown(false); }} className={`flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium ${isMobile ? 'h-12 text-base' : ''}`}>취소</button>
            {editingBill && canDelete && (
              <button onClick={() => {
                moveToTrash(editingBill);
                deleteBill(editingBill.id);
                setShowAddForm(false);
                setEditingBill(null);
                setNewBill({ name: '', amount: '', dueDate: '', category: '', stationName: '', address: '', isRecurring: false });
                setStationSearchQuery('');
                setShowStationDropdown(false);
              }} className={`flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-xl hover:from-red-500 hover:to-red-400 transition-all duration-200 font-medium shadow-lg ${isMobile ? 'h-12 text-base' : ''}`}>삭제</button>
            )}
            <button 
              onClick={editingBill ? handleEditBill : handleAddBill} 
              disabled={!newBill.name || !newBill.dueDate || !newBill.stationName || !newBill.category || (newBill.amount && !amountValidation.isValidAmount(newBill.amount))}
              className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${isMobile ? 'h-12 text-base' : ''} ${
                !newBill.name || !newBill.dueDate || !newBill.stationName || !newBill.category || (newBill.amount && !amountValidation.isValidAmount(newBill.amount))
                  ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
                  : 'bg-gradient-to-r from-emerald-600 to-emerald-500 text-white hover:from-emerald-500 hover:to-emerald-400'
              }`}
            >
              {editingBill ? '수정' : '등록'}
            </button>
          </div>
        </div>
      </Modal>

      <Modal isOpen={showStationForm} onClose={() => { setShowStationForm(false); setEditingStation(null);       setNewStation({ name: '', address: '', status: 'operating', approvalDate: '', safetyCheckDate: '', registeredDate: new Date().toISOString().split('T')[0] }); }} title={editingStation ? '충전소 정보 수정' : '충전소 추가'} heightMode="auto">
        {(() => {
          // 중복 충전소명 체크
          const isDuplicateName = editingStation 
            ? stations.some(station => station.name.toLowerCase() === newStation.name.toLowerCase() && station.name !== editingStation.name)
            : stations.some(station => station.name.toLowerCase() === newStation.name.toLowerCase());
          
          const isFormValid = newStation.name && newStation.address && !isDuplicateName;
          
          return (
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">충전소명</label>
                <input 
                  type="text" 
                  value={newStation.name} 
                  onChange={(e) => {
                    const value = e.target.value;
                    if (value.length <= 30) {
                      setNewStation({...newStation, name: value});
                    }
                  }}
                  maxLength={30}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="예: 강남역 충전소 (최대 30자)" 
                />
                <div className="mt-1 text-xs text-gray-400 text-right">
                  {newStation.name.length}/30자
                </div>
                {isDuplicateName && newStation.name && (
                  <div className="mt-2 p-3 bg-red-900/20 border border-red-500/30 rounded-lg">
                    <p className="text-red-200 text-sm flex items-center">
                      <AlertCircle className="w-4 h-4 mr-2" />
                      이미 존재하는 충전소명입니다. 다른 이름을 사용해주세요.
                    </p>
                  </div>
                )}
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">주소</label>
                <input type="text" value={newStation.address} onChange={(e) => setNewStation({...newStation, address: e.target.value})} className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" placeholder="예: 서울특별시 강남구 테헤란로 123" />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">운영 상태</label>
                <select value={newStation.status} onChange={(e) => setNewStation({...newStation, status: e.target.value})} className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm">
                  <option value="preparing">오픈 예정</option>
                  <option value="operating">운영 중</option>
                  <option value="closed">운영 종료</option>
                </select>
              </div>
              
              <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-600/30">
                <div className="flex items-center space-x-3 mb-3">
                  <input 
                    type="checkbox" 
                    id="needs-approval-new" 
                    checked={newStation.needsApproval || false}
                    onChange={(e) => setNewStation({...newStation, needsApproval: e.target.checked, approvalDate: e.target.checked ? newStation.approvalDate : ''})}
                    className="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600 rounded focus:ring-blue-500 focus:ring-2"
                  />
                  <label htmlFor="needs-approval-new" className="text-sm font-medium text-gray-300">
                    건축물 사용 승인 필요
                  </label>
                </div>
                <p className="text-xs text-gray-400 ml-7">
                  체크 시 건축물 사용 승인일 입력이 필요하며, 미입력 시 알림을 받습니다
                </p>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">건축물 사용 승인일</label>
                <input 
                  type="date" 
                  value={newStation.approvalDate} 
                  onChange={(e) => setNewStation({...newStation, approvalDate: e.target.value})} 
                  disabled={!newStation.needsApproval}
                  min={dateRanges.getGeneralDateRange().min}
                  max={dateRanges.getGeneralDateRange().max}
                  className={`w-full px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-gray-100 backdrop-blur-sm transition-all ${
                    !newStation.needsApproval 
                      ? 'bg-gray-600/30 border border-gray-500/30 text-gray-500 cursor-not-allowed'
                      : 'bg-slate-700/50 border border-slate-600/50 focus:border-blue-500/50'
                  }`}
                />
                {!newStation.needsApproval && (
                  <p className="text-xs text-gray-500 mt-1">승인이 필요한 경우 위 체크박스를 선택해주세요</p>
                )}
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">전기 안전 점검일 (필수)</label>
                <input 
                  type="date" 
                  value={newStation.safetyCheckDate} 
                  onChange={(e) => setNewStation({...newStation, safetyCheckDate: e.target.value})} 
                  min={dateRanges.getGeneralDateRange().min}
                  max={dateRanges.getGeneralDateRange().max}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                />
                <p className="text-xs text-gray-400 mt-1">모든 충전소는 전기 안전 점검이 필수입니다</p>
              </div>
              
              <div className="flex space-x-3 mt-8">
                <button onClick={() => { setShowStationForm(false); setEditingStation(null); setNewStation({ name: '', address: '', status: 'operating', approvalDate: '', safetyCheckDate: '' }); }} className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium">취소</button>
                {editingStation && canDelete && (
                  <button onClick={() => {
                    const hasRelatedBills = bills.some(bill => bill.stationName === editingStation.name);
                    if (hasRelatedBills) {
                      alert('이 충전소에 연결된 세금이 있어 삭제할 수 없습니다.\n먼저 관련 세금을 삭제하거나 다른 충전소로 이전해주세요.');
                      return;
                    }
                    deleteStation(editingStation.name);
                    setShowStationForm(false);
                    setEditingStation(null);
                    setNewStation({ name: '', address: '', status: 'operating', approvalDate: '', safetyCheckDate: '' });
                  }} className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
                    bills.some(bill => bill.stationName === editingStation?.name) 
                      ? 'bg-gray-500 cursor-not-allowed opacity-50' 
                      : 'bg-gradient-to-r from-red-600 to-red-500 text-white hover:from-red-500 hover:to-red-400'
                  }`}>삭제</button>
                )}
                <button 
                  onClick={editingStation ? handleEditStation : handleAddStation} 
                  disabled={!isFormValid}
                  className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
                    !isFormValid
                      ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
                      : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
                  }`}
                >
                  {editingStation ? '수정' : '추가'}
                </button>
              </div>
            </div>
          );
        })()}
      </Modal>

      <Modal isOpen={showDateModal} onClose={() => setShowDateModal(false)} title={`${selectedDateBills[0]?.dueDate || selectedStationEvents[0]?.stationName || selectedCompletedBills[0]?.completedDate ? (selectedDateBills[0]?.dueDate || selectedCompletedBills[0]?.completedDate || new Date().toISOString().split('T')[0]) : ''} 일정`} size="xl" heightMode="fixed">
        <DateModalContent
          selectedDateBills={selectedDateBills}
          selectedCompletedBills={selectedCompletedBills}
          selectedStationEvents={selectedStationEvents}
          utils={utils}
        />
      </Modal>
      
      <Modal isOpen={showCompletedModal} onClose={() => setShowCompletedModal(false)} title="납부 완료 세금" size="xl" heightMode="fixed">
        {getBillsByStatus('completed').length === 0 ? (
          <div className="text-center py-12">
            <CheckCircle className="w-16 h-16 mx-auto mb-4 text-gray-500" />
            <p className="text-gray-400 text-lg mb-2">완료된 세금이 없습니다</p>
            <p className="text-gray-500 text-sm">납부 완료된 세금 정보가 여기에 표시됩니다</p>
          </div>
        ) : (
          <div className="h-full flex flex-col">
            <div className="flex items-center space-x-3 mb-6 flex-shrink-0">
              <CheckCircle className="w-6 h-6 text-emerald-400" />
              <span className="bg-emerald-500/20 text-emerald-300 px-3 py-1 rounded-full text-sm font-medium">{getBillsByStatus('completed').length}개 완료</span>
            </div>
            
            {/* 스크롤 가능한 목록 영역 */}
            <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-2 min-h-0">
              {getBillsByStatus('completed').map(bill => (
                <BillCard key={bill.id} bill={bill} onStatusChange={!isViewerOnly ? updateBillStatus : null} onClick={!isViewerOnly ? handleBillClick : null} />
              ))}
            </div>
            
            {/* 고정된 하단 버튼 */}
            <div className="flex justify-center pt-6 mt-4 border-t border-slate-600/50 flex-shrink-0">
              <button onClick={() => setShowCompletedModal(false)} className="px-6 py-2 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-colors font-medium">닫기</button>
            </div>
          </div>
        )}
      </Modal>
      
      <Modal isOpen={showTrashModal} onClose={() => setShowTrashModal(false)} title="휴지통" size="lg" heightMode="fixed">
        {trash.length === 0 ? (
          <div className="text-center py-12">
            <Trash2 className="w-16 h-16 mx-auto mb-4 text-gray-500" />
            <p className="text-gray-400 text-lg mb-2">휴지통이 비어있습니다</p>
            <p className="text-gray-500 text-sm">삭제된 세금 정보가 여기에 표시됩니다</p>
          </div>
        ) : (
          <>
            <div className="flex items-center space-x-3 mb-6">
              <Trash2 className="w-6 h-6 text-red-400" />
              <span className="bg-red-500/20 text-red-300 px-3 py-1 rounded-full text-sm font-medium">{trash.length}개 항목</span>
            </div>
            
            <div className="bg-amber-900/20 border border-amber-500/30 rounded-xl p-4 mb-6">
              <p className="text-amber-200 text-sm flex items-center">
                <AlertCircle className="w-4 h-4 mr-2" />삭제된 항목은 3일 후 자동으로 영구 삭제됩니다
              </p>
            </div>
            
            <div className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar mb-6">
              {trash.map(item => {
                const deletedDate = new Date(item.deletedAt);
                const now = new Date();
                const daysPassed = Math.floor((now - deletedDate) / (1000 * 60 * 60 * 24));
                const daysLeft = 3 - daysPassed;
                
                return (
                  <div key={item.id} className="bg-slate-700/30 rounded-xl p-4 border border-slate-600/30">
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <h3 className="font-medium text-gray-100 mb-1">{item.name}</h3>
                        <div className="text-sm text-gray-300 mb-1">{item.stationName}</div>
                        <div className="text-xs text-gray-400">{item.address}</div>
                      </div>
                      <CategoryBadge category={item.category} />
                    </div>
                    
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="text-sm font-mono text-gray-300">₩ {utils.formatAmount(item.amount)}</div>
                        <div className="text-xs text-gray-500">{deletedDate.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' })} 삭제 • {daysLeft}일 후 영구삭제</div>
                      </div>
                      <div className="flex space-x-2">
                        <button onClick={() => {
                          const restored = restoreFromTrash(item);
                          addBill(restored);
                        }} className="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors text-sm font-medium">복원</button>
                        <button onClick={() => permanentDelete(item.id)} className="px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-500 transition-colors text-sm font-medium">영구삭제</button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
            
            <div className="flex justify-between items-center pt-4 border-t border-slate-600/50">
              <button onClick={() => setShowTrashModal(false)} className="px-6 py-2 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-colors font-medium">닫기</button>
              <button onClick={emptyTrash} className="px-6 py-2 bg-red-600 text-white rounded-xl hover:bg-red-500 transition-colors font-medium">휴지통 비우기</button>
            </div>
          </>
        )}
      </Modal>

      <Modal isOpen={showStationDetailModal} onClose={() => setShowStationDetailModal(false)} title="충전소 상세 정보" heightMode="auto">
        {selectedStationDetail && (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className={CARD_STYLES + " p-4"}>
                <h3 className="text-lg font-semibold text-gray-100 mb-4">기본 정보</h3>
                <div className="space-y-3">
                  <div>
                    <label className="text-sm font-medium text-gray-400">충전소명</label>
                    <div className="text-gray-100 font-medium">{selectedStationDetail.name}</div>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-400">주소</label>
                    <div className="text-gray-100 text-sm">{selectedStationDetail.address}</div>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-400">운영 상태</label>
                    <div>
                      <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${selectedStationDetail.status === 'operating' ? 'bg-emerald-500/20 text-emerald-300 border-emerald-500/30' : selectedStationDetail.status === 'preparing' ? 'bg-amber-500/20 text-amber-300 border-amber-500/30' : 'bg-gray-500/20 text-gray-300 border-gray-500/30'}`}>
                        <div className={`w-2 h-2 rounded-full mr-2 ${selectedStationDetail.status === 'operating' ? 'bg-emerald-500 animate-pulse' : selectedStationDetail.status === 'preparing' ? 'bg-amber-500' : 'bg-gray-500'}`}></div>
                        {selectedStationDetail.status === 'operating' ? '운영 중' : selectedStationDetail.status === 'preparing' ? '오픈 예정' : '운영 종료'}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div className={CARD_STYLES + " p-4"}>
                <h3 className="text-lg font-semibold text-gray-100 mb-4">세금 현황</h3>
                <div className="space-y-4">
                  {(() => {
                    const stationBills = bills.filter(bill => bill.stationName === selectedStationDetail.name);
                    const pendingByCategory = {
                      '취득세': stationBills.filter(bill => bill.category === '취득세' && (bill.status === 'pending' || bill.status === 'accounting_review')).length,
                      '재산세': stationBills.filter(bill => bill.category === '재산세' && (bill.status === 'pending' || bill.status === 'accounting_review')).length,
                      '기타세': stationBills.filter(bill => bill.category === '기타세' && (bill.status === 'pending' || bill.status === 'accounting_review')).length
                    };
                    const completedByCategory = {
                      '취득세': stationBills.filter(bill => bill.category === '취득세' && bill.status === 'completed').length,
                      '재산세': stationBills.filter(bill => bill.category === '재산세' && bill.status === 'completed').length,
                      '기타세': stationBills.filter(bill => bill.category === '기타세' && bill.status === 'completed').length
                    };
                    
                    return (
                      <>
                        <div>
                          <h4 className="text-sm font-medium text-amber-300 mb-2">납부 예정</h4>
                          <div className="space-y-2 bg-amber-900/10 rounded-lg p-3 border border-amber-500/20">
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-gray-300">취득세</span>
                              <span className="bg-orange-500/20 text-orange-300 px-2 py-1 rounded text-xs font-medium">{pendingByCategory['취득세']}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-gray-300">재산세</span>
                              <span className="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs font-medium">{pendingByCategory['재산세']}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-gray-300">기타세</span>
                              <span className="bg-gray-500/20 text-gray-300 px-2 py-1 rounded text-xs font-medium">{pendingByCategory['기타세']}</span>
                            </div>
                          </div>
                        </div>

                        <div>
                          <h4 className="text-sm font-medium text-emerald-300 mb-2">납부 완료</h4>
                          <div className="space-y-2 bg-emerald-900/10 rounded-lg p-3 border border-emerald-500/20">
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-gray-300">취득세</span>
                              <span className="bg-orange-500/20 text-orange-300 px-2 py-1 rounded text-xs font-medium">{completedByCategory['취득세']}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-gray-300">재산세</span>
                              <span className="bg-blue-500/20 text-blue-300 px-2 py-1 rounded text-xs font-medium">{completedByCategory['재산세']}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-gray-300">기타세</span>
                              <span className="bg-gray-500/20 text-gray-300 px-2 py-1 rounded text-xs font-medium">{completedByCategory['기타세']}</span>
                            </div>
                          </div>
                        </div>

                        <div className="pt-3 border-t border-slate-600/30">
                          <div className="flex justify-between items-center">
                            <span className="text-sm font-medium text-gray-300">총 납부 금액</span>
                            <span className="text-xl font-bold text-emerald-300 font-mono">₩ {utils.formatKoreanCurrency(stationBills.filter(bill => bill.status === 'completed').reduce((sum, bill) => sum + utils.getAmount(bill.amount), 0))}</span>
                          </div>
                        </div>
                      </>
                    );
                  })()}
                </div>
              </div>
            </div>

            <div className="flex space-x-3 pt-4 border-t border-slate-600/50">
              <button 
                onClick={() => setShowStationDetailModal(false)} 
                className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium"
              >
                닫기
              </button>
              <button 
                onClick={() => {
                  setShowStationDetailModal(false);
                  if (!isViewerOnly) {
                    handleStationClick(selectedStationDetail);
                  }
                }} 
                disabled={isViewerOnly}
                className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
                  isViewerOnly 
                    ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50' 
                    : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
                }`}
              >
                정보 수정
              </button>
              <button 
                onClick={() => {
                  setShowStationDetailModal(false);
                  setCurrentView('kanban'); 
                  setGlobalFilters(prev => ({...prev, stationSearch: selectedStationDetail.name}));
                }} 
                className="flex-1 px-4 py-3 bg-gradient-to-r from-emerald-600 to-emerald-500 text-white rounded-xl hover:from-emerald-500 hover:to-emerald-400 transition-all duration-200 font-medium shadow-lg"
              >
                세금 보기
              </button>
            </div>
          </div>
        )}
      </Modal>

      {/* 리마인더 사이드 패널 */}
      {showReminderPanel && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex z-50">
          {/* 배경 클릭 시 닫기 */}
          <div 
            className="flex-1" 
            onClick={() => setShowReminderPanel(false)}
          ></div>
          
          {/* 사이드 패널 */}
          <div className="w-96 bg-gradient-to-b from-slate-800 to-slate-900 shadow-2xl border-l border-slate-700/50 flex flex-col animate-slide-in-right">
            {/* 헤더 */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/50">
              <div className="flex items-center space-x-3">
                <Bell className="w-5 h-5 text-blue-400" />
                <h2 className="text-lg font-semibold text-gray-100">리마인더</h2>
                {unreadNotificationCount > 0 && (
                  <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                )}
              </div>
              <button 
                onClick={() => setShowReminderPanel(false)}
                className="p-2 hover:bg-slate-700/50 rounded-lg transition-colors text-gray-400 hover:text-gray-200"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
            
            {/* 내용 */}
            <div className="flex-1 p-6 overflow-y-auto custom-scrollbar">
              {/* 알림 개수 및 모두 읽음 버튼 */}
              <div className="flex items-center justify-between mb-4">
                <div className="text-sm text-gray-300">
                  <span className="font-medium text-blue-300">{unreadNotificationCount}개</span> 새로운 알림
                </div>
                <button 
                  onClick={unreadNotificationCount > 0 ? handleMarkAllAsRead : undefined}
                  className={`text-xs px-3 py-1 rounded-lg transition-colors ${
                    unreadNotificationCount === 0 
                      ? 'text-gray-500 opacity-50 cursor-not-allowed' 
                      : 'text-gray-400 hover:text-gray-200 hover:bg-slate-700/30'
                  }`}
                >
                  모두 읽음
                </button>
              </div>
              
              <div className="space-y-4">
                {notificationSystem.notifications.length > 0 ? (
                  notificationSystem.notifications.map(notification => (
                    <button 
                      key={notification.id}
                      onClick={() => handleReminderClick(notification.type, notification.stationName, notification.id)}
                      className={`w-full rounded-xl p-4 transition-all duration-200 text-left border ${
                        notification.isRead 
                          ? 'bg-slate-800/30 border-slate-700/30 text-gray-400' 
                          : 'bg-slate-700/50 border-slate-600/50 text-gray-200 hover:bg-slate-600/50'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-1">
                            <div className="text-sm font-medium">{notification.title}</div>
                            {notification.priority === 'high' && !notification.isRead && (
                              <span className="px-2 py-0.5 bg-red-500/20 text-red-300 text-xs rounded-full border border-red-500/30">
                                긴급
                              </span>
                            )}
                          </div>
                          
                          {/* 알림 타입별 추가 정보 */}
                          {(notification.type === 'prepare_notice' || notification.type === 'ready_notice' || notification.type === 'final_notice') && (
                            <div className={`text-xs mb-1 ${
                              notification.type === 'final_notice' ? 'text-red-300' :
                              notification.type === 'ready_notice' ? 'text-amber-300' : 'text-blue-300'
                            }`}>
                              {notification.data.bill.status === 'accounting_review' && (
                                <span className="inline-flex items-center px-2 py-0.5 bg-amber-500/20 text-amber-300 text-xs rounded-full border border-amber-500/30 mr-2">
                                  회계사 검토
                                </span>
                              )}
                              납부 기한: {notification.data.bill.dueDate} • 금액: ₩{utils.formatAmount(notification.data.bill.amount)}
                              {notification.data.bill.amount === '미정' && (
                                <span className="text-amber-300 ml-1">(금액 확인 필요)</span>
                              )}
                            </div>
                          )}
                          {(notification.type === 'missing_approval' || notification.type === 'missing_safety') && (
                            <div className="text-xs text-gray-400 mb-1">
                              등록일: {notification.data.station.registeredDate} • {notification.data.daysSinceRegistered}일째 미입력
                            </div>
                          )}
                          
                          <div className="text-xs text-gray-500">
                            {new Date(notification.createdAt).toLocaleDateString('ko-KR')}
                          </div>
                        </div>
                        
                        {/* 우선순위 표시 */}
                        {!notification.isRead && (
                          <div className={`w-3 h-3 rounded-full flex-shrink-0 ${
                            notification.priority === 'high' ? 'bg-red-500 animate-pulse' :
                            notification.priority === 'medium' ? 'bg-amber-500' :
                            'bg-blue-500'
                          }`}></div>
                        )}
                      </div>
                    </button>
                  ))
                ) : (
                  <div className="text-center py-8">
                    <CheckCircle className="w-12 h-12 mx-auto mb-3 text-gray-500" />
                    <p className="text-gray-400 text-sm">새로운 알림이 없습니다</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* 세금 CSV 일괄등록 모달 */}
      <Modal isOpen={showTaxBulkUploadModal} onClose={() => setShowTaxBulkUploadModal(false)} title="세금 CSV 일괄 등록" size="lg" heightMode="fixed">
        {isProcessingTaxBulk ? (
          <div className="text-center py-12">
            <div className="animate-spin rounded-full h-12 w-12 border-2 border-purple-500 border-t-transparent mx-auto mb-4"></div>
            <h2 className="text-lg font-medium text-gray-100 mb-2">등록 중</h2>
            <p className="text-gray-400">세금 정보를 등록하고 있습니다...</p>
          </div>
        ) : (
          <div>
            {/* CSV 형식 안내 */}
            <div className="mb-6 p-4 bg-gradient-to-r from-purple-900/30 to-purple-800/20 rounded-xl border border-purple-500/30">
              <p className="text-sm text-purple-200 font-medium mb-2">📋 CSV 파일 형식</p>
              <div className="text-xs text-gray-400 space-y-1">
                <div>• 컬럼 순서: 세금제목, 충전소명, 세금분류, 납부기한, 납부금액(선택), 상태(선택), 반복납부(선택)</div>
                <div>• 세금분류: 취득세, 재산세, 기타세</div>
                <div>• 납부기한: YYYY-MM-DD 형식 (예: 2024-12-31)</div>
                <div>• 납부금액: 숫자만 입력하거나 비워두면 '미정'</div>
                <div>• 상태: 회계사 검토, 납부 예정, 납부 완료 (비워두면 기본값 적용)</div>
                <div>• 반복납부: Y/N, 예/아니오, true/false (재산세/기타세만 가능, 취득세는 무시됨)</div>
                <div>• 충전소명은 기존 등록된 충전소와 정확히 일치해야 합니다</div>
              </div>
            </div>

            <div className="mb-6 p-4 bg-gradient-to-r from-blue-900/30 to-blue-800/20 rounded-xl border border-blue-500/30">
              <p className="text-sm text-blue-200 font-medium">CSV 파일 분석 완료</p>
              <div className="flex items-center space-x-4 mt-2 text-xs">
                <span className="text-blue-300">전체: {taxBulkUploadPreview.length}개</span>
                <span className="text-emerald-300">등록 가능: {taxBulkUploadPreview.filter(item => item.isValid).length}개</span>
                {taxBulkUploadPreview.filter(item => !item.isValid).length > 0 && (
                  <span className="text-red-300">오류: {taxBulkUploadPreview.filter(item => !item.isValid).length}개</span>
                )}
              </div>
            </div>
            
            <div className="space-y-3 max-h-64 overflow-y-auto custom-scrollbar mb-6">
              {taxBulkUploadPreview.map((tax, index) => (
                <div key={index} className={`p-4 rounded-xl border ${tax.isValid ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-red-900/20 border-red-500/30'}`}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="font-medium text-gray-100">{tax.name}</div>
                    <span className={`text-xs px-2 py-1 rounded-lg font-medium ${tax.isValid ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}`}>
                      {tax.isValid ? '유효' : '오류'}
                    </span>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <div className="text-gray-400 text-xs">충전소</div>
                      <div className="text-gray-200">{tax.stationName}</div>
                    </div>
                    <div>
                      <div className="text-gray-400 text-xs">분류</div>
                      <div className="text-gray-200">{tax.category}</div>
                    </div>
                    <div>
                      <div className="text-gray-400 text-xs">납부기한</div>
                      <div className="text-gray-200 font-mono">{tax.dueDate}</div>
                    </div>
                    <div>
                      <div className="text-gray-400 text-xs">금액</div>
                      <div className="text-gray-200 font-mono">₩{utils.formatAmount(tax.amount)}</div>
                    </div>
                  </div>
                  
                  {/* 상태와 반복 납부 정보 추가 */}
                  <div className="grid grid-cols-2 gap-4 text-sm mt-3 pt-3 border-t border-slate-600/30">
                    <div>
                      <div className="text-gray-400 text-xs">상태</div>
                      <div className={`text-sm font-medium ${
                        tax.status === 'completed' ? 'text-emerald-300' :
                        tax.status === 'accounting_review' ? 'text-amber-300' : 'text-blue-300'
                      }`}>
                        {tax.status === 'completed' ? '납부 완료' :
                         tax.status === 'accounting_review' ? '회계사 검토' : '납부 예정'}
                      </div>
                    </div>
                    <div>
                      <div className="text-gray-400 text-xs">반복 납부</div>
                      <div className={`text-sm font-medium ${tax.isRecurring ? 'text-blue-300' : 'text-gray-400'}`}>
                        {tax.category === '취득세' ? '일회성 (고정)' :
                         tax.isRecurring ? '매년 반복' : '일회성'}
                        {tax.isRecurring && tax.category !== '취득세' && (
                          <span className="text-xs text-blue-400 ml-1">(6년치 생성)</span>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {!tax.isValid && tax.validationErrors && (
                    <div className="mt-3 space-y-1">
                      {tax.validationErrors.map((error, errorIndex) => (
                        <div key={errorIndex} className="text-xs text-red-300 flex items-center">
                          <AlertCircle className="w-3 h-3 mr-1 flex-shrink-0" />
                          {error}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
            
            <div className="flex space-x-3">
              <button onClick={() => { setTaxBulkUploadPreview([]); setShowTaxBulkUploadModal(false); }} className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium">취소</button>
              <button 
                onClick={handleTaxBulkUploadConfirm} 
                disabled={taxBulkUploadPreview.filter(item => item.isValid).length === 0} 
                className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
                  taxBulkUploadPreview.filter(item => item.isValid).length === 0
                    ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
                    : 'bg-gradient-to-r from-purple-600 to-purple-500 text-white hover:from-purple-500 hover:to-purple-400'
                }`}
              >
                {(() => {
                  const validCount = taxBulkUploadPreview.filter(item => item.isValid).length;
                  const totalCount = taxBulkUploadPreview.length;
                  
                  if (validCount === 0) {
                    return '등록할 항목이 없습니다';
                  } else if (validCount === totalCount) {
                    return `${validCount}개 세금 등록`;
                  } else {
                    return `${validCount}개 세금 등록 (${totalCount - validCount}개 제외)`;
                  }
                })()}
              </button>
            </div>
          </div>
        )}
      </Modal>

      <Modal isOpen={showBulkUploadModal} onClose={() => setShowBulkUploadModal(false)} title="CSV 일괄 등록" size="lg" heightMode="fixed">
        {isProcessingBulk ? (
          <div className="text-center py-12">
            <div className="animate-spin rounded-full h-12 w-12 border-2 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <h2 className="text-lg font-medium text-gray-100 mb-2">등록 중</h2>
            <p className="text-gray-400">충전소 정보를 등록하고 있습니다...</p>
          </div>
        ) : (
          <div>
            <div className="mb-6 p-4 bg-gradient-to-r from-blue-900/30 to-blue-800/20 rounded-xl border border-blue-500/30">
              <p className="text-sm text-blue-200 font-medium">CSV 파일 분석 완료</p>
              <div className="flex items-center space-x-4 mt-2 text-xs">
                <span className="text-blue-300">전체: {bulkUploadPreview.length}개</span>
                <span className="text-emerald-300">등록 가능: {bulkUploadPreview.filter(item => item.isValid).length}개</span>
                {bulkUploadPreview.filter(item => !item.isValid).length > 0 && (
                  <span className="text-red-300">오류: {bulkUploadPreview.filter(item => !item.isValid).length}개</span>
                )}
              </div>
            </div>
            
            <div className="space-y-3 max-h-64 overflow-y-auto custom-scrollbar mb-6">
              {bulkUploadPreview.map((station, index) => (
                <div key={index} className={`p-3 rounded-xl border ${station.isValid ? 'bg-emerald-900/20 border-emerald-500/30' : 'bg-red-900/20 border-red-500/30'}`}>
                  <div className="flex items-center justify-between mb-2">
                    <div className="font-medium text-gray-100">{station.name}</div>
                    <span className={`text-xs px-2 py-1 rounded-lg font-medium ${station.isValid ? 'bg-emerald-500/20 text-emerald-300' : 'bg-red-500/20 text-red-300'}`}>
                      {station.isValid ? '유효' : '오류'}
                    </span>
                  </div>
                  <div className="text-sm text-gray-300">{station.address}</div>
                  <div className="text-xs text-gray-400 mt-1">
                    상태: {
                      station.status === 'operating' ? '운영 중' : 
                      station.status === 'preparing' ? '오픈 예정' : 
                      station.status === 'closed' ? '운영 종료' : 
                      `${station.status} (원본: ${station.originalStatus || ''})`
                    }
                  </div>
                  {!station.isValid && station.validationErrors && (
                    <div className="mt-2 space-y-1">
                      {station.validationErrors.map((error, errorIndex) => (
                        <div key={errorIndex} className="text-xs text-red-300 flex items-center">
                          <AlertCircle className="w-3 h-3 mr-1 flex-shrink-0" />
                          {error}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
            
            <div className="flex space-x-3">
              <button onClick={() => { setBulkUploadPreview([]); setShowBulkUploadModal(false); }} className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium">취소</button>
              <button 
                onClick={handleBulkUploadConfirm} 
                disabled={bulkUploadPreview.filter(item => item.isValid).length === 0} 
                className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
                  bulkUploadPreview.filter(item => item.isValid).length === 0
                    ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
                    : 'bg-gradient-to-r from-emerald-600 to-emerald-500 text-white hover:from-emerald-500 hover:to-emerald-400'
                }`}
              >
                {(() => {
                  const validCount = bulkUploadPreview.filter(item => item.isValid).length;
                  const totalCount = bulkUploadPreview.length;
                  
                  if (validCount === 0) {
                    return '등록할 항목이 없습니다';
                  } else if (validCount === totalCount) {
                    return `${validCount}개 충전소 등록`;
                  } else {
                    return `${validCount}개 충전소 등록 (${totalCount - validCount}개 제외)`;
                  }
                })()}
              </button>
            </div>
          </div>
        )}
      </Modal>

      {/* 알림 담당자 상세 관리 모달 */}
      <Modal 
        isOpen={showNotificationDetailModal} 
        onClose={() => { 
          setShowNotificationDetailModal(false); 
          setSelectedNotificationType(null);
        }} 
        title={`${
          selectedNotificationType === 'tax' ? '세금 알림' :
          selectedNotificationType === 'station' ? '충전소 일정 알림' : ''
        } 담당자 관리`} 
        size="lg" 
        heightMode="fixed"
      >
        {selectedNotificationType && (
          <div className="space-y-6">
            {/* 알림 정보 */}
            <div className={`p-4 rounded-xl border ${
              selectedNotificationType === 'tax' ? 'bg-orange-900/20 border-orange-500/30' :
              'bg-blue-900/20 border-blue-500/30'
            }`}>
              <div className="flex items-center space-x-3 mb-2">
                {selectedNotificationType === 'tax' && <AlertCircle className="w-5 h-5 text-orange-400" />}
                {selectedNotificationType === 'station' && <Zap className="w-5 h-5 text-blue-400" />}
                <h4 className={`font-medium ${
                  selectedNotificationType === 'tax' ? 'text-orange-200' :
                  'text-blue-200'
                }`}>
                  {selectedNotificationType === 'tax' ? '세금 알림' :
                   '충전소 일정 알림'}
                </h4>
              </div>
              <p className={`text-sm ${
                selectedNotificationType === 'tax' ? 'text-orange-300' :
                'text-blue-300'
              }`}>
                {selectedNotificationType === 'tax' ? '납부 기한 임박 알림을 받을 담당자를 관리합니다' :
                 '사용 승인일, 안전 점검일 미입력 알림을 받을 담당자를 관리합니다'}
              </p>
            </div>

            {/* 현재 담당자 목록 */}
            <div>
              <h5 className="text-lg font-medium text-gray-200 mb-4">
                현재 담당자 ({
                  selectedNotificationType === 'tax' ? notificationAssignments.tax_alerts.length :
                  selectedNotificationType === 'pricing' ? notificationAssignments.pricing_alerts.length :
                  notificationAssignments.station_alerts.length
                }명)
              </h5>
              
              <div className="space-y-3 max-h-64 overflow-y-auto custom-scrollbar">
                {(() => {
                  const currentAssignees = selectedNotificationType === 'tax' ? notificationAssignments.tax_alerts :
                                         notificationAssignments.station_alerts;
                  
                  if (currentAssignees.length === 0) {
                    return (
                      <div className="text-center py-8 text-gray-400">
                        <User className="w-12 h-12 mx-auto mb-3 opacity-50" />
                        <p>지정된 담당자가 없습니다</p>
                        <p className="text-sm mt-1">아래에서 담당자를 추가해주세요</p>
                      </div>
                    );
                  }
                  
                  return currentAssignees.map(accountId => {
                    const account = accounts.find(acc => acc.id === accountId);
                    if (!account) return null;
                    
                    return (
                      <div key={accountId} className="flex items-center justify-between p-3 bg-slate-700/30 rounded-lg border border-slate-600/30">
                        <div className="flex items-center space-x-3">
                          <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-500 rounded-lg flex items-center justify-center">
                            <User className="w-5 h-5 text-white" />
                          </div>
                          <div>
                            <div className="font-medium text-gray-200">{account.name}</div>
                            <div className="text-sm text-gray-400 font-mono">{account.email}</div>
                          </div>
                        </div>
                        <div className="flex items-center space-x-3">
                          <span className={`text-xs px-2 py-1 rounded ${
                            account.role === 'super_admin' ? 'bg-purple-500/20 text-purple-300' :
                            account.role === 'admin' ? 'bg-red-500/20 text-red-300' :
                            account.role === 'editor' ? 'bg-blue-500/20 text-blue-300' :
                            'bg-gray-500/20 text-gray-300'
                          }`}>
                            {account.role === 'super_admin' ? '슈퍼 관리자' :
                             account.role === 'admin' ? '관리자' :
                             account.role === 'editor' ? '편집자' : '뷰어'}
                          </span>
                          <button
                            onClick={() => {
                              const alertType = selectedNotificationType === 'tax' ? 'tax_alerts' : 'station_alerts';
                              setNotificationAssignments(prev => ({
                                ...prev,
                                [alertType]: prev[alertType].filter(id => id !== accountId)
                              }));
                            }}
                            className="p-1 text-red-400 hover:text-red-300 hover:bg-red-900/20 rounded transition-colors"
                            title="담당자에서 제거"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    );
                  }).filter(Boolean);
                })()}
              </div>
            </div>

            {/* 담당자 추가 */}
            <div>
              <h5 className="text-lg font-medium text-gray-200 mb-4">담당자 추가</h5>
              
              <div className="space-y-3 max-h-48 overflow-y-auto custom-scrollbar">
                {accounts.filter(acc => {
                  const currentAssignees = selectedNotificationType === 'tax' ? notificationAssignments.tax_alerts :
                                         notificationAssignments.station_alerts;
                  return acc.status === 'active' && !currentAssignees.includes(acc.id);
                }).map(account => (
                  <div key={account.id} className="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg border border-slate-600/30 hover:bg-slate-700/30 transition-colors">
                    <div className="flex items-center space-x-3">
                      <div className="w-10 h-10 bg-gradient-to-br from-gray-600 to-gray-500 rounded-lg flex items-center justify-center">
                        <User className="w-5 h-5 text-white" />
                      </div>
                      <div>
                        <div className="font-medium text-gray-200">{account.name}</div>
                        <div className="text-sm text-gray-400 font-mono">{account.email}</div>
                      </div>
                    </div>
                    <div className="flex items-center space-x-3">
                      <span className={`text-xs px-2 py-1 rounded ${
                        account.role === 'super_admin' ? 'bg-purple-500/20 text-purple-300' :
                        account.role === 'admin' ? 'bg-red-500/20 text-red-300' :
                        account.role === 'editor' ? 'bg-blue-500/20 text-blue-300' :
                        'bg-gray-500/20 text-gray-300'
                      }`}>
                        {account.role === 'super_admin' ? '슈퍼 관리자' :
                         account.role === 'admin' ? '관리자' :
                         account.role === 'editor' ? '편집자' : '뷰어'}
                      </span>
                      <button
                        onClick={() => {
                          const alertType = selectedNotificationType === 'tax' ? 'tax_alerts' : 'station_alerts';
                          setNotificationAssignments(prev => ({
                            ...prev,
                            [alertType]: [...prev[alertType], account.id]
                          }));
                        }}
                        className="px-3 py-1 bg-blue-600/20 text-blue-300 rounded-lg hover:bg-blue-600/30 transition-colors text-sm font-medium border border-blue-500/30"
                      >
                        추가
                      </button>
                    </div>
                  </div>
                ))}
                
                {accounts.filter(acc => {
                  const currentAssignees = selectedNotificationType === 'tax' ? notificationAssignments.tax_alerts :
                                         notificationAssignments.station_alerts;
                  return acc.status === 'active' && !currentAssignees.includes(acc.id);
                }).length === 0 && (
                  <div className="text-center py-6 text-gray-400">
                    <CheckCircle className="w-8 h-8 mx-auto mb-2 opacity-50" />
                    <p className="text-sm">모든 활성 계정이 담당자로 지정되었습니다</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </Modal>

      {/* 계정 수정 모달 */}
      <Modal 
        isOpen={showEditAccountModal} 
        onClose={() => { 
          setShowEditAccountModal(false); 
          setEditingAccount(null);
          setEditAccountForm({ name: '', role: '', newPassword: '', confirmPassword: '' });
        }} 
        title="계정 정보 수정" 
        size="md"
        heightMode="auto"
      >
        {isUpdatingAccount ? (
          <div className="text-center py-12">
            <div className="animate-spin rounded-full h-12 w-12 border-2 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <h2 className="text-lg font-medium text-gray-100 mb-2">계정 수정 중</h2>
            <p className="text-gray-400">계정 정보를 업데이트하고 있습니다...</p>
          </div>
        ) : editingAccount && (
          <div className="space-y-6">
            <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
              <p className="text-blue-200 text-sm">
                계정 정보를 수정합니다. 빈 패스워드 필드는 기존 패스워드를 유지합니다.
              </p>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">이름 *</label>
                <input 
                  type="text" 
                  value={editAccountForm.name}
                  onChange={(e) => setEditAccountForm({...editAccountForm, name: e.target.value})}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="사용자 이름을 입력하세요"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">이메일</label>
                <input 
                  type="email" 
                  value={editingAccount.email}
                  disabled
                  className="w-full px-4 py-3 bg-gray-600/30 border border-gray-500/30 rounded-xl text-gray-400 cursor-not-allowed backdrop-blur-sm" 
                />
                <p className="text-xs text-gray-500 mt-1">이메일은 변경할 수 없습니다</p>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">역할</label>
                <select 
                  value={editAccountForm.role}
                  onChange={(e) => setEditAccountForm({...editAccountForm, role: e.target.value})}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm"
                >
                  <option value="viewer">뷰어 - 조회만 가능</option>
                  <option value="editor">편집자 - 세금/충전소 편집 가능</option>
                  <option value="admin">관리자 - 모든 권한</option>
                </select>
              </div>
              
              <div className="border-t border-slate-600/30 pt-4">
                <h4 className="text-sm font-medium text-gray-300 mb-3">패스워드 변경 (선택사항)</h4>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-300 mb-2">새 패스워드</label>
                    <input 
                      type="password" 
                      value={editAccountForm.newPassword}
                      onChange={(e) => setEditAccountForm({...editAccountForm, newPassword: e.target.value})}
                      className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                      placeholder="새 패스워드 (비워두면 기존 패스워드 유지)"
                    />
                  </div>
                  
                  {editAccountForm.newPassword && (
                    <div>
                      <label className="block text-sm font-medium text-gray-300 mb-2">새 패스워드 확인</label>
                      <input 
                        type="password" 
                        value={editAccountForm.confirmPassword}
                        onChange={(e) => setEditAccountForm({...editAccountForm, confirmPassword: e.target.value})}
                        className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                        placeholder="새 패스워드를 다시 입력하세요"
                      />
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            <div className="flex space-x-3 pt-4 border-t border-slate-600/50">
              <button 
                onClick={() => { 
                  setShowEditAccountModal(false); 
                  setEditingAccount(null);
                  setEditAccountForm({ name: '', role: '', newPassword: '', confirmPassword: '' });
                }}
                className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium"
              >
                취소
              </button>
              <button 
                onClick={handleUpdateAccount}
                disabled={!editAccountForm.name || (editAccountForm.newPassword && (editAccountForm.newPassword.length < 6 || editAccountForm.newPassword !== editAccountForm.confirmPassword))}
                className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
                  !editAccountForm.name || (editAccountForm.newPassword && (editAccountForm.newPassword.length < 6 || editAccountForm.newPassword !== editAccountForm.confirmPassword))
                    ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
                    : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
                }`}
              >
                수정 완료
              </button>
            </div>
          </div>
        )}
      </Modal>

      {/* 계정 삭제 확인 모달 */}
      <Modal 
        isOpen={showDeleteAccountModal} 
        onClose={() => { 
          setShowDeleteAccountModal(false); 
          setAccountToDelete(null); 
        }} 
        title="계정 삭제 확인" 
        size="sm"
        heightMode="auto"
      >
        {isDeletingAccount ? (
          <div className="text-center py-8">
            <div className="animate-spin rounded-full h-10 w-10 border-2 border-red-500 border-t-transparent mx-auto mb-4"></div>
            <p className="text-gray-300">계정을 삭제하고 있습니다...</p>
          </div>
        ) : accountToDelete && (
          <div className="space-y-4">
            <div className="bg-red-900/20 border border-red-500/30 rounded-xl p-4">
              <div className="flex items-center">
                <AlertCircle className="w-5 h-5 text-red-300 mr-3 flex-shrink-0" />
                <div>
                  <p className="text-red-200 font-medium">정말로 삭제하시겠습니까?</p>
                  <p className="text-red-300 text-sm mt-1">이 작업은 되돌릴 수 없습니다.</p>
                </div>
              </div>
            </div>
            
            <div className="bg-slate-700/30 rounded-xl p-4 border border-slate-600/30">
              <div className="text-sm text-gray-300">
                <div className="font-medium text-gray-100 mb-2">삭제할 계정 정보:</div>
                <div className="space-y-1">
                  <div>이름: <span className="font-medium">{accountToDelete.name}</span></div>
                  <div>이메일: <span className="font-mono">{accountToDelete.email}</span></div>
                  <div>역할: <span className="font-medium">
                    {accountToDelete.role === 'super_admin' ? '슈퍼 관리자' :
                     accountToDelete.role === 'admin' ? '관리자' : 
                     accountToDelete.role === 'editor' ? '편집자' : '뷰어'}
                  </span></div>
                </div>
              </div>
            </div>
            
            <div className="flex space-x-3 pt-2">
              <button 
                onClick={() => { 
                  setShowDeleteAccountModal(false); 
                  setAccountToDelete(null); 
                }}
                className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium"
              >
                취소
              </button>
              <button 
                onClick={handleDeleteAccount}
                className="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-xl hover:from-red-500 hover:to-red-400 transition-all duration-200 font-medium shadow-lg"
              >
                삭제
              </button>
            </div>
          </div>
        )}
      </Modal>

      {/* 계정 생성 모달 */}
      <Modal isOpen={showCreateAccountModal} onClose={() => { setShowCreateAccountModal(false); setNewAccount({ email: '', password: '', confirmPassword: '', name: '', role: 'viewer' }); }} title="새 계정 생성" size="md" heightMode="auto">
        {isCreatingAccount ? (
          <div className="text-center py-12">
            <div className="animate-spin rounded-full h-12 w-12 border-2 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <h2 className="text-lg font-medium text-gray-100 mb-2">계정 생성 중</h2>
            <p className="text-gray-400">새로운 계정을 생성하고 있습니다...</p>
          </div>
        ) : (
          <div className="space-y-6">
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">이름 *</label>
                <input 
                  type="text" 
                  value={newAccount.name}
                  onChange={(e) => setNewAccount({...newAccount, name: e.target.value})}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="사용자 이름을 입력하세요"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">이메일 *</label>
                <input 
                  type="email" 
                  value={newAccount.email}
                  onChange={(e) => setNewAccount({...newAccount, email: e.target.value})}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="이메일 주소를 입력하세요"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">역할</label>
                <select 
                  value={newAccount.role}
                  onChange={(e) => setNewAccount({...newAccount, role: e.target.value})}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm"
                >
                  <option value="viewer">뷰어 - 조회만 가능</option>
                  <option value="editor">편집자 - 세금/충전소 편집 가능</option>
                  <option value="admin">관리자 - 모든 권한</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">패스워드 *</label>
                <input 
                  type="password" 
                  value={newAccount.password}
                  onChange={(e) => setNewAccount({...newAccount, password: e.target.value})}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="패스워드를 입력하세요 (최소 6자)"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">패스워드 확인 *</label>
                <input 
                  type="password" 
                  value={newAccount.confirmPassword}
                  onChange={(e) => setNewAccount({...newAccount, confirmPassword: e.target.value})}
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="패스워드를 다시 입력하세요"
                />
              </div>
            </div>
            
            <div className="flex space-x-3 pt-4 border-t border-slate-600/50">
              <button 
                onClick={() => { setShowCreateAccountModal(false); setNewAccount({ email: '', password: '', confirmPassword: '', name: '', role: 'viewer' }); }}
                className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium"
              >
                취소
              </button>
              <button 
                onClick={handleCreateAccount}
                disabled={!newAccount.email || !newAccount.password || !newAccount.confirmPassword || !newAccount.name || newAccount.password.length < 6 || newAccount.password !== newAccount.confirmPassword}
                className={`flex-1 px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
                  !newAccount.email || !newAccount.password || !newAccount.confirmPassword || !newAccount.name || newAccount.password.length < 6 || newAccount.password !== newAccount.confirmPassword
                    ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
                    : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
                }`}
              >
                계정 생성
              </button>
            </div>
          </div>
        )}
      </Modal>

      {/* 충전소 삭제 확인 모달 */}
      <Modal 
        isOpen={showDeleteStationModal} 
        onClose={() => { 
          setShowDeleteStationModal(false); 
          setStationToDelete(null); 
        }} 
        title="충전소 삭제 확인" 
        size="sm"
        heightMode="auto"
      >
        {stationToDelete && (
          <div className="space-y-4">
            <div className="bg-red-900/20 border border-red-500/30 rounded-xl p-4">
              <div className="flex items-center">
                <AlertCircle className="w-5 h-5 text-red-300 mr-3 flex-shrink-0" />
                <div>
                  <p className="text-red-200 font-medium">정말로 삭제하시겠습니까?</p>
                  <p className="text-red-300 text-sm mt-1">이 작업은 되돌릴 수 없습니다.</p>
                </div>
              </div>
            </div>
            
            <div className="bg-slate-700/30 rounded-xl p-4 border border-slate-600/30">
              <div className="text-sm text-gray-300">
                <div className="font-medium text-gray-100 mb-2">삭제할 충전소:</div>
                <div className="space-y-1">
                  <div>충전소명: <span className="font-medium">{stationToDelete.name}</span></div>
                  <div>주소: <span className="text-xs">{stationToDelete.address}</span></div>
                  <div>상태: <span className="font-medium">
                    {stationToDelete.status === 'operating' ? '운영 중' : 
                     stationToDelete.status === 'preparing' ? '오픈 예정' : '운영 종료'}
                  </span></div>
                </div>
              </div>
            </div>
            
            <div className="flex space-x-3 pt-2">
              <button 
                onClick={() => { 
                  setShowDeleteStationModal(false); 
                  setStationToDelete(null); 
                }}
                className="flex-1 px-4 py-3 border border-slate-600/50 rounded-xl text-gray-300 hover:bg-slate-700/30 transition-all duration-200 font-medium"
              >
                취소
              </button>
              <button 
                onClick={() => {
                  deleteStation(stationToDelete.name);
                  setShowStationDetailPage(false);
                  setSelectedStationForDetail(null);
                  setIsEditingStationDetail(false);
                  setEditStationData({});
                  setShowDeleteStationModal(false);
                  setStationToDelete(null);
                  showSuccess('충전소가 삭제되었습니다.');
                }}
                className="flex-1 px-4 py-3 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-xl hover:from-red-500 hover:to-red-400 transition-all duration-200 font-medium shadow-lg"
              >
                삭제
              </button>
            </div>
          </div>
        )}
      </Modal>
      {/* 내 정보 모달 */}
      <Modal 
        isOpen={showProfileModal}
        onClose={() => {
          setShowProfileModal(false);
          // 모달 닫을 때만 폼 초기화
          setTimeout(() => {
            setProfilePasswordForm({ currentPassword: '', newPassword: '', confirmPassword: '' });
          }, 300); // 모달 닫힘 애니메이션 후 초기화
        }}
        title="내 정보" 
        size="md" 
        heightMode="fixed"
      >
        <div className="space-y-6">
          {/* 프로필 정보 */}
          <div className="flex items-center justify-between p-4 bg-gradient-to-r from-blue-900/20 to-blue-800/10 rounded-xl border border-blue-500/20">
            <div className="flex items-center space-x-4">
              <div className={RoleUtils.getAvatarClass(currentUser?.role, 'lg')}>
                <User className="w-8 h-8 text-white" />
              </div>
              <div>
                <div className="text-lg font-semibold text-gray-100">
                  {currentUser?.name || '사용자'}
                </div>
                <div className="text-sm text-gray-400 font-mono">
                  {currentUser?.email || 'unknown@email.com'}
                </div>
                <div className={`text-xs mt-1 font-medium ${RoleUtils.getRoleConfig(currentUser?.role).textColor}`}>
                  {RoleUtils.getRoleConfig(currentUser?.role).label}
                </div>
              </div>
            </div>
            <button 
              onClick={() => {
                setIsLoggedIn(false);
                setCurrentUserId(null);
                setCurrentView('login'); // Vercel 배포용: localStorage 사용 중단
                setShowProfileModal(false);
                // storageUtils.remove('is_logged_in'); - localStorage 사용 중단
                // storageUtils.remove('current_user_id'); - localStorage 사용 중단
              }}
              className="px-4 py-2 bg-gradient-to-r from-red-600 to-red-500 text-white rounded-lg hover:from-red-500 hover:to-red-400 transition-all duration-200 font-medium text-sm shadow-lg"
            >
              로그아웃
            </button>
          </div>

          {/* 패스워드 변경 - 별도 컴포넌트 분리 */}
          <div className={CARD_STYLES + " p-4"}>
            <h3 className="text-lg font-semibold text-gray-100 mb-4">패스워드 변경</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">현재 패스워드</label>
                <input 
                  key="current-password" // 고유 key 추가
                  type="password" 
                  value={profilePasswordForm.currentPassword}
                  onChange={(e) => {
                    const newValue = e.target.value;
                    setProfilePasswordForm(prev => ({
                      ...prev,
                      currentPassword: newValue
                    }));
                  }}
                  autoComplete="current-password"
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="현재 패스워드를 입력하세요"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">새 패스워드</label>
                <input 
                  key="new-password" // 고유 key 추가
                  type="password" 
                  value={profilePasswordForm.newPassword}
                  onChange={(e) => {
                    const newValue = e.target.value;
                    setProfilePasswordForm(prev => ({
                      ...prev,
                      newPassword: newValue
                    }));
                  }}
                  autoComplete="new-password"
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="새 패스워드를 입력하세요"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">새 패스워드 확인</label>
                <input 
                  key="confirm-password" // 고유 key 추가
                  type="password" 
                  value={profilePasswordForm.confirmPassword}
                  onChange={(e) => {
                    const newValue = e.target.value;
                    setProfilePasswordForm(prev => ({
                      ...prev,
                      confirmPassword: newValue
                    }));
                  }}
                  autoComplete="new-password"
                  className="w-full px-4 py-3 bg-slate-700/50 border border-slate-600/50 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-gray-100 backdrop-blur-sm" 
                  placeholder="새 패스워드를 다시 입력하세요"
                />
              </div>
            </div>
            
            <div className="mt-6">
              <button 
                onClick={() => {
                  setProfilePasswordForm({ currentPassword: '', newPassword: '', confirmPassword: '' });
                  showSuccess('패스워드가 성공적으로 변경되었습니다.');
                }}
                disabled={!profilePasswordForm.currentPassword || 
                         !profilePasswordForm.newPassword || 
                         !profilePasswordForm.confirmPassword ||
                         profilePasswordForm.newPassword.length < 6 ||
                         profilePasswordForm.newPassword !== profilePasswordForm.confirmPassword}
                className={`w-full px-4 py-3 rounded-xl transition-all duration-200 font-medium shadow-lg ${
                  !profilePasswordForm.currentPassword || 
                  !profilePasswordForm.newPassword || 
                  !profilePasswordForm.confirmPassword ||
                  profilePasswordForm.newPassword.length < 6 ||
                  profilePasswordForm.newPassword !== profilePasswordForm.confirmPassword
                    ? 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-50'
                    : 'bg-gradient-to-r from-blue-600 to-blue-500 text-white hover:from-blue-500 hover:to-blue-400'
                }`}
              >
                패스워드 변경
              </button>
            </div>
          </div>
        </div>
      </Modal>
    </div>
  );
};

export default TaxManagementApp;